<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MUVR ‚Äî Zero Commission. Instant Release. The Real-World Work Game.</title>
  <meta name="description" content="MUVR: A borderless work marketplace. Keep 100%. Use MUVR Credits (MV) ‚Äî platform credits for in-app work flows." />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Adjusted palette (more playful, higher contrast, still premium) */
      --accent: #18F6C8;
      --accent-2: #7C5CFF;
      --accent-3: #FF3D9A;
      --accent-hover: #42FBE0;

      --bg-deep: #050716;
      --bg-card: rgba(14, 18, 34, 0.82);
      --bg-card2: rgba(18, 24, 44, 0.86);
      --border: rgba(255,255,255,0.10);

      --text-dim: rgba(232, 236, 241, 0.52);
      --text-mid: rgba(232, 236, 241, 0.72);
      --text-bright: rgba(232, 236, 241, 0.96);

      --red: #ff6b6b;
      --yellow: #ffd166;

      --shadow: rgba(0,0,0,0.55);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: 'Outfit', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg-deep);
      color: var(--text-bright);
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* ===== Animated Background ===== */
    .bg-stage {
      position: fixed;
      inset: 0;
      z-index: -2;
      overflow: hidden;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(24,246,200,0.14), transparent 60%),
                  radial-gradient(900px 700px at 90% 20%, rgba(124,92,255,0.14), transparent 60%),
                  radial-gradient(900px 700px at 70% 90%, rgba(255,61,154,0.10), transparent 60%),
                  linear-gradient(180deg, #050716, #040515 45%, #050716);
    }
    .blob {
      position: absolute;
      width: 520px; height: 520px;
      filter: blur(38px);
      opacity: 0.28;
      border-radius: 999px;
      transform: translate3d(0,0,0);
      mix-blend-mode: screen;
      animation: floaty 10s ease-in-out infinite;
    }
    .blob.b1 { background: rgba(24,246,200,0.9); left: -140px; top: -180px; animation-duration: 12s; }
    .blob.b2 { background: rgba(124,92,255,0.9); right: -180px; top: -120px; animation-duration: 14s; }
    .blob.b3 { background: rgba(255,61,154,0.8); left: 10%; bottom: -220px; animation-duration: 16s; }
    @keyframes floaty {
      0%,100% { transform: translate3d(0,0,0) scale(1); }
      50% { transform: translate3d(30px,-18px,0) scale(1.06); }
    }

    /* ===== Boot Screen ===== */
    #boot-screen {
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(5, 7, 22, 0.92);
      backdrop-filter: blur(16px);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.45s ease, visibility 0.45s ease;
    }
    #boot-screen.done {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .boot-spinner {
      width: 44px;
      height: 44px;
      border: 3px solid rgba(255,255,255,0.14);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== Page Transitions ===== */
    .fade-up { animation: fadeUpIn 0.5s ease both; }
    .fade-up.d1 { animation-delay: 0.06s; }
    .fade-up.d2 { animation-delay: 0.12s; }
    .fade-up.d3 { animation-delay: 0.18s; }
    .fade-up.d4 { animation-delay: 0.24s; }
    @keyframes fadeUpIn {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== Buttons / Fields ===== */
    .field {
      width: 100%;
      background: rgba(12, 16, 30, 0.88);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 14px;
      color: var(--text-bright);
      transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.08s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }
    .field:focus {
      outline: none;
      border-color: rgba(24,246,200,0.65);
      box-shadow: 0 0 0 6px rgba(24,246,200,0.10), 0 12px 34px rgba(0,0,0,0.22);
    }
    .field::placeholder { color: rgba(232,236,241,0.38); }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), rgba(24,246,200,0.65));
      color: #00110B;
      font-weight: 900;
      border: none;
      border-radius: 14px;
      padding: 14px 18px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      transition: transform 0.12s ease, filter 0.12s ease, box-shadow 0.12s ease;
      box-shadow: 0 14px 40px rgba(24,246,200,0.14);
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }
    .btn-primary:hover { filter: brightness(1.06); transform: translateY(-1px); }
    .btn-primary:active { transform: translateY(0) scale(0.99); }
    .btn-primary:disabled { background: rgba(255,255,255,0.08); color: rgba(232,236,241,0.45); cursor: not-allowed; box-shadow: none; }

    .btn-secondary {
      background: rgba(255,255,255,0.06);
      color: var(--text-bright);
      font-weight: 800;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 18px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      transition: transform 0.12s ease, background 0.12s ease, border-color 0.12s ease;
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.09); border-color: rgba(255,255,255,0.16); transform: translateY(-1px); }
    .btn-secondary:active { transform: translateY(0); }

    .btn-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 900;
      cursor: pointer;
      border: none;
      transition: transform 0.12s ease, background 0.12s ease, border-color 0.12s ease, filter 0.12s ease;
      letter-spacing: 0.2px;
      white-space: nowrap;
      text-transform: uppercase;
    }
    .btn-pill-accent { background: rgba(24,246,200,0.92); color: #00110B; box-shadow: 0 14px 40px rgba(24,246,200,0.10); }
    .btn-pill-accent:hover { filter: brightness(1.06); transform: translateY(-1px); }
    .btn-pill-ghost { background: rgba(255,255,255,0.06); color: rgba(232,236,241,0.75); border: 1px solid rgba(255,255,255,0.10); }
    .btn-pill-ghost:hover { background: rgba(255,255,255,0.09); border-color: rgba(255,255,255,0.16); transform: translateY(-1px); }
    .btn-pill-ghost.active { background: rgba(24,246,200,0.92); color: #00110B; border-color: rgba(24,246,200,0.92); }

    /* ===== Cards ===== */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.18);
      backdrop-filter: blur(12px);
    }
    .card-interactive { transition: transform 0.18s ease, border-color 0.18s ease, filter 0.18s ease; }
    .card-interactive:hover { border-color: rgba(24,246,200,0.35); transform: translateY(-2px); filter: brightness(1.02); }

    /* ===== Modal ===== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      z-index: 200;
      background: rgba(4, 6, 14, 0.80);
      backdrop-filter: blur(16px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.25s ease, visibility 0.25s ease;
    }
    .modal-overlay.open { opacity: 1; visibility: visible; }
    .modal-overlay .modal-body { transform: translateY(14px) scale(0.97); transition: transform 0.25s ease; }
    .modal-overlay.open .modal-body { transform: translateY(0) scale(1); }

    .close-btn {
      color: rgba(232,236,241,0.55);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 22px;
      line-height: 1;
      transition: color 0.15s ease, transform 0.15s ease;
    }
    .close-btn:hover { color: rgba(232,236,241,0.95); transform: rotate(6deg); }

    /* ===== Toast ===== */
    #toast-container {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    .toast {
      padding: 14px 18px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 800;
      animation: toastSlide 0.28s ease;
      max-width: 360px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      pointer-events: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.24);
    }
    .toast-success { background: rgba(6, 95, 70, 0.90); color: #9ff7d5; }
    .toast-error { background: rgba(127, 29, 29, 0.90); color: #ffd2d2; }
    .toast-info { background: rgba(20, 40, 70, 0.90); color: #c9ddff; }
    @keyframes toastSlide {
      from { transform: translateX(16px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* ===== Ticker ===== */
    .ticker-scroll { animation: tickerMove 22s linear infinite; }
    @keyframes tickerMove { to { transform: translateX(-50%); } }
    .mono { font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    /* ===== Helpers ===== */
    .hero-gradient {
      background: linear-gradient(135deg, var(--accent), var(--accent-2), var(--accent-3));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* ===== MUXI Assistant ===== */
    #muxi {
      position: fixed;
      right: 16px;
      bottom: 88px;
      z-index: 9998;
      width: 88px;
      height: 88px;
      border-radius: 22px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(14px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.26);
      display: grid;
      place-items: center;
      cursor: pointer;
      user-select: none;
      transform: translate3d(0,0,0);
      transition: transform 0.16s ease, filter 0.16s ease, border-color 0.16s ease;
      animation: muxiFloat 4.2s ease-in-out infinite;
    }
    #muxi:hover { transform: translateY(-2px) scale(1.02); border-color: rgba(24,246,200,0.35); filter: brightness(1.04); }
    @keyframes muxiFloat {
      0%,100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    #muxi-bubble {
      position: fixed;
      right: 16px;
      bottom: 182px;
      z-index: 9998;
      max-width: 280px;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(14, 18, 34, 0.88);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(14px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.30);
      display: none;
    }
    #muxi-bubble.show { display: block; animation: fadeUpIn 0.28s ease both; }
    #muxi-bubble .t { font-weight: 900; font-size: 12px; letter-spacing: 0.2px; }
    #muxi-bubble .m { margin-top: 6px; font-weight: 600; font-size: 12px; color: rgba(232,236,241,0.74); line-height: 1.3; }
    #muxi-bubble .cta { margin-top: 10px; display: flex; gap: 8px; }
    #muxi-bubble .mini {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      color: rgba(232,236,241,0.9);
      font-weight: 900;
      font-size: 11px;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.12s ease, background 0.12s ease;
    }
    #muxi-bubble .mini:hover { transform: translateY(-1px); background: rgba(255,255,255,0.10); }

    /* Mobile spacing */
    @media (max-width: 640px) {
      #muxi { bottom: 94px; width: 84px; height: 84px; }
      #muxi-bubble { bottom: 184px; right: 12px; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.16); border-radius: 3px; }
  </style>
</head>

<body>
  <div class="bg-stage" aria-hidden="true">
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div class="blob b3"></div>
  </div>

  <!-- Boot Screen -->
  <div id="boot-screen">
    <div style="text-align:center">
      <div class="boot-spinner" style="margin:0 auto 14px"></div>
      <div style="font-size:20px;font-weight:900;letter-spacing:-0.4px;color:var(--text-bright)">
        <span style="color:var(--accent)">M</span>U<span style="color:var(--accent)">V</span>R
      </div>
      <div style="margin-top:10px;font-size:11px;font-weight:800;color:rgba(232,236,241,0.60);letter-spacing:0.24px;text-transform:uppercase">
        Loading the network‚Ä¶
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast-container"></div>

  <!-- App Root -->
  <div id="root"></div>

  <!-- Modals -->
  <div id="modal-layer"></div>

  <!-- MUXI Assistant -->
  <div id="muxi" title="MUXI ‚Äî your chaotic helper">
    <!-- Simple ‚Äúsketchy donkey‚Äù SVG (no external assets) -->
    <svg width="52" height="52" viewBox="0 0 64 64" fill="none" aria-hidden="true">
      <path d="M18 20 L12 10 L22 14" stroke="rgba(232,236,241,0.92)" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M46 20 L52 10 L42 14" stroke="rgba(232,236,241,0.92)" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M18 20 C18 14, 46 14, 46 20" stroke="rgba(232,236,241,0.92)" stroke-width="2.4" stroke-linecap="round"/>
      <path d="M16 22 C14 34, 18 48, 32 50 C46 48, 50 34, 48 22" stroke="rgba(232,236,241,0.92)" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M24 34 C24 34, 24 34, 24 34" stroke="rgba(24,246,200,0.95)" stroke-width="6" stroke-linecap="round"/>
      <path d="M40 34 C40 34, 40 34, 40 34" stroke="rgba(24,246,200,0.95)" stroke-width="6" stroke-linecap="round"/>
      <path d="M30 40 C32 42, 34 42, 36 40" stroke="rgba(232,236,241,0.92)" stroke-width="2.4" stroke-linecap="round"/>
      <path d="M28 44 C30 46, 34 46, 36 44" stroke="rgba(232,236,241,0.62)" stroke-width="2.4" stroke-linecap="round"/>
      <path d="M20 30 C22 26, 26 26, 28 30" stroke="rgba(232,236,241,0.35)" stroke-width="2" stroke-linecap="round"/>
      <path d="M36 30 C38 26, 42 26, 44 30" stroke="rgba(232,236,241,0.35)" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </div>
  <div id="muxi-bubble">
    <div class="t">MUXI</div>
    <div class="m" id="muxi-msg">I keep the app from face-planting. Tap me if something feels weird.</div>
    <div class="cta">
      <button class="mini" id="muxi-action-1">Diagnose</button>
      <button class="mini" id="muxi-action-2">Quick Tips</button>
    </div>
  </div>

<script>
/* =============================================================================
   SUPABASE CONFIG
============================================================================= */
const SUPA_URL = 'https://cfenkstusggrcthehffn.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmZW5rc3R1c2dncmN0aGVoZmZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMTIyNTMsImV4cCI6MjA4NzU4ODI1M30.XcZKrytjAnju05w_7ly7j4bsnwLK08kBoXAhi3xYV5o';

let sb = null;
try {
  sb = supabase.createClient(SUPA_URL, SUPA_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });
} catch (e) {
  console.error('Failed to create Supabase client:', e);
}

/* =============================================================================
   STATE
============================================================================= */
let state = {
  user: null,
  token: null,
  profile: null,
  jobs: [],
  jobFilter: 'all',
  balanceVisible: false,
  currentTab: 'jobs',
  mode: 'online',     // 'online' | 'offline'
  muxiMood: 'idle'    // idle | loading | success | error
};

/* =============================================================================
   DOM HELPERS
============================================================================= */
const getEl = (id) => document.getElementById(id);

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = (str ?? '').toString();
  return div.innerHTML;
}

function withTimeout(promise, ms, label) {
  let t;
  const timeout = new Promise((_, reject) => {
    t = setTimeout(() => reject(new Error('timeout:' + (label || 'op'))), ms);
  });
  return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
}

/* =============================================================================
   TOAST
============================================================================= */
function showToast(message, type = 'success') {
  const container = getEl('toast-container');
  if (!container) return;
  const toast = document.createElement('div');
  toast.className = 'toast toast-' + type;
  toast.textContent = message;
  container.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.25s ease';
    setTimeout(() => toast.remove(), 260);
  }, 3200);
}

/* =============================================================================
   MUXI
============================================================================= */
function setMuxi(mood, msg) {
  state.muxiMood = mood || state.muxiMood;
  const bubble = getEl('muxi-bubble');
  const m = getEl('muxi-msg');
  if (msg && m) m.textContent = msg;

  // subtle mood-based toasts
  if (mood === 'error') {
    // no spam; only toast on major errors
  }
  // show bubble briefly
  if (bubble) {
    bubble.classList.add('show');
    clearTimeout(window.__muxiHideTimer);
    window.__muxiHideTimer = setTimeout(() => bubble.classList.remove('show'), 4200);
  }
}

(function initMuxiUI(){
  const muxi = getEl('muxi');
  const bubble = getEl('muxi-bubble');
  const b1 = getEl('muxi-action-1');
  const b2 = getEl('muxi-action-2');

  if (muxi) {
    muxi.addEventListener('click', () => {
      if (bubble) bubble.classList.toggle('show');
      setMuxi('idle', pickMuxiLine());
    });
  }

  if (b1) b1.addEventListener('click', () => {
    const hints = getQuickDiagnostics();
    setMuxi('idle', hints);
  });
  if (b2) b2.addEventListener('click', () => {
    setMuxi('idle', "Try: Sign in ‚Üí Post a gig ‚Üí Apply ‚Üí Watch realtime updates. If anything stalls, I‚Äôll fall back safely.");
  });
})();

function pickMuxiLine() {
  const lines = [
    "Welcome to the real-world work game. Want the fastest path to a payout? Finish your profile.",
    "If the network lags, I‚Äôll keep the UI alive. No black screens on my watch.",
    "Pro tip: Post a gig with a clear title + budget. You‚Äôll get better applications.",
    "Keep it clean: your profile handle should be unique and simple.",
    "If you see weirdness, it‚Äôs usually RLS or a missing row. I can sniff it out."
  ];
  return lines[Math.floor(Math.random() * lines.length)];
}

function getQuickDiagnostics() {
  const online = navigator.onLine ? "online" : "offline";
  const sbOk = (typeof supabase !== 'undefined' && sb) ? "ok" : "missing";
  const token = state.token ? "present" : "none";
  const user = state.user ? "yes" : "no";
  return `Diag: net=${online}, supabase=${sbOk}, user=${user}, token=${token}. If supabase is missing, check CDN + adblock. If user=yes but token=none, session refresh failed.`;
}

/* =============================================================================
   AUTHENTICATED REST REQUEST
============================================================================= */
async function apiRequest(path, options = {}) {
  if (!sb) return null;

  try {
    if (!state.token) {
      const session = await sb.auth.getSession();
      state.token = session.data.session?.access_token || null;
    }
    if (!state.token) return null;

    const headers = {
      'apikey': SUPA_KEY,
      'Authorization': 'Bearer ' + state.token,
      ...(options.headers || {})
    };

    const res = await fetch(SUPA_URL + '/rest/v1/' + path, { ...options, headers });
    return res;
  } catch (err) {
    console.error('apiRequest failed:', err);
    return null;
  }
}

/* =============================================================================
   MODALS
============================================================================= */
function openModal(contentHtml, options = {}) {
  const layer = getEl('modal-layer');
  if (!layer) return;
  const widthClass = options.width || 'max-w-sm';

  layer.innerHTML = `
    <div class="modal-overlay" id="active-modal">
      <div class="modal-body w-full ${widthClass} mx-auto">
        ${contentHtml}
      </div>
    </div>
  `;

  requestAnimationFrame(() => {
    const modal = getEl('active-modal');
    if (modal) modal.classList.add('open');
  });

  if (!options.locked) {
    const modal = getEl('active-modal');
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
    }
  }
}

function closeModal() {
  const modal = getEl('active-modal');
  if (!modal) return;
  modal.classList.remove('open');
  setTimeout(() => {
    const layer = getEl('modal-layer');
    if (layer) layer.innerHTML = '';
  }, 260);
}

/* =============================================================================
   RENDER: LANDING
============================================================================= */
function brandMarkHTML(size = 'text-5xl') {
  // M and V same color (requested)
  return `
    <div class="inline-flex items-center gap-3">
      <div class="relative">
        <div class="absolute -inset-2 blur-2xl opacity-40" style="background: radial-gradient(circle at 30% 30%, rgba(24,246,200,0.6), transparent 60%), radial-gradient(circle at 70% 50%, rgba(124,92,255,0.4), transparent 60%);"></div>
        <div class="${size} font-black tracking-tight relative">
          <span style="color:var(--accent)">M</span>U<span style="color:var(--accent)">V</span>R
        </div>
      </div>
      <span class="text-[10px] font-black px-3 py-1 rounded-full" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.10); color: rgba(232,236,241,0.85); letter-spacing:0.22px;">
        WORK GAME
      </span>
    </div>
  `;
}

function renderLanding() {
  const root = getEl('root');
  if (!root) return;

  root.innerHTML = `
    <div class="fade-up">
      <div style="background: rgba(180, 30, 30, 0.82)" class="text-center py-2 text-[10px] font-black tracking-widest">
        MUVR IS A MARKETPLACE ONLY ‚Äî NOT AN EMPLOYER ‚Äî ALL WORKERS ARE INDEPENDENT CONTRACTORS
      </div>

      <section class="max-w-5xl mx-auto px-5 pt-14 sm:pt-20 pb-10 text-center">
        <div class="fade-up d1 flex items-center justify-center mb-6">
          ${brandMarkHTML('text-5xl sm:text-6xl')}
        </div>

        <div class="fade-up d2 text-4xl sm:text-6xl font-black leading-[1.02] mb-5">
          Work. Earn. <span class="hero-gradient">Level Up.</span>
        </div>

        <p class="fade-up d3 text-base sm:text-lg max-w-2xl mx-auto mb-8" style="color: var(--text-mid)">
          A borderless on-demand marketplace for real-world labor + digital work.
          Keep 100% of what you earn. Use <strong>MUVR Credits (MV)</strong> ‚Äî in-platform credits for escrowed work flows.
        </p>

        <div class="fade-up d4 flex flex-col sm:flex-row gap-3 justify-center max-w-lg mx-auto">
          <button onclick="openAuthModal()" class="btn-primary text-base py-4 rounded-full">
            ENTER THE NETWORK
          </button>
          <button onclick="document.getElementById('why-section').scrollIntoView({behavior:'smooth'})"
                  class="btn-secondary text-base py-4 rounded-full">
            WHY MUVR
          </button>
        </div>

        <div class="fade-up d4 mt-6 flex items-center justify-center gap-2 text-[11px] font-bold"
             style="color: rgba(232,236,241,0.62)">
          <span class="mono px-2 py-1 rounded-full" style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10)">0% commission</span>
          <span class="mono px-2 py-1 rounded-full" style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10)">escrow protection</span>
          <span class="mono px-2 py-1 rounded-full" style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10)">realtime updates</span>
        </div>
      </section>

      <section class="max-w-6xl mx-auto px-5 py-10 grid grid-cols-1 md:grid-cols-3 gap-5">
        <div class="card card-interactive p-7 text-left">
          <div class="text-3xl mb-3">üéÆ</div>
          <p class="font-black text-lg mb-1">The Real-World Work Game</p>
          <p class="text-sm" style="color: var(--text-dim)">
            Earn XP, build rank, unlock status. Work is the quest. Reputation is the scoreboard.
          </p>
        </div>
        <div class="card card-interactive p-7 text-left">
          <div class="text-3xl mb-3">üß≤</div>
          <p class="font-black text-lg mb-1">Keep 100%</p>
          <p class="text-sm" style="color: var(--text-dim)">
            No commission on worker earnings. The platform is built to minimize extraction.
          </p>
        </div>
        <div class="card card-interactive p-7 text-left">
          <div class="text-3xl mb-3">üîí</div>
          <p class="font-black text-lg mb-1">Escrow-first</p>
          <p class="text-sm" style="color: var(--text-dim)">
            Funds are locked before work begins and released when complete (with dispute controls).
          </p>
        </div>
      </section>

      <section id="why-section" class="max-w-4xl mx-auto px-5 py-14">
        <div class="card p-6 sm:p-8">
          <h2 class="text-2xl sm:text-3xl font-black mb-2">Why Workers Choose MUVR</h2>
          <p class="text-sm mb-6" style="color: var(--text-mid)">
            Designed for speed, fairness, and a fun ‚Äúlevel up‚Äù economy ‚Äî without calling MV a currency.
          </p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-4 rounded-2xl" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.10)">
              <div class="font-black mb-1">MUVR Credits (MV)</div>
              <div class="text-sm" style="color: var(--text-dim)">
                In-platform credits used for posting, escrow, transfers, and settlement flows.
                <span style="color: rgba(232,236,241,0.82); font-weight:800;">Not currency.</span>
              </div>
            </div>
            <div class="p-4 rounded-2xl" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.10)">
              <div class="font-black mb-1">Faster release</div>
              <div class="text-sm" style="color: var(--text-dim)">
                When the job is marked complete, escrow release updates in realtime (network dependent).
              </div>
            </div>
          </div>

          <div class="mt-6 p-4 rounded-2xl" style="background: rgba(24,246,200,0.08); border: 1px solid rgba(24,246,200,0.18)">
            <div class="text-[11px] font-black tracking-widest" style="color: rgba(232,236,241,0.70)">LEGAL NOTE</div>
            <div class="text-sm mt-2" style="color: rgba(232,236,241,0.78); line-height:1.35">
              <strong>MUVR Credits (MV)</strong> are platform-limited digital credits used solely within MUVR for marketplace features.
              They are not currency, cryptocurrency, or financial instruments.
            </div>
          </div>
        </div>
      </section>

      <section class="max-w-5xl mx-auto px-5 pb-16">
        <div class="card p-6 sm:p-8">
          <h3 class="text-xl font-black mb-3">How it works (simple)</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            ${howStep("üìù", "Post or Apply", "Create a gig or apply instantly.")}
            ${howStep("üîí", "Escrow Locks", "Budget locks before work begins.")}
            ${howStep("‚úÖ", "Work Complete", "Mark complete; release triggers.")}
            ${howStep("üèÅ", "Level Up", "Earn XP, rank up, get picked faster.")}
          </div>
        </div>
      </section>

      <footer class="py-10 text-center text-xs" style="color: rgba(232,236,241,0.52)">
        <div class="max-w-4xl mx-auto px-5">
          <div class="mb-2 font-bold" style="color: rgba(232,236,241,0.70)">MUVR is operated by TransBid LLC (Delaware, USA)</div>
          <div class="mb-4">
            MUVR Credits (MV) are platform-limited digital credits used solely within MUVR. Not currency, cryptocurrency, or financial instruments.
          </div>
          <div style="color: rgba(232,236,241,0.38)">&copy; 2026 TransBid LLC. All rights reserved.</div>
        </div>
      </footer>
    </div>
  `;
}

function howStep(icon, title, desc) {
  return `
    <div class="p-4 rounded-2xl text-left" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.10)">
      <div class="text-2xl mb-2">${icon}</div>
      <div class="font-black">${title}</div>
      <div class="text-xs mt-1" style="color: var(--text-dim)">${desc}</div>
    </div>
  `;
}

/* =============================================================================
   RENDER: APP SHELL
============================================================================= */
function renderApp() {
  const root = getEl('root');
  if (!root) return;

  root.innerHTML = `
    <div class="fade-up">
      <div style="background: rgba(180, 30, 30, 0.82)" class="text-center py-2 text-[10px] font-black tracking-widest">
        MUVR IS A MARKETPLACE ONLY ‚Äî NOT AN EMPLOYER ‚Äî ALL WORKERS ARE INDEPENDENT CONTRACTORS
      </div>

      <header class="sticky top-0 z-50" style="border-bottom: 1px solid rgba(255,255,255,0.10); background: rgba(10, 12, 26, 0.72); backdrop-filter: blur(16px)">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <div class="flex items-center gap-3 cursor-pointer" onclick="switchTab('jobs')">
            <div class="w-9 h-9 rounded-2xl grid place-items-center"
                 style="background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10)">
              <span style="font-weight:900;color:var(--accent)">M</span>
            </div>
            <div>
              <div class="text-lg font-black tracking-tight">
                <span style="color:var(--accent)">M</span>U<span style="color:var(--accent)">V</span>R
              </div>
              <div class="text-[10px] font-bold" style="color: rgba(232,236,241,0.55); letter-spacing:0.22px; text-transform:uppercase">
                The real-world work game
              </div>
            </div>
          </div>

          <nav class="hidden sm:flex gap-6">
            <button onclick="switchTab('jobs')" class="desktop-tab active" data-tab="jobs">GIGS</button>
            <button onclick="switchTab('wallet')" class="desktop-tab" data-tab="wallet">CREDITS</button>
            <button onclick="switchTab('profile')" class="desktop-tab" data-tab="profile">ME</button>
          </nav>

          <button onclick="handleLogout()" class="text-xs font-black cursor-pointer"
                  style="color: rgba(232,236,241,0.62); background: none; border: none; text-transform:uppercase; letter-spacing:0.2px">
            Sign out
          </button>
        </div>

        <div class="py-1 overflow-hidden" style="background: rgba(0,0,0,0.55); border-top: 1px solid rgba(255,255,255,0.06)">
          <div class="ticker-scroll whitespace-nowrap flex gap-8 text-[10px] mono tracking-wider"
               style="color: rgba(24,246,200,0.95)">
            <span>‚ö° 0% COMMISSION ‚Ä¢ MUVR CREDITS (MV) ‚Ä¢ ESCROW-FIRST ‚Ä¢ REALTIME UPDATES ‚Ä¢ LEVEL UP WITH XP ‚ö°</span>
            <span>‚ö° 0% COMMISSION ‚Ä¢ MUVR CREDITS (MV) ‚Ä¢ ESCROW-FIRST ‚Ä¢ REALTIME UPDATES ‚Ä¢ LEVEL UP WITH XP ‚ö°</span>
          </div>
        </div>
      </header>

      <main class="max-w-6xl mx-auto px-4 py-6 pb-28 sm:pb-8">
        <div id="tab-content"></div>
      </main>

      <div class="sm:hidden fixed bottom-0 left-0 right-0 z-50"
           style="background: rgba(10, 12, 26, 0.82); border-top: 1px solid rgba(255,255,255,0.10); backdrop-filter: blur(16px)">
        <div class="flex justify-around py-3">
          <button onclick="switchTab('jobs')" class="mobile-tab active" data-tab="jobs">
            <i class="fas fa-briefcase text-base"></i>Gigs
          </button>
          <button onclick="switchTab('wallet')" class="mobile-tab" data-tab="wallet">
            <i class="fas fa-coins text-base"></i>MV
          </button>
          <button onclick="switchTab('profile')" class="mobile-tab" data-tab="profile">
            <i class="fas fa-user text-base"></i>Me
          </button>
        </div>
      </div>
    </div>
  `;

  switchTab('jobs');
}

function switchTab(tabName) {
  state.currentTab = tabName;

  document.querySelectorAll('.desktop-tab').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.mobile-tab').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('[data-tab="' + tabName + '"]').forEach(btn => btn.classList.add('active'));

  if (tabName === 'jobs') renderJobsTab();
  else if (tabName === 'wallet') { renderWalletTab(); loadWalletData(); }
  else if (tabName === 'profile') renderProfileTab();
}

/* =============================================================================
   JOBS TAB
============================================================================= */
function renderJobsTab() {
  const content = getEl('tab-content');
  if (!content) return;

  const filteredJobs = (state.jobFilter === 'all')
    ? state.jobs
    : state.jobs.filter(j => j.job_type === state.jobFilter);

  const categories = [
    { key: 'all', label: 'All' },
    { key: 'rideshare', label: 'Rideshare' },
    { key: 'delivery', label: 'Delivery' },
    { key: 'physical', label: 'Labor' },
    { key: 'digital', label: 'Digital' }
  ];

  const filterButtons = categories.map(cat => `
    <button onclick="state.jobFilter='${cat.key}'; renderJobsTab()"
            class="btn-pill ${state.jobFilter === cat.key ? 'btn-pill-accent' : 'btn-pill-ghost'}">
      ${cat.label}
    </button>
  `).join('');

  const jobCards = filteredJobs.length === 0
    ? `
      <div class="col-span-full text-center py-16" style="color: rgba(232,236,241,0.55)">
        <p class="text-4xl mb-2">ü´è</p>
        <p class="font-black">No gigs here yet</p>
        <p class="text-sm mt-1" style="color: rgba(232,236,241,0.52)">Muxi says: be the first to post one.</p>
        <div class="mt-6 max-w-sm mx-auto">
          <button onclick="openPostJobModal()" class="btn-primary rounded-full">Post a gig</button>
        </div>
      </div>
    `
    : filteredJobs.map(job => `
      <div class="card card-interactive p-5">
        <div class="flex items-start justify-between mb-2">
          <h3 class="font-black text-sm">${escapeHtml(job.title)}</h3>
          <span class="text-[10px] px-2 py-1 rounded-full font-black"
                style="background: rgba(255,255,255,0.06); color: rgba(232,236,241,0.65); border: 1px solid rgba(255,255,255,0.10)">
            ${escapeHtml(job.job_type || '')}
          </span>
        </div>
        <p class="text-xs line-clamp-2 mb-4" style="color: rgba(232,236,241,0.56)">
          ${escapeHtml(job.description || '')}
        </p>
        <div class="flex items-end justify-between">
          <div>
            <p class="text-[10px] font-black" style="color: rgba(232,236,241,0.45); letter-spacing:0.18px; text-transform:uppercase">Budget</p>
            <p class="text-lg font-black mono" style="color: var(--accent)">${Number(job.budget_mv || 0)} MV</p>
          </div>
          <button onclick="openApplyModal('${job.id}')" class="btn-pill btn-pill-accent">
            Apply
          </button>
        </div>
      </div>
    `).join('');

  content.innerHTML = `
    <div class="fade-up">
      <div class="mb-6 flex items-start justify-between gap-3">
        <div>
          <h1 class="text-3xl sm:text-4xl font-black mb-1">Available Gigs</h1>
          <p class="text-sm" style="color: rgba(232,236,241,0.65)">Find work. Keep 100%. Level up.</p>
        </div>

        <div class="hidden sm:block">
          <button onclick="openPostJobModal()" class="btn-pill btn-pill-accent">+ Post a gig</button>
        </div>
      </div>

      <div class="flex gap-2 mb-5 overflow-x-auto pb-1">
        ${filterButtons}
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        ${jobCards}
      </div>

      <div class="sm:hidden mt-5">
        <button onclick="openPostJobModal()" class="btn-primary rounded-full">Post a gig</button>
      </div>
    </div>
  `;
}

/* =============================================================================
   WALLET TAB
============================================================================= */
function renderWalletTab() {
  const content = getEl('tab-content');
  if (!content) return;

  const balance = state.profile?.mv_balance || 0;

  content.innerHTML = `
    <div class="fade-up">
      <h1 class="text-3xl font-black mb-2">MUVR Credits</h1>
      <p class="text-sm mb-6" style="color: rgba(232,236,241,0.62)">
        MV are in-platform credits used for escrow and marketplace flows. Not currency.
      </p>

      <div class="card p-5 mb-5"
           style="border-color: rgba(24,246,200,0.14); background: linear-gradient(135deg, rgba(24,246,200,0.08), rgba(124,92,255,0.06), rgba(255,61,154,0.04))">
        <p class="text-[10px] tracking-widest font-black mb-3" style="color: rgba(232,236,241,0.55)">NETWORK STATUS</p>
        <div class="grid grid-cols-4 gap-3 text-center">
          <div>
            <p class="text-[10px] font-black" style="color: rgba(232,236,241,0.45)">CAP</p>
            <p class="text-xl font-black mono" style="color: var(--accent)">100M</p>
          </div>
          <div>
            <p class="text-[10px] font-black" style="color: rgba(232,236,241,0.45)">MINTED</p>
            <p class="text-xl font-black mono" style="color: var(--accent)" id="stat-minted">‚Äî</p>
          </div>
          <div>
            <p class="text-[10px] font-black" style="color: rgba(232,236,241,0.45)">ESCROWED</p>
            <p class="text-xl font-black mono" style="color: var(--yellow)" id="stat-escrowed">‚Äî</p>
          </div>
          <div>
            <p class="text-[10px] font-black" style="color: rgba(232,236,241,0.45)">BURNED</p>
            <p class="text-xl font-black mono" style="color: var(--red)" id="stat-burned">‚Äî</p>
          </div>
        </div>
      </div>

      <div class="card p-5 max-w-md mb-6">
        <p class="text-[10px] tracking-widest font-black mb-2" style="color: rgba(232,236,241,0.55)">YOUR BALANCE</p>
        <div class="flex items-end justify-between mb-5">
          <p class="text-4xl font-black mono" style="color: var(--accent)" id="balance-display">
            ${state.balanceVisible ? (balance + ' MV') : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
          </p>
          <button onclick="toggleBalance()" class="text-xs font-black cursor-pointer"
                  style="color: rgba(232,236,241,0.55); background: none; border: none; text-transform:uppercase">
            ${state.balanceVisible ? 'Hide' : 'Show'}
          </button>
        </div>

        <div class="grid grid-cols-3 gap-3">
          <button onclick="openSendModal()" class="btn-pill btn-pill-ghost w-full justify-center">Send</button>
          <button onclick="openLoadModal()" class="btn-pill btn-pill-accent w-full justify-center">Load</button>
          <button onclick="openCashoutModal()" class="btn-pill btn-pill-ghost w-full justify-center">Payout</button>
        </div>

        <div class="mt-4 text-[11px]" style="color: rgba(232,236,241,0.50)">
          Note: ‚ÄúPayout‚Äù is a partner-integrated feature (beta). MUXI will keep you safe if it‚Äôs not enabled yet.
        </div>
      </div>

      <h2 class="font-black mb-3">Ledger (recent)</h2>
      <div id="ledger-list">
        <p class="text-sm py-4" style="color: rgba(232,236,241,0.55)">Loading‚Ä¶</p>
      </div>
    </div>
  `;
}

function toggleBalance() {
  state.balanceVisible = !state.balanceVisible;
  if (state.currentTab === 'wallet') {
    renderWalletTab();
    loadWalletData();
  }
}

async function loadWalletData() {
  if (!state.user) return;

  try {
    const balRes = await apiRequest('users?id=eq.' + state.user.id + '&select=mv_balance');
    if (balRes && balRes.ok) {
      const data = await balRes.json();
      if (data && data.length) state.profile = { ...(state.profile || {}), mv_balance: data[0].mv_balance };
    }
  } catch (e) {
    console.error('balance load error', e);
  }

  const balDisplay = getEl('balance-display');
  if (balDisplay) {
    balDisplay.textContent = state.balanceVisible ? ((state.profile?.mv_balance || 0) + ' MV') : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  }

  // ledger
  const ledgerEl = getEl('ledger-list');
  try {
    const ledgerRes = await apiRequest('mv_ledger?user_id=eq.' + state.user.id + '&order=created_at.desc&limit=20');
    const ledger = (ledgerRes && ledgerRes.ok) ? await ledgerRes.json() : [];
    if (!ledgerEl) return;

    if (!ledger || ledger.length === 0) {
      ledgerEl.innerHTML = '<p class="text-sm py-4" style="color: rgba(232,236,241,0.55)">No transactions yet</p>';
      return;
    }

    const typeIcons = { load:'üì•', send:'üì§', receive:'üì®', burn:'üî•', withdrawal:'üè¶' };

    ledgerEl.innerHTML = ledger.map(entry => {
      const isNegative = ['burn','send','withdrawal'].includes(entry.type);
      const icon = typeIcons[entry.type] || 'üìä';
      const color = isNegative ? 'var(--red)' : 'var(--accent)';
      const sign = isNegative ? '-' : '+';
      const when = entry.created_at ? new Date(entry.created_at) : null;

      return `
        <div class="card p-3 mb-2 flex justify-between items-start" style="border-left: 2px solid rgba(24,246,200,0.65)">
          <div class="flex items-start gap-3">
            <span class="text-base">${icon}</span>
            <div>
              <p class="font-black text-xs capitalize">${escapeHtml(entry.type || '')}</p>
              <p class="text-[11px]" style="color: rgba(232,236,241,0.55)">${escapeHtml(entry.description || '')}</p>
              <p class="text-[10px] mt-1" style="color: rgba(232,236,241,0.38)">
                ${when ? when.toLocaleString() : ''}
              </p>
            </div>
          </div>
          <p class="mono font-black text-xs whitespace-nowrap ml-2" style="color: ${color}">
            ${sign}${Number(entry.amount_mv || 0)} MV
          </p>
        </div>
      `;
    }).join('');
  } catch (e) {
    console.error('ledger load error', e);
    if (ledgerEl) ledgerEl.innerHTML = '<p class="text-sm py-4" style="color: rgba(232,236,241,0.55)">Ledger unavailable right now.</p>';
  }

  // Optional network stats (best-effort; do not block)
  // If you later add tables/metrics for minted/escrowed/burned totals, set them here.
  const minted = getEl('stat-minted');
  const escrowed = getEl('stat-escrowed');
  const burned = getEl('stat-burned');
  if (minted) minted.textContent = '‚Äî';
  if (escrowed) escrowed.textContent = '‚Äî';
  if (burned) burned.textContent = '‚Äî';
}

/* =============================================================================
   PROFILE TAB
============================================================================= */
function calcLevel(prof) {
  const completed = Number(prof?.jobs_completed || 0);
  const xp = completed * 120 + (prof?.full_name ? 40 : 0) + (prof?.about_me ? 40 : 0) + (prof?.username ? 30 : 0);
  const level = Math.max(1, Math.floor(xp / 200) + 1);
  const titles = ["Runner","Carrier","Operator","Elite Operator","Legend","Mythic"];
  const title = titles[Math.min(titles.length - 1, Math.floor((level - 1) / 2))];
  const next = level * 200;
  const pct = Math.min(1, xp / next);
  return { xp, level, title, next, pct };
}

function renderProfileTab() {
  const content = getEl('tab-content');
  if (!content) return;

  const prof = state.profile || {};
  const rating = Number(prof.rating || 0);
  const stars = '‚≠ê'.repeat(Math.floor(rating)) + (rating % 1 > 0 ? '‚ú®' : '');
  const lvl = calcLevel(prof);

  content.innerHTML = `
    <div class="fade-up">
      <h1 class="text-3xl font-black mb-2">Your Profile</h1>
      <p class="text-sm mb-6" style="color: rgba(232,236,241,0.62)">
        Level up to get picked faster. MUXI loves complete profiles.
      </p>

      <div class="card p-5 max-w-2xl">
        <div class="flex items-start justify-between gap-4 mb-5" style="border-bottom: 1px solid rgba(255,255,255,0.10); padding-bottom: 16px">
          <div>
            <h2 class="text-2xl font-black mb-1">${escapeHtml(prof.full_name || 'No Name Set')}</h2>
            <p class="text-sm font-bold" style="color: rgba(232,236,241,0.55)">@${escapeHtml(prof.username || 'no_handle')}</p>
            <p class="text-xs mt-3" style="color: rgba(232,236,241,0.55)">${escapeHtml(prof.about_me || 'No bio yet ‚Äî add one to level up.')}</p>
          </div>

          <div class="text-right">
            <div class="text-[10px] font-black tracking-widest" style="color: rgba(232,236,241,0.55)">RANK</div>
            <div class="text-xl font-black hero-gradient">${escapeHtml(lvl.title)}</div>
            <div class="text-[11px] font-black mt-1" style="color: rgba(232,236,241,0.65)">Level ${lvl.level}</div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-4 text-center mb-5">
          <div class="p-3 rounded-2xl" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.10)">
            <p class="text-[10px] font-black tracking-widest" style="color: rgba(232,236,241,0.55)">COMPLETED</p>
            <p class="text-xl font-black">${Number(prof.jobs_completed || 0)}</p>
          </div>
          <div class="p-3 rounded-2xl" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.10)">
            <p class="text-[10px] font-black tracking-widest" style="color: rgba(232,236,241,0.55)">RATING</p>
            <p class="text-base">${stars || '‚Äî'}</p>
          </div>
          <div class="p-3 rounded-2xl" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.10)">
            <p class="text-[10px] font-black tracking-widest" style="color: rgba(232,236,241,0.55)">MV</p>
            <p class="text-xl font-black" style="color: var(--accent)">${Number(prof.mv_balance || 0)}</p>
          </div>
        </div>

        <div class="mb-5">
          <div class="flex justify-between text-[11px] font-black" style="color: rgba(232,236,241,0.62)">
            <span>XP: ${lvl.xp}</span>
            <span>Next: ${lvl.next}</span>
          </div>
          <div class="mt-2 h-3 rounded-full" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.10)">
            <div class="h-full rounded-full" style="width:${Math.round(lvl.pct * 100)}%; background: linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent-3));"></div>
          </div>
        </div>

        <button onclick="openEditProfileModal()" class="btn-primary rounded-full">Edit profile</button>
      </div>
    </div>
  `;
}

/* =============================================================================
   AUTH MODAL
============================================================================= */
function openAuthModal() {
  openModal(`
    <div class="card p-6" style="max-width: 420px; margin:auto">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-black">Enter MUVR</h2>
        <button onclick="closeModal()" class="close-btn">&times;</button>
      </div>
      <p class="text-sm mb-5" style="color: rgba(232,236,241,0.65)">
        Zero commission. Escrow-first. Level up with every completed gig.
      </p>
      <input id="auth-email" type="email" placeholder="you@email.com" class="field mb-3" autocomplete="email">
      <input id="auth-password" type="password" placeholder="Password (6+ chars)" class="field mb-4" autocomplete="current-password">

      <button onclick="handleSignUp()" class="btn-primary mb-2 rounded-full">Create account</button>
      <button onclick="handleSignIn()" class="btn-secondary rounded-full">I already have an account</button>
      <p id="auth-error" class="text-xs text-center mt-3 hidden" style="color: #ffd2d2; font-weight:800"></p>

      <div class="mt-5 text-[11px]" style="color: rgba(232,236,241,0.52)">
        By continuing you agree to marketplace terms. MUVR Credits (MV) are platform credits (not currency).
      </div>
    </div>
  `);
}

/* =============================================================================
   LEGAL MODAL
============================================================================= */
function openLegalModal() {
  openModal(`
    <div class="card p-6" style="max-width: 520px; margin:auto">
      <h2 class="text-xl font-black mb-4">Before you start</h2>

      <div class="space-y-3 mb-5">
        <div class="p-4 rounded-2xl" style="background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.10)">
          <h3 class="font-black text-sm mb-1" style="color: var(--accent)">Marketplace Terms</h3>
          <p class="text-xs" style="color: rgba(232,236,241,0.62)">
            MUVR is a technology marketplace. MUVR is NOT an employer. You are an independent contractor.
          </p>
        </div>
        <div class="p-4 rounded-2xl" style="background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.10)">
          <h3 class="font-black text-sm mb-1" style="color: var(--accent)">Contractor Agreement</h3>
          <p class="text-xs" style="color: rgba(232,236,241,0.62)">
            You control your schedule, rates, methods. You're responsible for taxes, insurance, and compliance.
          </p>
        </div>
        <div class="p-4 rounded-2xl" style="background: rgba(24,246,200,0.06); border:1px solid rgba(24,246,200,0.16)">
          <h3 class="font-black text-sm mb-1" style="color: rgba(232,236,241,0.88)">MUVR Credits (MV)</h3>
          <p class="text-xs" style="color: rgba(232,236,241,0.70)">
            MV are platform-limited digital credits used within MUVR for escrow and marketplace flows. Not currency.
          </p>
        </div>
      </div>

      <div class="space-y-2 mb-5">
        ${legalCheck("check-tos","I accept the Marketplace Terms")}
        ${legalCheck("check-contractor","I accept the Contractor Agreement")}
        ${legalCheck("check-age","I am 18+")}
      </div>

      <button onclick="handleAcceptLegal()" id="legal-submit-btn" class="btn-secondary rounded-full" disabled>Check all boxes</button>
    </div>
  `, { locked: true, width: 'max-w-lg' });
}

function legalCheck(id, label) {
  return `
    <label class="flex items-start gap-3 cursor-pointer p-2 rounded-xl hover:opacity-90">
      <input type="checkbox" id="${id}" onchange="updateLegalButton()" class="w-4 h-4 mt-0.5">
      <span class="text-sm font-bold">${label}</span>
    </label>
  `;
}

function updateLegalButton() {
  const allChecked =
    getEl('check-tos')?.checked &&
    getEl('check-contractor')?.checked &&
    getEl('check-age')?.checked;

  const btn = getEl('legal-submit-btn');
  if (!btn) return;

  btn.disabled = !allChecked;
  btn.textContent = allChecked ? 'I agree & continue' : 'Check all boxes';
  btn.className = allChecked ? 'btn-primary rounded-full' : 'btn-secondary rounded-full';
}

/* =============================================================================
   MODALS: POST / APPLY / SEND / LOAD / PAYOUT / EDIT PROFILE
============================================================================= */
function openPostJobModal() {
  openModal(`
    <div class="card p-6" style="max-width: 460px; margin:auto; max-height: 90vh; overflow:auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-black">Post a gig</h2>
        <button onclick="closeModal()" class="close-btn">&times;</button>
      </div>

      <div class="space-y-3">
        <input id="job-title" placeholder="What do you need done?" maxlength="100" class="field">
        <textarea id="job-desc" placeholder="Describe the work..." rows="3" maxlength="500" class="field" style="resize:none"></textarea>

        <select id="job-type" class="field">
          <option value="">Select type‚Ä¶</option>
          <option value="rideshare">Rideshare</option>
          <option value="delivery">Delivery</option>
          <option value="physical">Physical labor</option>
          <option value="digital">Digital/remote</option>
        </select>

        <select id="job-urgency" class="field">
          <option value="asap">ASAP</option>
          <option value="today">Today</option>
          <option value="this_week">This week</option>
          <option value="flexible">Flexible</option>
        </select>

        <div>
          <label class="text-[11px] font-black mb-1 block" style="color: rgba(232,236,241,0.55)">Budget (MV)</label>
          <input id="job-budget" type="number" min="1" max="10000" placeholder="50" class="field" oninput="updateJobFeeDisplay()">
        </div>

        <input id="job-address" placeholder="Location / Address" maxlength="200" class="field">

        <div class="p-4 rounded-2xl text-sm" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.10)">
          <div class="flex justify-between mb-1">
            <span style="color: rgba(232,236,241,0.55)">Budget</span>
            <span class="font-black" id="fee-budget-display">0 MV</span>
          </div>
          <div class="flex justify-between mb-1">
            <span style="color: rgba(232,236,241,0.55)">Posting fee (burn)</span>
            <span class="font-black" style="color: var(--red)">1 MV</span>
          </div>
          <div class="flex justify-between font-black pt-2" style="border-top: 1px solid rgba(255,255,255,0.10)">
            <span>Total locked</span>
            <span id="fee-total-display" style="color: var(--accent)">1 MV</span>
          </div>
        </div>

        <button onclick="handlePostJob()" class="btn-primary rounded-full">Post gig & lock escrow</button>
        <div class="text-[11px]" style="color: rgba(232,236,241,0.50)">
          MUXI note: If you don‚Äôt have enough MV, load credits first (beta).
        </div>
      </div>
    </div>
  `, { width: 'max-w-md' });
}

function updateJobFeeDisplay() {
  const budget = parseFloat(getEl('job-budget')?.value) || 0;
  const budgetEl = getEl('fee-budget-display');
  const totalEl = getEl('fee-total-display');
  if (budgetEl) budgetEl.textContent = budget + ' MV';
  if (totalEl) totalEl.textContent = (budget + 1) + ' MV';
}

function openApplyModal(jobId) {
  openModal(`
    <div class="card p-6" style="max-width: 460px; margin:auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-black">Apply for gig</h2>
        <button onclick="closeModal()" class="close-btn">&times;</button>
      </div>

      <input type="hidden" id="apply-job-id" value="${jobId}">
      <div class="space-y-3">
        <textarea id="apply-pitch" placeholder="Why you're perfect for this‚Ä¶" rows="3" maxlength="500" class="field" style="resize:none"></textarea>
        <input id="apply-rate" type="number" min="1" placeholder="Your rate (MV)" class="field">
        <input id="apply-turnaround" placeholder="Turnaround (e.g., 2 hours)" maxlength="50" class="field">
        <button onclick="handleApply()" class="btn-primary rounded-full">Submit application</button>
      </div>
    </div>
  `, { width: 'max-w-md' });
}

function openSendModal() {
  openModal(`
    <div class="card p-6" style="max-width: 420px; margin:auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-black">Send MV</h2>
        <button onclick="closeModal()" class="close-btn">&times;</button>
      </div>
      <input id="send-to" type="text" placeholder="@handle or email" class="field mb-3">
      <input id="send-amount" type="number" min="1" placeholder="Amount (MV)" class="field mb-4">
      <button onclick="handleSend()" class="btn-primary rounded-full">Send</button>
      <div class="mt-3 text-[11px]" style="color: rgba(232,236,241,0.52)">
        MV are platform credits used within MUVR. Transfers are recorded in the platform ledger.
      </div>
    </div>
  `);
}

function openLoadModal() {
  openModal(`
    <div class="card p-6" style="max-width: 420px; margin:auto">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-black">Load MV (beta)</h2>
        <button onclick="closeModal()" class="close-btn">&times;</button>
      </div>
      <p class="text-sm font-black mb-1" style="color: var(--accent)">MUVR Credits (MV)</p>
      <p class="text-xs mb-4" style="color: rgba(232,236,241,0.55)">Payment rails integration is staged. If it's not enabled, you'll see a safe stub.</p>
      <div class="grid grid-cols-2 gap-3">
        ${loadTile(5)}
        ${loadTile(10)}
        ${loadTile(25)}
        ${loadTile(50)}
      </div>
      <div class="mt-4 text-[11px]" style="color: rgba(232,236,241,0.52)">
        Legal: MV are platform credits, not currency. Loading is handled by compliant payment partners when enabled.
      </div>
    </div>
  `);
}
function loadTile(n) {
  return `
    <button onclick="showToast('Loading MV is in beta (payment partner not enabled yet).', 'info')"
            class="btn-secondary py-4 text-center rounded-2xl">
      $${n}<br><span class="text-xs font-black" style="color: var(--accent)">${n} MV</span>
    </button>
  `;
}

function openCashoutModal() {
  openModal(`
    <div class="card p-6" style="max-width: 420px; margin:auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-black">Payout (beta)</h2>
        <button onclick="closeModal()" class="close-btn">&times;</button>
      </div>

      <input id="cashout-amount" type="number" min="1" placeholder="Amount (MV)" class="field mb-3" oninput="updateCashoutDisplay()">
      <div class="p-4 rounded-2xl text-sm mb-4" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.10)">
        <div class="flex justify-between">
          <span style="color: rgba(232,236,241,0.55)">Estimated receive</span>
          <span class="font-black" style="color: var(--accent)" id="cashout-receive">$0.00</span>
        </div>
        <div class="flex justify-between text-xs mt-1">
          <span style="color: rgba(232,236,241,0.55)">Fee (0.5%)</span>
          <span style="color: var(--red)" class="font-black" id="cashout-fee">$0.00</span>
        </div>
      </div>

      <button onclick="handleCashout()" class="btn-primary rounded-full">Request payout</button>

      <div class="mt-4 text-[11px]" style="color: rgba(232,236,241,0.52)">
        This is a staged feature. If payout rails aren‚Äôt enabled, the app will safely record a ledger entry only.
      </div>
    </div>
  `);
}

function updateCashoutDisplay() {
  const amount = parseFloat(getEl('cashout-amount')?.value) || 0;
  const fee = amount * 0.005;
  const receive = amount - fee;
  const recvEl = getEl('cashout-receive');
  const feeEl = getEl('cashout-fee');
  if (recvEl) recvEl.textContent = '$' + receive.toFixed(2);
  if (feeEl) feeEl.textContent = '$' + fee.toFixed(2);
}

function openEditProfileModal() {
  const prof = state.profile || {};
  openModal(`
    <div class="card p-6" style="max-width: 460px; margin:auto; max-height: 90vh; overflow:auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-black">Edit profile</h2>
        <button onclick="closeModal()" class="close-btn">&times;</button>
      </div>

      <div class="space-y-3">
        <input id="profile-name" placeholder="Your name" maxlength="100" class="field" value="${escapeHtml(prof.full_name || '')}">
        <input id="profile-username" placeholder="@handle" maxlength="30" class="field" value="${escapeHtml(prof.username || '')}">
        <textarea id="profile-about" placeholder="What services do you offer?" rows="3" maxlength="280" class="field" style="resize:none">${escapeHtml(prof.about_me || '')}</textarea>

        <select id="profile-role" class="field">
          <option value="both" ${prof.role === 'both' ? 'selected' : ''}>Work & post gigs</option>
          <option value="worker" ${prof.role === 'worker' ? 'selected' : ''}>Worker only</option>
          <option value="poster" ${prof.role === 'poster' ? 'selected' : ''}>Post gigs only</option>
        </select>

        <label class="flex items-center gap-3 cursor-pointer p-3 rounded-2xl"
               style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.10)">
          <input type="checkbox" id="profile-vehicle" class="w-4 h-4" ${prof.has_vehicle ? 'checked' : ''}>
          <span class="text-sm font-black">I have a vehicle</span>
        </label>

        <button onclick="handleSaveProfile()" class="btn-primary rounded-full">Save</button>
      </div>
    </div>
  `, { width: 'max-w-md' });
}

/* =============================================================================
   AUTH ERROR
============================================================================= */
function showAuthError(message) {
  const el = getEl('auth-error');
  if (!el) return;
  el.textContent = message;
  el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 5200);
}

/* =============================================================================
   ACTIONS: SIGNUP / SIGNIN / LOGOUT / ACCEPT LEGAL
============================================================================= */
async function handleSignUp() {
  const email = getEl('auth-email')?.value.trim();
  const password = getEl('auth-password')?.value;

  if (!email || !password) return showAuthError('Enter email and password');
  if (password.length < 6) return showAuthError('Password must be 6+ characters');

  try {
    setMuxi('loading', 'Creating your account‚Ä¶');
    const { data, error } = await sb.auth.signUp({ email, password });
    if (error) return showAuthError(error.message);

    // If email confirmation is required, session may be null.
    if (!data.session) {
      const { data: signInData, error: signInError } = await sb.auth.signInWithPassword({ email, password });
      if (signInError) return showAuthError('Check your email to confirm, then sign in.');
      state.user = signInData.user;
      state.token = signInData.session?.access_token || null;
    } else {
      state.user = data.user;
      state.token = data.session?.access_token || null;
    }

    closeModal();
    await loadProfileSafe();
    openLegalModal();
    showToast('Account created. Welcome to MUVR!');
    setMuxi('success', 'Welcome. Check the boxes, then you‚Äôre in.');
  } catch (err) {
    console.error(err);
    showAuthError(err.message || 'Sign up error');
    setMuxi('error', 'Sign up hit an error. I logged it in the console.');
  }
}

async function handleSignIn() {
  const email = getEl('auth-email')?.value.trim();
  const password = getEl('auth-password')?.value;

  if (!email || !password) return showAuthError('Enter email and password');

  try {
    setMuxi('loading', 'Signing you in‚Ä¶');
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if (error) return showAuthError(error.message);

    state.user = data.user;
    state.token = data.session?.access_token || null;

    closeModal();
    // Render app immediately, load data in background
    renderApp();
    showToast('Welcome back!', 'success');
    setMuxi('success', 'You‚Äôre in. I‚Äôll fetch your data in the background.');

    loadProfileSafe();
    loadJobsSafe();
  } catch (err) {
    console.error(err);
    showAuthError(err.message || 'Sign in error');
    setMuxi('error', 'Sign in hit an error. Check the console.');
  }
}

async function handleLogout() {
  try { await sb.auth.signOut(); } catch (e) {}
  state = { user:null, token:null, profile:null, jobs:[], jobFilter:'all', balanceVisible:false, currentTab:'jobs', mode: state.mode, muxiMood:'idle' };
  renderLanding();
  showToast('Signed out', 'info');
  setMuxi('idle', 'Signed out. Want to post a gig? Sign back in.');
}

async function handleAcceptLegal() {
  try {
    setMuxi('loading', 'Saving agreements‚Ä¶');
    const agreementTypes = ['tos', 'contractor_agreement', 'age'];

    for (const type of agreementTypes) {
      await apiRequest('legal_agreements', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: state.user.id,
          agreement_type: type,
          ip_address: '0.0.0.0',
          user_agent: navigator.userAgent
        })
      });
    }

    closeModal();
    renderApp();
    showToast('Agreements accepted!', 'success');
    setMuxi('success', 'Nice. You‚Äôre live.');

    loadJobsSafe();
    loadProfileSafe();
  } catch (e) {
    console.error(e);
    showToast('Error saving agreements', 'error');
    setMuxi('error', 'Agreement save failed. Console has details.');
  }
}

/* =============================================================================
   DATA LOADERS (SAFE, NON-BLOCKING)
============================================================================= */
async function loadProfileSafe() {
  if (!state.user) return;
  try {
    const res = await withTimeout(apiRequest('users?id=eq.' + state.user.id + '&select=*'), 1500, 'profile');
    if (res && res.ok) {
      const data = await res.json();
      state.profile = (data && data.length) ? data[0] : null;
    }

    if (!state.profile) {
      // fallback profile (does not write)
      state.profile = {
        id: state.user.id,
        email: state.user.email,
        mv_balance: 0,
        jobs_completed: 0,
        rating: 0,
        full_name: '',
        username: '',
        about_me: '',
        role: 'both'
      };
    }

    // refresh visible tab
    if (state.currentTab === 'wallet') { renderWalletTab(); loadWalletData(); }
    if (state.currentTab === 'profile') renderProfileTab();
  } catch (e) {
    console.error('loadProfileSafe error', e);
    setMuxi('error', 'Profile load timed out. UI stays alive.');
  }
}

async function loadJobsSafe() {
  try {
    const res = await withTimeout(apiRequest('jobs?status=eq.open&select=*&order=created_at.desc'), 1500, 'jobs');
    state.jobs = (res && res.ok) ? await res.json() : [];
    if (state.currentTab === 'jobs') renderJobsTab();
  } catch (e) {
    console.error('loadJobsSafe error', e);
    setMuxi('error', 'Jobs load timed out. Try again in a moment.');
  }
}

/* =============================================================================
   ACTION: SAVE PROFILE
============================================================================= */
async function handleSaveProfile() {
  const updates = {
    full_name: getEl('profile-name')?.value || '',
    username: (getEl('profile-username')?.value || '').toLowerCase(),
    about_me: getEl('profile-about')?.value || '',
    role: getEl('profile-role')?.value || 'both',
    has_vehicle: !!getEl('profile-vehicle')?.checked
  };

  try {
    const res = await apiRequest('users?id=eq.' + state.user.id, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updates)
    });

    if (res && res.ok) {
      state.profile = { ...(state.profile || {}), ...updates };
      closeModal();
      showToast('Profile saved!', 'success');
      renderProfileTab();
      setMuxi('success', 'Profile upgraded. You just gained XP.');
    } else {
      showToast('Error saving profile', 'error');
      setMuxi('error', 'Save failed. Likely RLS or missing row.');
    }
  } catch (e) {
    console.error(e);
    showToast('Error saving profile', 'error');
    setMuxi('error', 'Save crashed. Console has details.');
  }
}

/* =============================================================================
   ACTION: POST JOB
============================================================================= */
async function handlePostJob() {
  const title = getEl('job-title')?.value.trim();
  const description = getEl('job-desc')?.value.trim();
  const jobType = getEl('job-type')?.value;
  const budget = parseFloat(getEl('job-budget')?.value);

  if (!title) return showToast('Enter a title', 'error');
  if (!jobType) return showToast('Select a job type', 'error');
  if (!budget || budget < 1) return showToast('Budget must be at least 1 MV', 'error');
  if (budget > 10000) return showToast('Budget too high', 'error');

  const bal = Number(state.profile?.mv_balance || 0);
  if (bal < (budget + 1)) return showToast('Not enough MV', 'error');

  try {
    setMuxi('loading', 'Posting your gig‚Ä¶');
    const res = await apiRequest('jobs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        poster_id: state.user.id,
        title,
        description,
        job_type: jobType,
        urgency: getEl('job-urgency')?.value || 'asap',
        budget_mv: budget,
        fee_mv: 1,
        total_escrowed: budget + 1,
        address: getEl('job-address')?.value || '',
        status: 'open'
      })
    });

    if (!(res && res.ok)) {
      showToast('Error posting job', 'error');
      setMuxi('error', 'Job post failed. Check console.');
      return;
    }

    const jobData = await res.json();
    const jobId = jobData && jobData[0] ? jobData[0].id : null;
    if (!jobId) {
      showToast('Job created but missing ID', 'error');
      return;
    }

    // Create escrow record
    await apiRequest('escrow', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        job_id: jobId,
        poster_id: state.user.id,
        amount_mv: budget,
        fee_mv: 1,
        status: 'locked'
      })
    });

    // Log burn
    await apiRequest('mv_ledger', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: state.user.id,
        type: 'burn',
        amount_mv: 1,
        description: 'Gig posting fee (burn)',
        tx_hash: 'BURN' + Date.now(),
        related_job_id: jobId
      })
    });

    // Update balance
    const newBalance = bal - (budget + 1);
    await apiRequest('users?id=eq.' + state.user.id, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mv_balance: newBalance })
    });

    state.profile.mv_balance = newBalance;

    closeModal();
    showToast('Gig posted! Escrow locked.', 'success');
    setMuxi('success', 'Gig posted. Now watch applications roll in.');
    loadJobsSafe();
    if (state.currentTab === 'jobs') renderJobsTab();
  } catch (e) {
    console.error(e);
    showToast('Error posting job', 'error');
    setMuxi('error', 'Post crashed. Console has details.');
  }
}

/* =============================================================================
   ACTION: APPLY
============================================================================= */
async function handleApply() {
  const jobId = getEl('apply-job-id')?.value;
  const pitch = getEl('apply-pitch')?.value.trim();
  const rate = parseFloat(getEl('apply-rate')?.value);
  const turnaround = getEl('apply-turnaround')?.value.trim();

  if (!pitch) return showToast('Write a pitch', 'error');
  if (!rate || rate < 1) return showToast('Enter a rate', 'error');
  if (!turnaround) return showToast('Enter turnaround time', 'error');

  try {
    const res = await apiRequest('applications', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        job_id: jobId,
        worker_id: state.user.id,
        pitch,
        rate_mv: rate,
        turnaround,
        status: 'pending'
      })
    });

    if (res && res.ok) {
      closeModal();
      showToast('Application submitted!', 'success');
      setMuxi('success', 'Applied. Want higher win-rate? Tighten your pitch.');
    } else {
      showToast('Error submitting application', 'error');
      setMuxi('error', 'Apply failed. Likely RLS or table mismatch.');
    }
  } catch (e) {
    console.error(e);
    showToast('Error submitting application', 'error');
    setMuxi('error', 'Apply crashed. Console has details.');
  }
}

/* =============================================================================
   ACTION: SEND MV
============================================================================= */
async function handleSend() {
  const recipient = (getEl('send-to')?.value || '').trim();
  const amount = parseFloat(getEl('send-amount')?.value);

  if (!recipient) return showToast('Enter a recipient', 'error');
  if (!amount || amount < 1) return showToast('Enter an amount', 'error');

  const bal = Number(state.profile?.mv_balance || 0);
  if (bal < amount) return showToast('Not enough MV', 'error');

  try {
    // Look up recipient by email or username
    const enc = encodeURIComponent(recipient.toLowerCase());
    const lookupRes = await apiRequest('users?or=(email.eq.' + enc + ',username.eq.' + enc + ')&select=id');
    const lookupData = (lookupRes && lookupRes.ok) ? await lookupRes.json() : [];
    if (!lookupData.length) return showToast('User not found', 'error');

    const recipientId = lookupData[0].id;
    const txHash = 'TX' + Date.now() + Math.random().toString(36).slice(2, 10);

    await apiRequest('mv_ledger', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: state.user.id,
        type: 'send',
        amount_mv: amount,
        description: 'Sent to ' + recipient,
        tx_hash: txHash,
        related_user_id: recipientId
      })
    });

    await apiRequest('mv_ledger', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: recipientId,
        type: 'receive',
        amount_mv: amount,
        description: 'Received from ' + (state.profile?.full_name || state.user.email),
        tx_hash: txHash,
        related_user_id: state.user.id
      })
    });

    // Update sender balance
    const newBalance = bal - amount;
    await apiRequest('users?id=eq.' + state.user.id, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mv_balance: newBalance })
    });
    state.profile.mv_balance = newBalance;

    // Update recipient balance best-effort
    try {
      const recBalRes = await apiRequest('users?id=eq.' + recipientId + '&select=mv_balance');
      const recData = (recBalRes && recBalRes.ok) ? await recBalRes.json() : [{ mv_balance: 0 }];
      const recNew = Number(recData[0]?.mv_balance || 0) + amount;
      await apiRequest('users?id=eq.' + recipientId, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mv_balance: recNew })
      });
    } catch (e) {}

    closeModal();
    if (state.currentTab === 'wallet') { renderWalletTab(); loadWalletData(); }
    showToast('Sent ' + amount + ' MV!', 'success');
    setMuxi('success', 'Transfer done. Ledger updated.');
  } catch (e) {
    console.error(e);
    showToast('Transfer failed', 'error');
    setMuxi('error', 'Transfer failed. Console has details.');
  }
}

/* =============================================================================
   ACTION: PAYOUT (SAFE STUB)
============================================================================= */
async function handleCashout() {
  const amount = parseFloat(getEl('cashout-amount')?.value);

  if (!amount || amount < 1) return showToast('Enter an amount', 'error');

  const bal = Number(state.profile?.mv_balance || 0);
  if (bal < amount) return showToast('Not enough MV', 'error');

  const fee = amount * 0.005;
  const receiveAmount = amount - fee;

  try {
    // Record ledger entry (safe even if payout rails are not enabled)
    await apiRequest('mv_ledger', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: state.user.id,
        type: 'withdrawal',
        amount_mv: amount,
        description: 'Payout requested (beta). Est. $' + receiveAmount.toFixed(2),
        tx_hash: 'WD' + Date.now()
      })
    });

    // Deduct balance (if you want payout to be "request only", comment this out)
    const newBalance = bal - amount;
    await apiRequest('users?id=eq.' + state.user.id, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mv_balance: newBalance })
    });
    state.profile.mv_balance = newBalance;

    closeModal();
    if (state.currentTab === 'wallet') { renderWalletTab(); loadWalletData(); }

    showToast('Payout requested (beta).', 'success');
    setMuxi('success', 'Logged. If rails aren‚Äôt live yet, you‚Äôre still safe.');
  } catch (e) {
    console.error(e);
    showToast('Payout failed', 'error');
    setMuxi('error', 'Payout failed. Likely RLS or missing table.');
  }
}

/* =============================================================================
   BOOT SEQUENCE (NEVER HANG)
============================================================================= */
async function boot() {
  const dismissBoot = () => {
    const bs = getEl('boot-screen');
    if (bs) bs.classList.add('done');
  };

  // HARD GUARANTEE: never show boot longer than 900ms
  const hardDismiss = setTimeout(() => dismissBoot(), 900);

  // Always render landing immediately so UI never blocks
  renderLanding();
  setMuxi('idle', 'Tap me if anything feels slow. I‚Äôll keep the UI alive.');

  try {
    if (typeof supabase === 'undefined' || !sb) {
      console.warn('Supabase SDK not available');
      state.mode = 'offline';
      showToast('Network mode: offline (Supabase unavailable)', 'info');
      setMuxi('error', 'Supabase missing. Check CDN or adblock.');
      dismissBoot();
      return;
    }

    // Fast session check (non-blocking UI)
    let session = null;
    try {
      const s = await withTimeout(sb.auth.getSession(), 700, 'session');
      session = s?.data?.session || null;
    } catch (e) {
      console.warn('Session check timeout:', e);
    }

    if (session?.user) {
      state.user = session.user;
      state.token = session.access_token || null;

      // Render app immediately
      renderApp();
      setMuxi('success', 'Session found. Welcome back. Loading data‚Ä¶');

      // Load data in background, with independent timeouts
      loadProfileSafe();
      loadJobsSafe();
    } else {
      // landing already rendered
    }

  } catch (error) {
    console.error('Boot error:', error);
    setMuxi('error', 'Boot hit an error. Landing stays live.');
  } finally {
    clearTimeout(hardDismiss);
    dismissBoot();
  }

  // Auth listener (non-blocking)
  try {
    sb.auth.onAuthStateChange((event, session) => {
      if (session?.user) {
        state.user = session.user;
        state.token = session.access_token || null;
      } else {
        state.user = null;
        state.token = null;
      }
    });
  } catch (e) {
    console.error('Auth listener error:', e);
  }
}

// Start
boot();
</script>
</body>
</html>