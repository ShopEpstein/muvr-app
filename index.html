<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MUVR - Zero Commission. Instant Payouts. Your Wealth Grows.</title>
  <meta name="description" content="MUVR: Earn 25-50% more. Zero commission. Instant payouts. Deflationary currency.">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>

```
:root {
  --accent: #14F1C6;
  --accent-hover: #3df5d4;
  --bg-deep: #06080f;
  --bg-card: #0d1117;
  --bg-card2: #131920;
  --border: #1e2633;
  --text-dim: #5a6577;
  --text-mid: #8b95a5;
  --text-bright: #e8ecf1;
  --red: #f87171;
  --yellow: #facc15;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg-deep);
  color: var(--text-bright);
  overflow-x: hidden;
  min-height: 100vh;
}

/* ===== Boot Screen ===== */
#boot-screen {
  position: fixed;
  inset: 0;
  z-index: 10000;
  background: var(--bg-deep);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.5s ease, visibility 0.5s ease;
}
#boot-screen.done {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}
.boot-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== Page Transitions ===== */
.fade-up {
  animation: fadeUpIn 0.45s ease both;
}
.fade-up.d1 { animation-delay: 0.06s; }
.fade-up.d2 { animation-delay: 0.12s; }
.fade-up.d3 { animation-delay: 0.18s; }
.fade-up.d4 { animation-delay: 0.24s; }
@keyframes fadeUpIn {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===== Ticker ===== */
.ticker-scroll {
  animation: tickerMove 25s linear infinite;
}
@keyframes tickerMove {
  to { transform: translateX(-50%); }
}

/* ===== Modal System ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  z-index: 200;
  background: rgba(4, 6, 14, 0.88);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.25s ease, visibility 0.25s ease;
}
.modal-overlay.open {
  opacity: 1;
  visibility: visible;
}
.modal-overlay .modal-body {
  transform: translateY(14px) scale(0.97);
  transition: transform 0.25s ease;
}
.modal-overlay.open .modal-body {
  transform: translateY(0) scale(1);
}

/* ===== Form Fields ===== */
.field {
  width: 100%;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 16px;
  font-size: 14px;
  color: var(--text-bright);
  font-family: 'Outfit', sans-serif;
  transition: border-color 0.2s ease;
}
.field:focus {
  outline: none;
  border-color: var(--accent);
}
.field::placeholder {
  color: var(--text-dim);
}

/* ===== Buttons ===== */
.btn-primary {
  background: var(--accent);
  color: #000;
  font-weight: 700;
  border: none;
  border-radius: 12px;
  padding: 14px 24px;
  font-size: 14px;
  cursor: pointer;
  width: 100%;
  font-family: 'Outfit', sans-serif;
  transition: background 0.15s ease, transform 0.1s ease;
}
.btn-primary:hover { background: var(--accent-hover); }
.btn-primary:active { transform: scale(0.98); }
.btn-primary:disabled {
  background: var(--border);
  color: var(--text-dim);
  cursor: not-allowed;
}

.btn-secondary {
  background: var(--bg-card2);
  color: var(--text-bright);
  font-weight: 600;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 24px;
  font-size: 14px;
  cursor: pointer;
  width: 100%;
  font-family: 'Outfit', sans-serif;
  transition: background 0.15s ease, border-color 0.15s ease;
}
.btn-secondary:hover {
  background: #1a2230;
  border-color: #2e3a4a;
}

.btn-pill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 22px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  border: none;
  font-family: 'Outfit', sans-serif;
  transition: all 0.15s ease;
}
.btn-pill-accent {
  background: var(--accent);
  color: #000;
}
.btn-pill-accent:hover { background: var(--accent-hover); }
.btn-pill-ghost {
  background: var(--bg-card2);
  color: var(--text-mid);
  border: 1px solid var(--border);
}
.btn-pill-ghost:hover { background: #1a2230; }
.btn-pill-ghost.active {
  background: var(--accent);
  color: #000;
  border-color: var(--accent);
}

/* ===== Toast Notifications ===== */
#toast-container {
  position: fixed;
  top: 16px;
  right: 16px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}
.toast {
  padding: 14px 22px;
  border-radius: 14px;
  font-size: 13px;
  font-weight: 600;
  animation: toastSlide 0.3s ease;
  max-width: 340px;
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.06);
  pointer-events: auto;
}
.toast-success { background: rgba(6, 95, 70, 0.92); color: #6ee7b7; }
.toast-error { background: rgba(127, 29, 29, 0.92); color: #fca5a5; }
.toast-info { background: rgba(20, 40, 70, 0.92); color: #93c5fd; }
@keyframes toastSlide {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* ===== Cards ===== */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  transition: border-color 0.2s ease, transform 0.2s ease;
}
.card-interactive:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
}

/* ===== Desktop Nav Tabs ===== */
.desktop-tab {
  padding: 6px 0;
  border-bottom: 2px solid transparent;
  color: var(--text-mid);
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s ease;
  background: none;
  border-top: none;
  border-left: none;
  border-right: none;
  font-family: 'Outfit', sans-serif;
}
.desktop-tab.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

/* ===== Mobile Nav Tabs ===== */
.mobile-tab {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  font-size: 11px;
  color: var(--text-dim);
  background: none;
  border: none;
  cursor: pointer;
  font-family: 'Outfit', sans-serif;
  transition: color 0.15s ease;
}
.mobile-tab.active {
  color: var(--accent);
}

/* ===== Utility ===== */
.hero-gradient {
  background: linear-gradient(135deg, #14F1C6, #06af86);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.mono { font-family: 'JetBrains Mono', monospace; }
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.close-btn {
  color: var(--text-dim);
  background: none;
  border: none;
  cursor: pointer;
  font-size: 22px;
  line-height: 1;
  transition: color 0.15s;
}
.close-btn:hover { color: var(--text-bright); }

/* ===== Scrollbar ===== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
```

  </style>
</head>
<body style="background:#06080f;color:#e8ecf1;font-family:'Outfit',sans-serif;margin:0">

<!-- Boot Screen (shown during auth check) -->

<div id="boot-screen" style="position:fixed;inset:0;z-index:10000;background:#06080f;display:flex;align-items:center;justify-content:center">
  <div style="text-align:center">
    <div class="boot-spinner" style="width:40px;height:40px;border:3px solid #1e2633;border-top-color:#14F1C6;border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 16px"></div>
    <div style="font-size:20px;font-weight:800;letter-spacing:-0.5px;color:#e8ecf1">
      MU<span style="color:#14F1C6">V</span>R
    </div>
  </div>
</div>

<!-- Toast Container -->

<div id="toast-container"></div>

<!-- Root - dynamically populated with either landing or app -->

<div id="root"></div>

<!-- Modal Layer - modals injected here -->

<div id="modal-layer"></div>

<script>

// =============================================================================
// SUPABASE CONFIG
// =============================================================================
const SUPA_URL = 'https://cfenkstusggrcthehffn.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmZW5rc3R1c2dncmN0aGVoZmZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMTIyNTMsImV4cCI6MjA4NzU4ODI1M30.XcZKrytjAnju05w_7ly7j4bsnwLK08kBoXAhi3xYV5o';
const sb = supabase.createClient(SUPA_URL, SUPA_KEY);

// =============================================================================
// APPLICATION STATE
// =============================================================================
let state = {
  user: null,
  token: null,
  profile: null,
  jobs: [],
  jobFilter: 'all',
  balanceVisible: false,
  currentTab: 'jobs'
};

// =============================================================================
// DOM HELPERS
// =============================================================================
const getEl = (id) => document.getElementById(id);

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str || '';
  return div.innerHTML;
}

// =============================================================================
// TOAST NOTIFICATION SYSTEM
// =============================================================================
function showToast(message, type = 'success') {
  const container = getEl('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  container.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3500);
}

// =============================================================================
// AUTHENTICATED API HELPER
// =============================================================================
async function apiRequest(path, options = {}) {
  if (!state.token) {
    const session = await sb.auth.getSession();
    state.token = session.data.session?.access_token;
  }
  if (!state.token) return null;

  const headers = {
    'apikey': SUPA_KEY,
    'Authorization': 'Bearer ' + state.token,
    ...(options.headers || {})
  };

  return fetch(SUPA_URL + '/rest/v1/' + path, { ...options, headers });
}

// =============================================================================
// MODAL SYSTEM
// =============================================================================
function openModal(contentHtml, options = {}) {
  const layer = getEl('modal-layer');
  const widthClass = options.width || 'max-w-sm';

  layer.innerHTML = `
    <div class="modal-overlay" id="active-modal">
      <div class="modal-body w-full ${widthClass} mx-auto">
        ${contentHtml}
      </div>
    </div>
  `;

  // Trigger open animation on next frame
  requestAnimationFrame(() => {
    getEl('active-modal').classList.add('open');
  });

  // Click outside to close (unless locked)
  if (!options.locked) {
    getEl('active-modal').addEventListener('click', (e) => {
      if (e.target === getEl('active-modal')) closeModal();
    });
  }
}

function closeModal() {
  const modal = getEl('active-modal');
  if (!modal) return;
  modal.classList.remove('open');
  setTimeout(() => {
    getEl('modal-layer').innerHTML = '';
  }, 260);
}


// =============================================================================
// RENDER: LANDING PAGE
// =============================================================================
function renderLanding() {
  getEl('root').innerHTML = `
    <div class="fade-up">
      <!-- Contractor Disclaimer -->
      <div style="background: rgba(180, 30, 30, 0.85)" class="text-center py-1.5 text-[10px] font-bold tracking-widest">
        MUVR IS A MARKETPLACE ONLY ‚Äî NOT AN EMPLOYER ‚Äî ALL WORKERS ARE INDEPENDENT CONTRACTORS
      </div>

      <!-- Hero Section -->
      <section class="max-w-4xl mx-auto px-5 pt-16 sm:pt-24 pb-12 text-center">
        <div class="fade-up d1 inline-flex items-center gap-3 mb-8">
          <span class="text-5xl">üí∏</span>
          <h1 class="text-5xl sm:text-6xl font-black tracking-tight">
            MU<span style="color: var(--accent)">V</span>R
          </h1>
        </div>

        <p class="fade-up d2 text-3xl sm:text-5xl font-black leading-tight mb-5">
          Earn 25‚Äì50% More.<br>
          Keep 100%.<br>
          <span class="hero-gradient">Your Wealth Grows.</span>
        </p>

        <p class="fade-up d3 text-base sm:text-lg max-w-xl mx-auto mb-10" style="color: var(--text-mid)">
          Zero commission marketplace. Instant payouts in MV ‚Äî a deflationary currency 
          pegged $1 that appreciates over time.
        </p>

        <div class="fade-up d4 flex flex-col sm:flex-row gap-3 justify-center max-w-md mx-auto">
          <button onclick="openAuthModal()" class="btn-primary text-base py-4 rounded-full">
            GET STARTED
          </button>
          <button onclick="document.getElementById('why-section').scrollIntoView({behavior:'smooth'})" 
                  class="btn-secondary text-base py-4 rounded-full">
            LEARN MORE
          </button>
        </div>
      </section>

      <!-- Value Propositions -->
      <section class="max-w-5xl mx-auto px-5 py-12 grid grid-cols-1 md:grid-cols-3 gap-5">
        <div class="card card-interactive p-7 text-center">
          <p class="text-4xl font-black mb-2" style="color: var(--accent)">0%</p>
          <p class="font-bold text-lg mb-1">Commission</p>
          <p class="text-sm" style="color: var(--text-dim)">
            Keep 100% of your rate. Only 1 MV burned per job.
          </p>
        </div>
        <div class="card card-interactive p-7 text-center">
          <p class="text-4xl mb-2">‚ö°</p>
          <p class="font-bold text-lg mb-1">Instant Payouts</p>
          <p class="text-sm" style="color: var(--text-dim)">
            No delays. No risk. 1 MV = $1 USD. Always.
          </p>
        </div>
        <div class="card card-interactive p-7 text-center">
          <p class="text-4xl mb-2">üìà</p>
          <p class="font-bold text-lg mb-1">Your Wealth Grows</p>
          <p class="text-sm" style="color: var(--text-dim)">
            Deflationary. Hard cap 100M. MV appreciates over time.
          </p>
        </div>
      </section>

      <!-- Platform Comparison -->
      <section id="why-section" class="max-w-3xl mx-auto px-5 py-16">
        <h2 class="text-2xl sm:text-3xl font-black text-center mb-8">Why Workers Choose MUVR</h2>
        <div class="card overflow-hidden">
          <table class="w-full text-sm">
            <thead>
              <tr style="border-bottom: 1px solid var(--border)">
                <th class="px-5 py-4 text-left font-bold">Platform</th>
                <th class="px-5 py-4 text-center font-bold">Commission</th>
                <th class="px-5 py-4 text-center font-bold">Payouts</th>
                <th class="px-5 py-4 text-center font-bold">Equity</th>
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid var(--border)">
                <td class="px-5 py-4 font-bold">Uber</td>
                <td class="px-5 py-4 text-center" style="color: var(--red)">25-30%</td>
                <td class="px-5 py-4 text-center">Real-time</td>
                <td class="px-5 py-4 text-center" style="color: var(--red)">‚ùå</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border)">
                <td class="px-5 py-4 font-bold">Fiverr</td>
                <td class="px-5 py-4 text-center" style="color: var(--red)">20%</td>
                <td class="px-5 py-4 text-center" style="color: var(--red)">14+ days</td>
                <td class="px-5 py-4 text-center" style="color: var(--red)">‚ùå</td>
              </tr>
              <tr style="background: rgba(20, 241, 198, 0.06)">
                <td class="px-5 py-4 font-black" style="color: var(--accent)">MUVR</td>
                <td class="px-5 py-4 text-center font-bold" style="color: var(--accent)">0%</td>
                <td class="px-5 py-4 text-center font-bold" style="color: var(--accent)">Instant</td>
                <td class="px-5 py-4 text-center font-bold" style="color: var(--accent)">‚úÖ MV</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- How It Works -->
      <section class="max-w-4xl mx-auto px-5 py-16">
        <h2 class="text-2xl sm:text-3xl font-black text-center mb-10">How It Works</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
          <div class="text-center">
            <div class="w-14 h-14 rounded-full mx-auto mb-3 flex items-center justify-center" 
                 style="background: rgba(20, 241, 198, 0.1)">
              <span class="text-2xl">üìù</span>
            </div>
            <p class="font-bold mb-1">Post or Apply</p>
            <p class="text-xs" style="color: var(--text-dim)">Post a gig or apply. No upfront cost.</p>
          </div>
          <div class="text-center">
            <div class="w-14 h-14 rounded-full mx-auto mb-3 flex items-center justify-center" 
                 style="background: rgba(20, 241, 198, 0.1)">
              <span class="text-2xl">üîí</span>
            </div>
            <p class="font-bold mb-1">Escrow Locked</p>
            <p class="text-xs" style="color: var(--text-dim)">Budget locked. 1 MV burned. Protected.</p>
          </div>
          <div class="text-center">
            <div class="w-14 h-14 rounded-full mx-auto mb-3 flex items-center justify-center" 
                 style="background: rgba(20, 241, 198, 0.1)">
              <span class="text-2xl">‚úÖ</span>
            </div>
            <p class="font-bold mb-1">Work Complete</p>
            <p class="text-xs" style="color: var(--text-dim)">Keep 100%. Instantly.</p>
          </div>
          <div class="text-center">
            <div class="w-14 h-14 rounded-full mx-auto mb-3 flex items-center justify-center" 
                 style="background: rgba(20, 241, 198, 0.1)">
              <span class="text-2xl">üìà</span>
            </div>
            <p class="font-bold mb-1">MV Appreciates</p>
            <p class="text-xs" style="color: var(--text-dim)">Deflationary. Value grows.</p>
          </div>
        </div>
      </section>

      <!-- Final CTA -->
      <section class="max-w-3xl mx-auto px-5 py-16 text-center">
        <h2 class="text-3xl sm:text-4xl font-black mb-4">Ready to Earn More?</h2>
        <p class="text-base mb-8" style="color: var(--text-mid)">
          Join workers earning 25-50% more. Zero commission. Instant payouts.
        </p>
        <button onclick="openAuthModal()" class="btn-primary text-base py-4 px-10 rounded-full" 
                style="width: auto; display: inline-block">
          SIGN UP NOW
        </button>
      </section>

      <!-- Footer -->
      <footer style="border-top: 1px solid var(--border)" class="py-8 text-center text-xs">
        <p class="mb-1" style="color: var(--text-dim)">MUVR is operated by TransBid LLC (Delaware, USA)</p>
        <p style="color: #2e3a4a">&copy; 2026 TransBid LLC. All rights reserved.</p>
      </footer>
    </div>
  `;
}


// =============================================================================
// RENDER: APP SHELL (injected only after successful login)
// =============================================================================
function renderApp() {
  getEl('root').innerHTML = `
    <div class="fade-up">
      <!-- Contractor Disclaimer -->
      <div style="background: rgba(180, 30, 30, 0.85)" class="text-center py-1.5 text-[10px] font-bold tracking-widest">
        MUVR IS A MARKETPLACE ONLY ‚Äî NOT AN EMPLOYER ‚Äî ALL WORKERS ARE INDEPENDENT CONTRACTORS
      </div>

      <!-- App Header -->
      <header style="border-bottom: 1px solid var(--border); background: rgba(13,17,23,0.96); backdrop-filter: blur(12px)" 
              class="sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <div class="flex items-center gap-2 cursor-pointer" onclick="switchTab('jobs')">
            <span class="text-xl">üí∏</span>
            <span class="text-xl font-black tracking-tight">
              MU<span style="color: var(--accent)">V</span>R
            </span>
            <span class="text-[9px] font-bold px-2 py-0.5 rounded-full" 
                  style="background: var(--accent); color: #000">
              DEFLATIONARY
            </span>
          </div>

          <nav class="hidden sm:flex gap-6">
            <button onclick="switchTab('jobs')" class="desktop-tab active" data-tab="jobs">JOBS</button>
            <button onclick="switchTab('wallet')" class="desktop-tab" data-tab="wallet">WALLET</button>
            <button onclick="switchTab('profile')" class="desktop-tab" data-tab="profile">PROFILE</button>
          </nav>

          <button onclick="handleLogout()" class="text-xs font-semibold cursor-pointer" 
                  style="color: var(--text-dim); background: none; border: none; font-family: 'Outfit'">
            sign out
          </button>
        </div>

        <!-- Ticker -->
        <div style="background: #000" class="py-1 overflow-hidden">
          <div class="ticker-scroll whitespace-nowrap flex gap-8 text-[10px] mono tracking-wider" 
               style="color: var(--accent)">
            <span>‚ö° ZERO COMMISSION ‚Ä¢ 1 MV = $1 USD ‚Ä¢ DEFLATIONARY ‚Ä¢ INSTANT PAYOUTS ‚Ä¢ TRANSPARENT LEDGER ‚ö°</span>
            <span>‚ö° ZERO COMMISSION ‚Ä¢ 1 MV = $1 USD ‚Ä¢ DEFLATIONARY ‚Ä¢ INSTANT PAYOUTS ‚Ä¢ TRANSPARENT LEDGER ‚ö°</span>
          </div>
        </div>
      </header>

      <!-- Tab Content Area -->
      <main class="max-w-6xl mx-auto px-4 py-6 pb-28 sm:pb-8">
        <div id="tab-content"></div>
      </main>

      <!-- Mobile Bottom Nav -->
      <div class="sm:hidden fixed bottom-0 left-0 right-0 z-50" 
           style="background: rgba(13,17,23,0.96); border-top: 1px solid var(--border); backdrop-filter: blur(12px)">
        <div class="flex justify-around py-3">
          <button onclick="switchTab('jobs')" class="mobile-tab active" data-tab="jobs">
            <i class="fas fa-briefcase text-base"></i>Jobs
          </button>
          <button onclick="switchTab('wallet')" class="mobile-tab" data-tab="wallet">
            <i class="fas fa-coins text-base"></i>MV
          </button>
          <button onclick="switchTab('profile')" class="mobile-tab" data-tab="profile">
            <i class="fas fa-user text-base"></i>Me
          </button>
        </div>
      </div>
    </div>
  `;

  // Render default tab
  switchTab('jobs');
}

// =============================================================================
// TAB SWITCHING
// =============================================================================
function switchTab(tabName) {
  state.currentTab = tabName;

  // Update desktop tab styles
  document.querySelectorAll('.desktop-tab').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.mobile-tab').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll(`[data-tab="${tabName}"]`).forEach(btn => btn.classList.add('active'));

  // Render the selected tab
  if (tabName === 'jobs') renderJobsTab();
  else if (tabName === 'wallet') { renderWalletTab(); loadWalletData(); }
  else if (tabName === 'profile') renderProfileTab();
}

// =============================================================================
// JOBS TAB
// =============================================================================
function renderJobsTab() {
  const content = getEl('tab-content');
  if (!content) return;

  const filteredJobs = state.jobFilter === 'all' 
    ? state.jobs 
    : state.jobs.filter(j => j.job_type === state.jobFilter);

  const categories = [
    { key: 'all', label: 'All' },
    { key: 'rideshare', label: 'Rideshare' },
    { key: 'delivery', label: 'Delivery' },
    { key: 'physical', label: 'Labor' },
    { key: 'digital', label: 'Digital' }
  ];

  const filterButtons = categories.map(cat => `
    <button onclick="state.jobFilter='${cat.key}'; renderJobsTab()" 
            class="btn-pill ${state.jobFilter === cat.key ? 'btn-pill-accent' : 'btn-pill-ghost'} whitespace-nowrap">
      ${cat.label}
    </button>
  `).join('');

  const jobCards = filteredJobs.length === 0
    ? `<div class="col-span-full text-center py-16" style="color: var(--text-dim)">
         <p class="text-4xl mb-3">üîç</p>
         <p class="font-bold">No gigs in this category</p>
         <p class="text-sm mt-1">Be the first to post one!</p>
       </div>`
    : filteredJobs.map(job => `
        <div class="card card-interactive p-5 cursor-pointer">
          <div class="flex items-start justify-between mb-2">
            <h3 class="font-bold text-sm">${escapeHtml(job.title)}</h3>
            <span class="text-[10px] px-2 py-0.5 rounded-full font-bold" 
                  style="background: var(--bg-card2); color: var(--text-dim); border: 1px solid var(--border)">
              ${escapeHtml(job.job_type || '')}
            </span>
          </div>
          <p class="text-xs line-clamp-2 mb-4" style="color: var(--text-dim)">
            ${escapeHtml(job.description || '')}
          </p>
          <div class="flex items-end justify-between">
            <div>
              <p class="text-[10px]" style="color: var(--text-dim)">Budget</p>
              <p class="text-lg font-bold" style="color: var(--accent)">${job.budget_mv} MV</p>
            </div>
            <button onclick="openApplyModal('${job.id}')" class="btn-pill btn-pill-accent">
              APPLY
            </button>
          </div>
        </div>
      `).join('');

  content.innerHTML = `
    <div class="fade-up">
      <div class="mb-6">
        <h1 class="text-3xl sm:text-4xl font-black mb-1">Available Gigs</h1>
        <p class="text-sm mb-5" style="color: var(--text-mid)">Find work. Keep more. Build wealth.</p>
        <button onclick="openPostJobModal()" class="btn-pill btn-pill-accent">
          + POST A GIG
        </button>
      </div>

      <div class="flex gap-2 mb-5 overflow-x-auto pb-1">
        ${filterButtons}
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        ${jobCards}
      </div>
    </div>
  `;
}

// =============================================================================
// WALLET TAB
// =============================================================================
function renderWalletTab() {
  const content = getEl('tab-content');
  if (!content) return;

  const balance = state.profile?.mv_balance || 0;

  content.innerHTML = `
    <div class="fade-up">
      <h1 class="text-3xl font-black mb-5">Your MV Wallet</h1>

      <!-- Network Status -->
      <div class="card p-5 mb-5" 
           style="border-color: rgba(20,241,198,0.15); background: linear-gradient(135deg, rgba(20,241,198,0.06), rgba(6,175,134,0.04))">
        <p class="text-[10px] tracking-widest font-bold mb-3" style="color: var(--text-dim)">
          MV NETWORK STATUS
        </p>
        <div class="grid grid-cols-4 gap-3 text-center">
          <div>
            <p class="text-[10px]" style="color: var(--text-dim)">CAP</p>
            <p class="text-xl font-black mono" style="color: var(--accent)">100M</p>
          </div>
          <div>
            <p class="text-[10px]" style="color: var(--text-dim)">MINTED</p>
            <p class="text-xl font-black mono" style="color: var(--accent)" id="stat-minted">0</p>
          </div>
          <div>
            <p class="text-[10px]" style="color: var(--text-dim)">ESCROWED</p>
            <p class="text-xl font-bold mono" style="color: var(--yellow)" id="stat-escrowed">0</p>
          </div>
          <div>
            <p class="text-[10px]" style="color: var(--text-dim)">BURNED</p>
            <p class="text-xl font-bold mono" style="color: var(--red)" id="stat-burned">0</p>
          </div>
        </div>
      </div>

      <!-- Balance Card -->
      <div class="card p-5 max-w-md mb-6">
        <p class="text-[10px] tracking-widest font-bold mb-2" style="color: var(--text-dim)">
          YOUR MV BALANCE
        </p>
        <div class="flex items-end justify-between mb-5">
          <p class="text-4xl font-black mono" style="color: var(--accent)" id="balance-display">
            ${state.balanceVisible ? balance + ' MV' : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
          </p>
          <button onclick="toggleBalance()" class="text-xs font-bold cursor-pointer" 
                  style="color: var(--text-dim); background: none; border: none; font-family: 'Outfit'">
            ${state.balanceVisible ? 'HIDE' : 'SHOW'}
          </button>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <button onclick="openSendModal()" class="btn-pill btn-pill-ghost w-full justify-center">SEND</button>
          <button onclick="openLoadModal()" class="btn-pill btn-pill-accent w-full justify-center">LOAD</button>
          <button onclick="openCashoutModal()" class="btn-pill btn-pill-ghost w-full justify-center">CASH OUT</button>
        </div>
      </div>

      <!-- Ledger -->
      <h2 class="font-bold mb-3">Transaction Ledger</h2>
      <div id="ledger-list">
        <p class="text-sm py-4" style="color: var(--text-dim)">Loading transactions...</p>
      </div>
    </div>
  `;
}

function toggleBalance() {
  state.balanceVisible = !state.balanceVisible;
  if (state.currentTab === 'wallet') {
    renderWalletTab();
    loadWalletData();
  }
}

async function loadWalletData() {
  if (!state.user) return;

  // Refresh balance
  const balRes = await apiRequest('users?id=eq.' + state.user.id + '&select=mv_balance');
  if (balRes) {
    const data = await balRes.json();
    if (data?.length) {
      state.profile = { ...state.profile, mv_balance: data[0].mv_balance };
    }
  }

  // Update display
  const balDisplay = getEl('balance-display');
  if (balDisplay) {
    balDisplay.textContent = state.balanceVisible 
      ? (state.profile?.mv_balance || 0) + ' MV' 
      : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  }

  // Load ledger
  const ledgerRes = await apiRequest(
    'mv_ledger?user_id=eq.' + state.user.id + '&order=created_at.desc&limit=20'
  );
  const ledger = (ledgerRes && await ledgerRes.json()) || [];
  const ledgerEl = getEl('ledger-list');
  if (!ledgerEl) return;

  if (ledger.length === 0) {
    ledgerEl.innerHTML = '<p class="text-sm py-4" style="color: var(--text-dim)">No transactions yet</p>';
    return;
  }

  const typeIcons = {
    load: 'üì•', send: 'üì§', receive: 'üì®', burn: 'üî•', withdrawal: 'üè¶'
  };

  ledgerEl.innerHTML = ledger.map(entry => {
    const isNegative = ['burn', 'send', 'withdrawal'].includes(entry.type);
    const icon = typeIcons[entry.type] || 'üìä';
    const color = isNegative ? 'var(--red)' : 'var(--accent)';
    const sign = isNegative ? '-' : '+';

    return `
      <div class="card p-3 mb-2 flex justify-between items-start" 
           style="border-left: 2px solid var(--accent)">
        <div class="flex items-start gap-3">
          <span class="text-base">${icon}</span>
          <div>
            <p class="font-bold text-xs capitalize">${entry.type}</p>
            <p class="text-[11px]" style="color: var(--text-dim)">${escapeHtml(entry.description || '')}</p>
            <p class="text-[10px] mt-1" style="color: #2e3a4a">
              ${new Date(entry.created_at).toLocaleDateString()}
            </p>
          </div>
        </div>
        <p class="mono font-bold text-xs whitespace-nowrap ml-2" style="color: ${color}">
          ${sign}${entry.amount_mv} MV
        </p>
      </div>
    `;
  }).join('');
}

// =============================================================================
// PROFILE TAB
// =============================================================================
function renderProfileTab() {
  const content = getEl('tab-content');
  if (!content) return;

  const prof = state.profile || {};
  const rating = prof.rating || 0;
  const stars = '‚≠ê'.repeat(Math.floor(rating)) + (rating % 1 > 0 ? '‚ú®' : '');

  content.innerHTML = `
    <div class="fade-up">
      <h1 class="text-3xl font-black mb-5">Your Profile</h1>

      <div class="card p-5 max-w-lg">
        <div class="mb-5" style="border-bottom: 1px solid var(--border); padding-bottom: 16px">
          <h2 class="text-2xl font-black mb-1">${escapeHtml(prof.full_name || 'No Name Set')}</h2>
          <p class="text-sm" style="color: var(--text-dim)">@${escapeHtml(prof.username || 'no_handle')}</p>
          <p class="text-xs mt-2" style="color: var(--text-dim)">${escapeHtml(prof.about_me || 'No bio yet')}</p>
        </div>

        <div class="grid grid-cols-3 gap-4 text-center mb-5">
          <div>
            <p class="text-[10px]" style="color: var(--text-dim)">COMPLETED</p>
            <p class="text-xl font-bold">${prof.jobs_completed || 0}</p>
          </div>
          <div>
            <p class="text-[10px]" style="color: var(--text-dim)">RATING</p>
            <p class="text-base">${stars || '‚Äî'}</p>
          </div>
          <div>
            <p class="text-[10px]" style="color: var(--text-dim)">BALANCE</p>
            <p class="text-xl font-bold" style="color: var(--accent)">${prof.mv_balance || 0}</p>
          </div>
        </div>

        <button onclick="openEditProfileModal()" class="btn-primary rounded-xl">EDIT PROFILE</button>
      </div>
    </div>
  `;
}


// =============================================================================
// MODAL: AUTH (Login / Sign Up)
// =============================================================================
function openAuthModal() {
  openModal(`
    <div class="card p-6" style="max-width: 400px; margin: auto">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-black">Join MUVR</h2>
        <button onclick="closeModal()" class="close-btn">&times;</button>
      </div>
      <p class="text-sm mb-5" style="color: var(--text-mid)">
        Zero commission. Instant payouts. Your wealth grows.
      </p>
      <input id="auth-email" type="email" placeholder="you@email.com" class="field mb-3">
      <input id="auth-password" type="password" placeholder="Password (6+ chars)" class="field mb-4">
      <button onclick="handleSignUp()" class="btn-primary mb-2">CREATE ACCOUNT</button>
      <button onclick="handleSignIn()" class="btn-secondary">ALREADY HAVE ACCOUNT</button>
      <p id="auth-error" class="text-xs text-center mt-3 hidden" style="color: #fca5a5"></p>
    </div>
  `);
}

// =============================================================================
// MODAL: LEGAL AGREEMENTS
// =============================================================================
function openLegalModal() {
  openModal(`
    <div class="card p-6" style="max-width: 480px; margin: auto">
      <h2 class="text-xl font-black mb-4">Before You Start</h2>

      <div class="space-y-3 mb-5">
        <div class="p-4 rounded-xl" style="background: var(--bg-card2)">
          <h3 class="font-bold text-sm mb-1" style="color: var(--accent)">Terms of Service</h3>
          <p class="text-xs" style="color: var(--text-mid)">
            MUVR is a technology marketplace. MUVR is NOT an employer. You are an independent contractor.
          </p>
        </div>
        <div class="p-4 rounded-xl" style="background: var(--bg-card2)">
          <h3 class="font-bold text-sm mb-1" style="color: var(--accent)">Contractor Agreement</h3>
          <p class="text-xs" style="color: var(--text-mid)">
            You control your schedule, rates, methods. You're responsible for taxes, insurance, and compliance.
          </p>
        </div>
      </div>

      <div class="space-y-2 mb-5">
        <label class="flex items-start gap-3 cursor-pointer p-2 rounded hover:opacity-80">
          <input type="checkbox" id="check-tos" onchange="updateLegalButton()" class="w-4 h-4 mt-0.5">
          <span class="text-sm">I accept the <strong>Terms of Service</strong></span>
        </label>
        <label class="flex items-start gap-3 cursor-pointer p-2 rounded hover:opacity-80">
          <input type="checkbox" id="check-contractor" onchange="updateLegalButton()" class="w-4 h-4 mt-0.5">
          <span class="text-sm">I accept <strong>Contractor Agreement</strong></span>
        </label>
        <label class="flex items-start gap-3 cursor-pointer p-2 rounded hover:opacity-80">
          <input type="checkbox" id="check-age" onchange="updateLegalButton()" class="w-4 h-4 mt-0.5">
          <span class="text-sm">I am <strong>18+</strong></span>
        </label>
      </div>

      <button onclick="handleAcceptLegal()" id="legal-submit-btn" class="btn-secondary" disabled>
        Check all boxes
      </button>
    </div>
  `, { locked: true, width: 'max-w-lg' });
}

function updateLegalButton() {
  const allChecked = getEl('check-tos')?.checked 
    && getEl('check-contractor')?.checked 
    && getEl('check-age')?.checked;
  const btn = getEl('legal-submit-btn');
  if (!btn) return;

  btn.disabled = !allChecked;
  btn.textContent = allChecked ? 'I AGREE & CONTINUE' : 'Check all boxes';
  btn.className = allChecked ? 'btn-primary' : 'btn-secondary';
  if (!allChecked) btn.disabled = true;
}

// =============================================================================
// MODAL: POST A JOB
// =============================================================================
function openPostJobModal() {
  openModal(`
    <div class="card p-6" style="max-width: 440px; margin: auto; max-height: 90vh; overflow-y: auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-black">Post a Gig</h2>
        <button onclick="closeModal()" class="close-btn">&times;</button>
      </div>
      <div class="space-y-3">
        <input id="job-title" placeholder="What do you need done?" maxlength="100" class="field">
        <textarea id="job-desc" placeholder="Describe the work..." rows="3" maxlength="500" 
                  class="field" style="resize: none"></textarea>

```
    <select id="job-type" class="field">
      <option value="">Select type...</option>
      <option value="rideshare">Rideshare</option>
      <option value="delivery">Delivery</option>
      <option value="physical">Physical Labor</option>
      <option value="digital">Digital/Remote</option>
    </select>
    <select id="job-urgency" class="field">
      <option value="asap">ASAP</option>
      <option value="today">Today</option>
      <option value="this_week">This Week</option>
      <option value="flexible">Flexible</option>
    </select>
    <div>
      <label class="text-[11px] font-bold mb-1 block" style="color: var(--text-dim)">Budget (MV)</label>
      <input id="job-budget" type="number" min="1" max="10000" placeholder="50" 
             class="field" oninput="updateJobFeeDisplay()">
    </div>
    <input id="job-address" placeholder="Location / Address" maxlength="200" class="field">

    <div class="p-3 rounded-xl text-sm" style="background: var(--bg-card2); border: 1px solid var(--border)">
      <div class="flex justify-between mb-1">
        <span style="color: var(--text-dim)">Budget</span>
        <span class="font-bold" id="fee-budget-display">0 MV</span>
      </div>
      <div class="flex justify-between mb-1">
        <span style="color: var(--text-dim)">Fee (burned)</span>
        <span class="font-bold" style="color: var(--red)">1 MV</span>
      </div>
      <div class="flex justify-between font-bold pt-2" style="border-top: 1px solid var(--border)">
        <span>TOTAL</span>
        <span id="fee-total-display" style="color: var(--accent)">1 MV</span>
      </div>
    </div>

    <button onclick="handlePostJob()" class="btn-primary">POST GIG & ESCROW</button>
  </div>
</div>
```

`, { width: ‚Äòmax-w-md‚Äô });
}

function updateJobFeeDisplay() {
const budget = parseFloat(getEl(‚Äòjob-budget‚Äô)?.value) || 0;
const budgetEl = getEl(‚Äòfee-budget-display‚Äô);
const totalEl = getEl(‚Äòfee-total-display‚Äô);
if (budgetEl) budgetEl.textContent = budget + ‚Äô MV‚Äô;
if (totalEl) totalEl.textContent = (budget + 1) + ‚Äô MV‚Äô;
}

// =============================================================================
// MODAL: APPLY FOR JOB
// =============================================================================
function openApplyModal(jobId) {
openModal(`<div class="card p-6" style="max-width: 440px; margin: auto"> <div class="flex justify-between items-center mb-4"> <h2 class="text-xl font-black">Apply for Gig</h2> <button onclick="closeModal()" class="close-btn">&times;</button> </div> <input type="hidden" id="apply-job-id" value="${jobId}"> <div class="space-y-3"> <textarea id="apply-pitch" placeholder="Why you're perfect for this..." rows="3"  maxlength="500" class="field" style="resize: none"></textarea> <input id="apply-rate" type="number" min="1" placeholder="Your rate (MV)" class="field"> <input id="apply-turnaround" placeholder="Turnaround (e.g. 2 hours)" maxlength="50" class="field"> <button onclick="handleApply()" class="btn-primary">SUBMIT APPLICATION</button> </div> </div>`, { width: ‚Äòmax-w-md‚Äô });
}

// =============================================================================
// MODAL: SEND MV
// =============================================================================
function openSendModal() {
openModal(`<div class="card p-6" style="max-width: 380px; margin: auto"> <div class="flex justify-between items-center mb-4"> <h2 class="text-xl font-black">Send MV</h2> <button onclick="closeModal()" class="close-btn">&times;</button> </div> <input id="send-to" type="text" placeholder="@handle or email" class="field mb-3"> <input id="send-amount" type="number" min="1" placeholder="Amount (MV)" class="field mb-4"> <button onclick="handleSend()" class="btn-primary">SEND</button> </div>`);
}

// =============================================================================
// MODAL: LOAD MV
// =============================================================================
function openLoadModal() {
openModal(`<div class="card p-6" style="max-width: 380px; margin: auto"> <div class="flex justify-between items-center mb-3"> <h2 class="text-xl font-black">Load MV</h2> <button onclick="closeModal()" class="close-btn">&times;</button> </div> <p class="text-sm font-bold mb-1" style="color: var(--accent)">1 MV = $1 USD. Always.</p> <p class="text-xs mb-4" style="color: var(--text-dim)">Zero fees. Instant. Powered by Stripe.</p> <div class="grid grid-cols-2 gap-3"> <button onclick="showToast('Stripe integration coming soon', 'info')" class="btn-secondary py-4 text-center"> $5<br><span class="text-xs" style="color: var(--accent)">5 MV</span> </button> <button onclick="showToast('Stripe integration coming soon', 'info')" class="btn-secondary py-4 text-center"> $10<br><span class="text-xs" style="color: var(--accent)">10 MV</span> </button> <button onclick="showToast('Stripe integration coming soon', 'info')" class="btn-secondary py-4 text-center"> $25<br><span class="text-xs" style="color: var(--accent)">25 MV</span> </button> <button onclick="showToast('Stripe integration coming soon', 'info')" class="btn-secondary py-4 text-center"> $50<br><span class="text-xs" style="color: var(--accent)">50 MV</span> </button> </div> </div>`);
}

// =============================================================================
// MODAL: CASH OUT
// =============================================================================
function openCashoutModal() {
openModal(`<div class="card p-6" style="max-width: 380px; margin: auto"> <div class="flex justify-between items-center mb-4"> <h2 class="text-xl font-black">Cash Out</h2> <button onclick="closeModal()" class="close-btn">&times;</button> </div> <input id="cashout-amount" type="number" min="1" placeholder="Amount (MV)"  class="field mb-3" oninput="updateCashoutDisplay()"> <div class="p-3 rounded-xl text-sm mb-4" style="background: var(--bg-card2)"> <div class="flex justify-between"> <span style="color: var(--text-dim)">You receive</span> <span class="font-bold" style="color: var(--accent)" id="cashout-receive">$0.00</span> </div> <div class="flex justify-between text-xs mt-1"> <span style="color: var(--text-dim)">Fee (0.5%)</span> <span style="color: var(--red)" id="cashout-fee">$0.00</span> </div> </div> <button onclick="handleCashout()" class="btn-primary">WITHDRAW</button> </div>`);
}

function updateCashoutDisplay() {
const amount = parseFloat(getEl(‚Äòcashout-amount‚Äô)?.value) || 0;
const fee = amount * 0.005;
const receive = amount - fee;
const recvEl = getEl(‚Äòcashout-receive‚Äô);
const feeEl = getEl(‚Äòcashout-fee‚Äô);
if (recvEl) recvEl.textContent = ‚Äò$‚Äô + receive.toFixed(2);
if (feeEl) feeEl.textContent = ‚Äò$‚Äô + fee.toFixed(2);
}

// =============================================================================
// MODAL: EDIT PROFILE
// =============================================================================
function openEditProfileModal() {
const prof = state.profile || {};
openModal(`<div class="card p-6" style="max-width: 440px; margin: auto; max-height: 90vh; overflow-y: auto"> <div class="flex justify-between items-center mb-4"> <h2 class="text-xl font-black">Edit Profile</h2> <button onclick="closeModal()" class="close-btn">&times;</button> </div> <div class="space-y-3"> <input id="profile-name" placeholder="Your name" maxlength="100" class="field"  value="${escapeHtml(prof.full_name || '')}"> <input id="profile-username" placeholder="@handle" maxlength="30" class="field"  value="${escapeHtml(prof.username || '')}"> <textarea id="profile-about" placeholder="What services do you offer?" rows="3"  maxlength="280" class="field" style="resize: none">${escapeHtml(prof.about_me || '')}</textarea> <select id="profile-role" class="field"> <option value="both" ${prof.role === 'both' ? 'selected' : ''}>Work & Post Jobs</option> <option value="worker" ${prof.role === 'worker' ? 'selected' : ''}>Worker Only</option> <option value="poster" ${prof.role === 'poster' ? 'selected' : ''}>Post Jobs Only</option> </select> <label class="flex items-center gap-3 cursor-pointer p-3 rounded-xl" style="background: var(--bg-card2)"> <input type="checkbox" id="profile-vehicle" class="w-4 h-4" ${prof.has_vehicle ? 'checked' : ''}> <span class="text-sm">I have a vehicle</span> </label> <button onclick="handleSaveProfile()" class="btn-primary">SAVE PROFILE</button> </div> </div>`, { width: ‚Äòmax-w-md‚Äô });
}

// =============================================================================
// AUTH ERROR HELPER
// =============================================================================
function showAuthError(message) {
const el = getEl(‚Äòauth-error‚Äô);
if (!el) return;
el.textContent = message;
el.classList.remove(‚Äòhidden‚Äô);
setTimeout(() => el?.classList.add(‚Äòhidden‚Äô), 5000);
}

// =============================================================================
// ACTION: SIGN UP
// =============================================================================
async function handleSignUp() {
const email = getEl(‚Äòauth-email‚Äô)?.value.trim();
const password = getEl(‚Äòauth-password‚Äô)?.value;

if (!email || !password) return showAuthError(‚ÄòEnter email and password‚Äô);
if (password.length < 6) return showAuthError(‚ÄòPassword: 6+ characters‚Äô);

try {
const { data, error } = await sb.auth.signUp({ email, password });
if (error) return showAuthError(error.message);

```
if (!data.session) {
  // Try immediate sign-in (some Supabase configs auto-confirm)
  const { data: signInData, error: signInError } = await sb.auth.signInWithPassword({ email, password });
  if (signInError) return showAuthError('Check email to confirm, then sign in.');
  state.user = signInData.user;
  state.token = signInData.session?.access_token;
} else {
  state.user = data.user;
  state.token = data.session?.access_token;
}

closeModal();
await loadProfile();
openLegalModal();
showToast('Account created! Welcome to MUVR!');
```

} catch (err) {
showAuthError(err.message);
}
}

// =============================================================================
// ACTION: SIGN IN
// =============================================================================
async function handleSignIn() {
const email = getEl(‚Äòauth-email‚Äô)?.value.trim();
const password = getEl(‚Äòauth-password‚Äô)?.value;

if (!email || !password) return showAuthError(‚ÄòEnter email and password‚Äô);

const { data, error } = await sb.auth.signInWithPassword({ email, password });
if (error) return showAuthError(error.message);

state.user = data.user;
state.token = data.session?.access_token;

closeModal();
await loadProfile();
await loadJobs();
renderApp();
showToast(‚ÄòWelcome back!‚Äô);
}

// =============================================================================
// ACTION: LOGOUT
// =============================================================================
async function handleLogout() {
await sb.auth.signOut();
state = {
user: null,
token: null,
profile: null,
jobs: [],
jobFilter: ‚Äòall‚Äô,
balanceVisible: false,
currentTab: ‚Äòjobs‚Äô
};
renderLanding();
showToast(‚ÄòSigned out‚Äô, ‚Äòinfo‚Äô);
}

// =============================================================================
// ACTION: ACCEPT LEGAL
// =============================================================================
async function handleAcceptLegal() {
const agreementTypes = [‚Äòtos‚Äô, ‚Äòcontractor_agreement‚Äô, ‚Äòage‚Äô];
for (const type of agreementTypes) {
await apiRequest(‚Äòlegal_agreements‚Äô, {
method: ‚ÄòPOST‚Äô,
headers: { ‚ÄòContent-Type‚Äô: ‚Äòapplication/json‚Äô },
body: JSON.stringify({
user_id: state.user.id,
agreement_type: type,
ip_address: ‚Äò0.0.0.0‚Äô,
user_agent: navigator.userAgent
})
});
}

closeModal();
await loadJobs();
renderApp();
showToast(‚ÄòAgreements accepted!‚Äô);
}

// =============================================================================
// DATA LOADERS
// =============================================================================
async function loadProfile() {
if (!state.user) return;

const res = await apiRequest(‚Äòusers?id=eq.‚Äô + state.user.id + ‚Äò&select=*‚Äô);
if (!res) return;

const data = await res.json();
state.profile = data?.length ? data[0] : {
id: state.user.id,
email: state.user.email,
mv_balance: 0,
jobs_completed: 0,
rating: 0,
full_name: ‚Äò‚Äô,
username: ‚Äò‚Äô,
about_me: ‚Äò‚Äô,
role: ‚Äòboth‚Äô
};
}

async function loadJobs() {
const res = await apiRequest(‚Äòjobs?status=eq.open&select=*&order=created_at.desc‚Äô);
state.jobs = (res && await res.json()) || [];
}

// =============================================================================
// ACTION: SAVE PROFILE
// =============================================================================
async function handleSaveProfile() {
const updates = {
full_name: getEl(‚Äòprofile-name‚Äô)?.value,
username: getEl(‚Äòprofile-username‚Äô)?.value,
about_me: getEl(‚Äòprofile-about‚Äô)?.value,
role: getEl(‚Äòprofile-role‚Äô)?.value,
has_vehicle: getEl(‚Äòprofile-vehicle‚Äô)?.checked
};

const res = await apiRequest(‚Äòusers?id=eq.‚Äô + state.user.id, {
method: ‚ÄòPATCH‚Äô,
headers: { ‚ÄòContent-Type‚Äô: ‚Äòapplication/json‚Äô },
body: JSON.stringify(updates)
});

if (res?.ok) {
state.profile = { ‚Ä¶state.profile, ‚Ä¶updates };
closeModal();
showToast(‚ÄòProfile saved!‚Äô);
renderProfileTab();
} else {
showToast(‚ÄòError saving profile‚Äô, ‚Äòerror‚Äô);
}
}

// =============================================================================
// ACTION: POST JOB
// =============================================================================
async function handlePostJob() {
const title = getEl(‚Äòjob-title‚Äô)?.value.trim();
const description = getEl(‚Äòjob-desc‚Äô)?.value.trim();
const jobType = getEl(‚Äòjob-type‚Äô)?.value;
const budget = parseFloat(getEl(‚Äòjob-budget‚Äô)?.value);

if (!title) return showToast(‚ÄòEnter a title‚Äô, ‚Äòerror‚Äô);
if (!jobType) return showToast(‚ÄòSelect a job type‚Äô, ‚Äòerror‚Äô);
if (!budget || budget < 1) return showToast(‚ÄòBudget must be at least 1 MV‚Äô, ‚Äòerror‚Äô);
if (budget > 10000) return showToast(‚ÄòBudget too high‚Äô, ‚Äòerror‚Äô);
if ((state.profile?.mv_balance || 0) < budget + 1) return showToast(‚ÄòNot enough MV‚Äô, ‚Äòerror‚Äô);

const res = await apiRequest(‚Äòjobs‚Äô, {
method: ‚ÄòPOST‚Äô,
headers: { ‚ÄòContent-Type‚Äô: ‚Äòapplication/json‚Äô },
body: JSON.stringify({
poster_id: state.user.id,
title: title,
description: description,
job_type: jobType,
urgency: getEl(‚Äòjob-urgency‚Äô)?.value,
budget_mv: budget,
fee_mv: 1,
total_escrowed: budget + 1,
address: getEl(‚Äòjob-address‚Äô)?.value,
status: ‚Äòopen‚Äô
})
});

if (res?.ok) {
const jobData = await res.json();
const jobId = jobData[0].id;

```
// Create escrow record
await apiRequest('escrow', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    job_id: jobId,
    poster_id: state.user.id,
    amount_mv: budget,
    fee_mv: 1,
    status: 'locked'
  })
});

// Log the burn
await apiRequest('mv_ledger', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    user_id: state.user.id,
    type: 'burn',
    amount_mv: 1,
    description: 'Job posting fee',
    tx_hash: 'BURN' + Date.now(),
    related_job_id: jobId
  })
});

// Update balance
const newBalance = (state.profile.mv_balance || 0) - (budget + 1);
await apiRequest('users?id=eq.' + state.user.id, {
  method: 'PATCH',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ mv_balance: newBalance })
});
state.profile.mv_balance = newBalance;

closeModal();
await loadJobs();
renderJobsTab();
showToast('Gig posted! ' + (budget + 1) + ' MV escrowed.');
```

} else {
showToast(‚ÄòError posting job‚Äô, ‚Äòerror‚Äô);
}
}

// =============================================================================
// ACTION: APPLY FOR JOB
// =============================================================================
async function handleApply() {
const jobId = getEl(‚Äòapply-job-id‚Äô)?.value;
const pitch = getEl(‚Äòapply-pitch‚Äô)?.value.trim();
const rate = parseFloat(getEl(‚Äòapply-rate‚Äô)?.value);
const turnaround = getEl(‚Äòapply-turnaround‚Äô)?.value.trim();

if (!pitch) return showToast(‚ÄòWrite a pitch‚Äô, ‚Äòerror‚Äô);
if (!rate || rate < 1) return showToast(‚ÄòEnter a rate‚Äô, ‚Äòerror‚Äô);
if (!turnaround) return showToast(‚ÄòEnter turnaround time‚Äô, ‚Äòerror‚Äô);

const res = await apiRequest(‚Äòapplications‚Äô, {
method: ‚ÄòPOST‚Äô,
headers: { ‚ÄòContent-Type‚Äô: ‚Äòapplication/json‚Äô },
body: JSON.stringify({
job_id: jobId,
worker_id: state.user.id,
pitch: pitch,
rate_mv: rate,
turnaround: turnaround,
status: ‚Äòpending‚Äô
})
});

if (res?.ok) {
closeModal();
showToast(‚ÄòApplication submitted!‚Äô);
} else {
showToast(‚ÄòError submitting application‚Äô, ‚Äòerror‚Äô);
}
}

// =============================================================================
// ACTION: SEND MV
// =============================================================================
async function handleSend() {
const recipient = getEl(‚Äòsend-to‚Äô)?.value.trim();
const amount = parseFloat(getEl(‚Äòsend-amount‚Äô)?.value);

if (!recipient) return showToast(‚ÄòEnter a recipient‚Äô, ‚Äòerror‚Äô);
if (!amount || amount < 1) return showToast(‚ÄòEnter an amount‚Äô, ‚Äòerror‚Äô);
if ((state.profile?.mv_balance || 0) < amount) return showToast(‚ÄòNot enough MV‚Äô, ‚Äòerror‚Äô);

// Look up recipient
const lookupRes = await apiRequest(
‚Äòusers?or=(email.eq.‚Äô + encodeURIComponent(recipient.toLowerCase()) +
‚Äò,username.eq.‚Äô + encodeURIComponent(recipient.toLowerCase()) + ‚Äò)&select=id‚Äô
);
const lookupData = (lookupRes && await lookupRes.json()) || [];
if (!lookupData.length) return showToast(‚ÄòUser not found‚Äô, ‚Äòerror‚Äô);

const recipientId = lookupData[0].id;
const txHash = ‚ÄòTX‚Äô + Date.now() + Math.random().toString(36).substr(2, 9);

// Sender ledger entry
await apiRequest(‚Äòmv_ledger‚Äô, {
method: ‚ÄòPOST‚Äô,
headers: { ‚ÄòContent-Type‚Äô: ‚Äòapplication/json‚Äô },
body: JSON.stringify({
user_id: state.user.id,
type: ‚Äòsend‚Äô,
amount_mv: amount,
description: ‚ÄôSent to ‚Äô + recipient,
tx_hash: txHash,
related_user_id: recipientId
})
});

// Receiver ledger entry
await apiRequest(‚Äòmv_ledger‚Äô, {
method: ‚ÄòPOST‚Äô,
headers: { ‚ÄòContent-Type‚Äô: ‚Äòapplication/json‚Äô },
body: JSON.stringify({
user_id: recipientId,
type: ‚Äòreceive‚Äô,
amount_mv: amount,
description: ‚ÄôReceived from ‚Äô + (state.profile?.full_name || state.user.email),
tx_hash: txHash,
related_user_id: state.user.id
})
});

// Update sender balance
const newBalance = (state.profile.mv_balance || 0) - amount;
await apiRequest(‚Äòusers?id=eq.‚Äô + state.user.id, {
method: ‚ÄòPATCH‚Äô,
headers: { ‚ÄòContent-Type‚Äô: ‚Äòapplication/json‚Äô },
body: JSON.stringify({ mv_balance: newBalance })
});

// Update receiver balance
const recipientRes = await apiRequest(‚Äòusers?id=eq.‚Äô + recipientId + ‚Äò&select=mv_balance‚Äô);
const recipientData = (recipientRes && await recipientRes.json()) || [{ mv_balance: 0 }];
const recipientNewBalance = (recipientData[0].mv_balance || 0) + amount;
await apiRequest(‚Äòusers?id=eq.‚Äô + recipientId, {
method: ‚ÄòPATCH‚Äô,
headers: { ‚ÄòContent-Type‚Äô: ‚Äòapplication/json‚Äô },
body: JSON.stringify({ mv_balance: recipientNewBalance })
});

state.profile.mv_balance = newBalance;
closeModal();
if (state.currentTab === ‚Äòwallet‚Äô) {
renderWalletTab();
loadWalletData();
}
showToast(‚ÄòSent ‚Äô + amount + ‚Äô MV!‚Äô);
}

// =============================================================================
// ACTION: CASH OUT
// =============================================================================
async function handleCashout() {
const amount = parseFloat(getEl(‚Äòcashout-amount‚Äô)?.value);

if (!amount || amount < 1) return showToast(‚ÄòEnter an amount‚Äô, ‚Äòerror‚Äô);
if ((state.profile?.mv_balance || 0) < amount) return showToast(‚ÄòNot enough MV‚Äô, ‚Äòerror‚Äô);

const fee = amount * 0.005;
const receiveAmount = amount - fee;

await apiRequest(‚Äòmv_ledger‚Äô, {
method: ‚ÄòPOST‚Äô,
headers: { ‚ÄòContent-Type‚Äô: ‚Äòapplication/json‚Äô },
body: JSON.stringify({
user_id: state.user.id,
type: ‚Äòwithdrawal‚Äô,
amount_mv: amount,
description: ‚ÄòWithdrawn $‚Äô + receiveAmount.toFixed(2),
tx_hash: ‚ÄòWD‚Äô + Date.now()
})
});

const newBalance = (state.profile.mv_balance || 0) - amount;
await apiRequest(‚Äòusers?id=eq.‚Äô + state.user.id, {
method: ‚ÄòPATCH‚Äô,
headers: { ‚ÄòContent-Type‚Äô: ‚Äòapplication/json‚Äô },
body: JSON.stringify({ mv_balance: newBalance })
});

state.profile.mv_balance = newBalance;
closeModal();
if (state.currentTab === ‚Äòwallet‚Äô) {
renderWalletTab();
loadWalletData();
}
showToast(‚ÄòWithdrawn $‚Äô + receiveAmount.toFixed(2) + ‚Äò!‚Äô);
}

// =============================================================================
// BOOT SEQUENCE
// =============================================================================
async function boot() {
// Safety timeout ‚Äî if boot takes more than 5s, show landing anyway
const bootTimeout = setTimeout(() => {
console.warn(‚ÄòBoot timeout ‚Äî showing landing‚Äô);
if (getEl(‚Äòroot‚Äô).innerHTML === ‚Äò‚Äô) {
renderLanding();
getEl(‚Äòboot-screen‚Äô).classList.add(‚Äòdone‚Äô);
}
}, 5000);

try {
// Check if Supabase loaded
if (typeof supabase === ‚Äòundefined‚Äô) {
throw new Error(‚ÄòSupabase not loaded‚Äô);
}

```
const { data: { session } } = await sb.auth.getSession();

if (session?.user) {
  // Returning user ‚Äî load data and show app
  state.user = session.user;
  state.token = session.access_token;
  await loadProfile();
  await loadJobs();
  renderApp();
} else {
  // No session ‚Äî show landing page
  renderLanding();
}
```

} catch (error) {
console.error(‚ÄòBoot error:‚Äô, error);
renderLanding();
}

clearTimeout(bootTimeout);

// Fade out boot screen
getEl(‚Äòboot-screen‚Äô).classList.add(‚Äòdone‚Äô);

// Listen for auth state changes
try {
sb.auth.onAuthStateChange((event, session) => {
if (session?.user) {
state.user = session.user;
state.token = session.access_token;
} else {
state.user = null;
state.token = null;
}
});
} catch (e) {
console.error(‚ÄòAuth listener error:‚Äô, e);
}
}

// Start the app
boot();

</script>
</body>
</html>