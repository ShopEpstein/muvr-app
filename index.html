<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MUVR - The Real-World Work Game</title>
  <meta name="description" content="MUVR: A borderless work marketplace. Keep 100%. Use MUVR Credits (MV) for in-app work flows." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --accent: #18F6C8;
      --accent-2: #7C5CFF;
      --accent-3: #FF3D9A;
      --accent-hover: #42FBE0;
      --bg-deep: #050716;
      --bg-card: rgba(14, 18, 34, 0.82);
      --bg-card2: rgba(18, 24, 44, 0.86);
      --border: rgba(255,255,255,0.10);
      --text-dim: rgba(232, 236, 241, 0.52);
      --text-mid: rgba(232, 236, 241, 0.72);
      --text-bright: rgba(232, 236, 241, 0.96);
      --red: #ff6b6b;
      --yellow: #ffd166;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: 'Outfit', system-ui, -apple-system, sans-serif;
      background: var(--bg-deep);
      color: var(--text-bright);
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* ===== Animated Background ===== */
    .bg-stage {
      position: fixed; inset: 0; z-index: -2; overflow: hidden;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(24,246,200,0.14), transparent 60%),
        radial-gradient(900px 700px at 90% 20%, rgba(124,92,255,0.14), transparent 60%),
        radial-gradient(900px 700px at 70% 90%, rgba(255,61,154,0.10), transparent 60%),
        linear-gradient(180deg, #050716, #040515 45%, #050716);
    }
    .blob {
      position: absolute; width: 520px; height: 520px;
      filter: blur(38px); opacity: 0.28; border-radius: 999px;
      mix-blend-mode: screen; animation: floaty 10s ease-in-out infinite;
    }
    .blob.b1 { background: rgba(24,246,200,0.9); left: -140px; top: -180px; animation-duration: 12s; }
    .blob.b2 { background: rgba(124,92,255,0.9); right: -180px; top: -120px; animation-duration: 14s; }
    .blob.b3 { background: rgba(255,61,154,0.8); left: 10%; bottom: -220px; animation-duration: 16s; }
    @keyframes floaty {
      0%,100% { transform: translate3d(0,0,0) scale(1); }
      50% { transform: translate3d(30px,-18px,0) scale(1.06); }
    }

    /* ===== Boot Screen ===== */
    #boot-screen {
      position: fixed; inset: 0; z-index: 10000;
      background: rgba(5, 7, 22, 0.96);
      display: flex; align-items: center; justify-content: center;
      transition: opacity 0.45s ease, visibility 0.45s ease;
    }
    #boot-screen.done { opacity: 0; visibility: hidden; pointer-events: none; }
    .boot-spinner {
      width: 44px; height: 44px;
      border: 3px solid rgba(255,255,255,0.14);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== Transitions ===== */
    .fade-up { animation: fadeUpIn 0.5s ease both; }
    .fade-up.d1 { animation-delay: 0.06s; }
    .fade-up.d2 { animation-delay: 0.12s; }
    .fade-up.d3 { animation-delay: 0.18s; }
    .fade-up.d4 { animation-delay: 0.24s; }
    @keyframes fadeUpIn {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== Fields ===== */
    .field {
      width: 100%;
      background: rgba(12, 16, 30, 0.88);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 14px;
      color: var(--text-bright);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }
    .field:focus {
      outline: none;
      border-color: rgba(24,246,200,0.65);
      box-shadow: 0 0 0 6px rgba(24,246,200,0.10), 0 12px 34px rgba(0,0,0,0.22);
    }
    .field::placeholder { color: rgba(232,236,241,0.38); }

    /* ===== Buttons ===== */
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), rgba(24,246,200,0.65));
      color: #00110B; font-weight: 900; border: none; border-radius: 14px;
      padding: 14px 18px; font-size: 14px; cursor: pointer; width: 100%;
      transition: transform 0.12s ease, filter 0.12s ease, box-shadow 0.12s ease;
      box-shadow: 0 14px 40px rgba(24,246,200,0.14);
      letter-spacing: 0.2px; text-transform: uppercase;
    }
    .btn-primary:hover { filter: brightness(1.06); transform: translateY(-1px); }
    .btn-primary:active { transform: translateY(0) scale(0.99); }
    .btn-primary:disabled { background: rgba(255,255,255,0.08); color: rgba(232,236,241,0.45); cursor: not-allowed; box-shadow: none; }

    .btn-secondary {
      background: rgba(255,255,255,0.06); color: var(--text-bright); font-weight: 800;
      border: 1px solid var(--border); border-radius: 14px; padding: 14px 18px;
      font-size: 14px; cursor: pointer; width: 100%;
      transition: transform 0.12s ease, background 0.12s ease, border-color 0.12s ease;
      letter-spacing: 0.2px; text-transform: uppercase;
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.09); border-color: rgba(255,255,255,0.16); transform: translateY(-1px); }
    .btn-secondary:active { transform: translateY(0); }

    .btn-pill {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 10px 18px; border-radius: 999px; font-size: 13px; font-weight: 900;
      cursor: pointer; border: none;
      transition: transform 0.12s ease, background 0.12s ease, border-color 0.12s ease, filter 0.12s ease;
      letter-spacing: 0.2px; white-space: nowrap; text-transform: uppercase;
    }
    .btn-pill-accent { background: rgba(24,246,200,0.92); color: #00110B; box-shadow: 0 14px 40px rgba(24,246,200,0.10); }
    .btn-pill-accent:hover { filter: brightness(1.06); transform: translateY(-1px); }
    .btn-pill-ghost { background: rgba(255,255,255,0.06); color: rgba(232,236,241,0.75); border: 1px solid rgba(255,255,255,0.10); }
    .btn-pill-ghost:hover { background: rgba(255,255,255,0.09); border-color: rgba(255,255,255,0.16); transform: translateY(-1px); }
    .btn-pill-ghost.active { background: rgba(24,246,200,0.92); color: #00110B; border-color: rgba(24,246,200,0.92); }

    .btn-sm {
      padding: 8px 14px; border-radius: 12px; font-size: 12px; font-weight: 800;
      cursor: pointer; border: 1px solid var(--border); background: rgba(255,255,255,0.06);
      color: rgba(232,236,241,0.75); transition: all 0.12s ease; text-transform: uppercase;
    }
    .btn-sm:hover { background: rgba(255,255,255,0.10); transform: translateY(-1px); }

    /* ===== Cards ===== */
    .card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 18px; box-shadow: 0 20px 60px rgba(0,0,0,0.18);
      backdrop-filter: blur(12px);
    }
    .card-interactive { transition: transform 0.18s ease, border-color 0.18s ease, filter 0.18s ease; }
    .card-interactive:hover { border-color: rgba(24,246,200,0.35); transform: translateY(-2px); filter: brightness(1.02); }

    /* ===== Modal ===== */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(4, 6, 14, 0.80); backdrop-filter: blur(16px);
      display: flex; align-items: center; justify-content: center; padding: 1rem;
      opacity: 0; visibility: hidden;
      transition: opacity 0.25s ease, visibility 0.25s ease;
    }
    .modal-overlay.open { opacity: 1; visibility: visible; }
    .modal-overlay .modal-body { transform: translateY(14px) scale(0.97); transition: transform 0.25s ease; }
    .modal-overlay.open .modal-body { transform: translateY(0) scale(1); }
    .close-btn {
      color: rgba(232,236,241,0.55); background: none; border: none; cursor: pointer;
      font-size: 22px; line-height: 1; transition: color 0.15s ease, transform 0.15s ease;
    }
    .close-btn:hover { color: rgba(232,236,241,0.95); transform: rotate(6deg); }

    /* ===== Toast ===== */
    #toast-container {
      position: fixed; top: 16px; right: 16px; z-index: 9999;
      display: flex; flex-direction: column; gap: 10px; pointer-events: none;
    }
    .toast {
      padding: 14px 18px; border-radius: 16px; font-size: 13px; font-weight: 800;
      animation: toastSlide 0.28s ease; max-width: 360px;
      backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08);
      pointer-events: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.24);
    }
    .toast-success { background: rgba(6, 95, 70, 0.90); color: #9ff7d5; }
    .toast-error { background: rgba(127, 29, 29, 0.90); color: #ffd2d2; }
    .toast-info { background: rgba(20, 40, 70, 0.90); color: #c9ddff; }
    @keyframes toastSlide {
      from { transform: translateX(16px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* ===== Nav Tabs ===== */
    .desktop-tab {
      background: none; border: none; color: rgba(232,236,241,0.55);
      font-size: 11px; font-weight: 900; letter-spacing: 0.3px; cursor: pointer;
      padding: 6px 0; border-bottom: 2px solid transparent;
      transition: color 0.15s, border-color 0.15s; text-transform: uppercase;
    }
    .desktop-tab:hover { color: rgba(232,236,241,0.85); }
    .desktop-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .mobile-tab {
      background: none; border: none; color: rgba(232,236,241,0.45);
      font-size: 10px; font-weight: 800; display: flex; flex-direction: column;
      align-items: center; gap: 4px; cursor: pointer; padding: 4px 8px;
      transition: color 0.15s; text-transform: uppercase;
      position: relative;
    }
    .mobile-tab.active { color: var(--accent); }
    .tab-badge {
      position: absolute; top: -2px; right: 2px; width: 8px; height: 8px;
      background: var(--accent-3); border-radius: 50%;
      border: 2px solid rgba(10, 12, 26, 0.82);
    }

    /* ===== Ticker ===== */
    .ticker-scroll { animation: tickerMove 22s linear infinite; }
    @keyframes tickerMove { to { transform: translateX(-50%); } }

    /* ===== Messaging ===== */
    .msg-bubble {
      max-width: 80%; padding: 10px 14px; border-radius: 16px;
      font-size: 13px; line-height: 1.45; word-wrap: break-word;
    }
    .msg-mine {
      background: rgba(24,246,200,0.15); border: 1px solid rgba(24,246,200,0.25);
      margin-left: auto; border-bottom-right-radius: 4px;
    }
    .msg-theirs {
      background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10);
      margin-right: auto; border-bottom-left-radius: 4px;
    }
    .msg-list {
      max-height: 55vh; overflow-y: auto; padding: 8px 4px;
      scroll-behavior: smooth;
    }

    /* ===== Map ===== */
    #map-container { height: 420px; border-radius: 18px; overflow: hidden; border: 1px solid var(--border); }
    .leaflet-container { background: #0a0e1a !important; }
    .pulse-dot {
      width: 14px; height: 14px; border-radius: 50%; position: relative;
      box-shadow: 0 0 8px currentColor;
    }
    .pulse-dot::after {
      content: ''; position: absolute; inset: -5px; border-radius: 50%;
      border: 2px solid currentColor; opacity: 0.5;
      animation: pulsering 2s ease-in-out infinite;
    }
    @keyframes pulsering {
      0%,100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.8); opacity: 0; }
    }
    .map-legend-dot {
      width: 12px; height: 12px; border-radius: 50%; display: inline-block;
    }

    /* ===== Ledger ===== */
    .ledger-event { animation: ledgerSlide 0.3s ease; }
    @keyframes ledgerSlide {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .live-dot {
      width: 8px; height: 8px; background: #ff3d3d; border-radius: 50%;
      display: inline-block; animation: livepulse 1.5s ease-in-out infinite;
    }
    @keyframes livepulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* ===== Misc ===== */
    .mono { font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .hero-gradient {
      background: linear-gradient(135deg, var(--accent), var(--accent-2), var(--accent-3));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .line-clamp-2 {
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .avatar-ring {
      width: 48px; height: 48px; border-radius: 50%; display: grid; place-items: center;
      background: linear-gradient(135deg, rgba(24,246,200,0.2), rgba(124,92,255,0.2));
      border: 2px solid rgba(24,246,200,0.4);
    }
    .avatar-ring-lg {
      width: 64px; height: 64px; border-radius: 50%; display: grid; place-items: center;
      background: linear-gradient(135deg, rgba(24,246,200,0.2), rgba(124,92,255,0.2));
      border: 2px solid rgba(24,246,200,0.4);
    }
    .stat-card {
      padding: 12px; border-radius: 16px;
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.10);
      text-align: center;
    }

    @keyframes confettiPop {
      0% { opacity: 1; }
      100% { opacity: 0; transform: translate(var(--tx,50px), var(--ty,-120px)) rotate(720deg); }
    }
    .confetti-burst { animation: confettiBurst 0.6s ease; }
    @keyframes confettiBurst {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    @media (max-width: 640px) {
      #map-container { height: 300px; }
    }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.16); border-radius: 3px; }

    /* ===== MUXI FAB ===== */
    #muxi-fab {
      position: fixed; bottom: 24px; right: 24px; z-index: 100;
      width: 56px; height: 56px; border-radius: 50%;
      background: rgba(14, 18, 34, 0.92); border: 1px solid rgba(24,246,200,0.3);
      display: grid; place-items: center; cursor: pointer;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      transition: transform 0.2s ease, border-color 0.2s ease;
      animation: floaty 4s ease-in-out infinite;
    }
    #muxi-fab:hover { transform: scale(1.08); border-color: rgba(24,246,200,0.6); }
    #muxi-bubble {
      position: fixed; bottom: 90px; right: 20px; z-index: 101;
      background: rgba(14, 18, 34, 0.95); border: 1px solid rgba(24,246,200,0.25);
      border-radius: 18px; padding: 16px; max-width: 280px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.5); backdrop-filter: blur(12px);
      opacity: 0; visibility: hidden; transform: translateY(8px);
      transition: opacity 0.25s ease, visibility 0.25s ease, transform 0.25s ease;
    }
    #muxi-bubble.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .muxi-tap-counter { display: none; }
  </style>
</head>
<body>
  <div class="bg-stage" aria-hidden="true">
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div class="blob b3"></div>
  </div>

  <div id="boot-screen" style="background:rgba(5,7,22,0.96)">
    <div style="text-align:center">
      <div class="boot-spinner" style="margin:0 auto 14px"></div>
      <div style="font-size:20px;font-weight:900;letter-spacing:-0.4px">
        <span style="color:var(--accent)">M</span>U<span style="color:var(--accent)">V</span>R
      </div>
      <div style="margin-top:10px;font-size:11px;font-weight:800;color:rgba(232,236,241,0.60);letter-spacing:0.24px;text-transform:uppercase">
        Loading the network
      </div>
    </div>
  </div>

  <div id="toast-container"></div>
  <div id="root"></div>
  <div id="modal-layer"></div>

<script>
/* =============================================================================
   SUPABASE CONFIG
============================================================================= */
var SUPA_URL = 'https://cfenkstusggrcthehffn.supabase.co';
var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmZW5rc3R1c2dncmN0aGVoZmZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMTIyNTMsImV4cCI6MjA4NzU4ODI1M30.XcZKrytjAnju05w_7ly7j4bsnwLK08kBoXAhi3xYV5o';

var sb = null;
try {
  sb = supabase.createClient(SUPA_URL, SUPA_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });
} catch(e) { console.error('Supabase init failed:', e); }

/* =============================================================================
   STATE
============================================================================= */
var state = {
  user: null,
  accessToken: null,
  profile: null,
  jobs: [],
  jobFilter: 'all',
  balanceVisible: false,
  currentTab: 'jobs',
  conversations: [],
  activeConvoId: null,
  activeMessages: [],
  mapObj: null,
  myPresence: { status: 'offline', lat: null, lng: null },
  publicEvents: [],
  ledgerFilter: 'all',
  realtimeSubs: [],
  unreadMsgCount: 0,
  presenceInterval: null,
  notifications: []
};


function forceHideBoot(reason) {
  var bs = getEl('boot-screen');
  if (!bs) return;
  bs.classList.add('done');
  if (reason) console.warn('[boot] forced hide:', reason);
}
setTimeout(function() { forceHideBoot('timeout'); }, 900);

window.addEventListener('error', function(e) {
  console.error('[window.error]', e && e.message, e && e.filename, e && e.lineno);
  try { showToast('UI error caught. MUXI is investigating.', 'error'); } catch(x) {}
  forceHideBoot('window.error');
});
window.addEventListener('unhandledrejection', function(e) {
  console.error('[unhandledrejection]', e && e.reason);
  forceHideBoot('unhandledrejection');
});

/* =============================================================================
   HELPERS
============================================================================= */
var getEl = function(id) { return document.getElementById(id); };

function escapeHtml(str) {
  var div = document.createElement('div');
  div.textContent = (str == null ? '' : String(str));
  return div.innerHTML;
}


function formatTime(iso) {
  if (!iso) return '';
  try { return new Date(iso).toLocaleString(); } catch(e) { return ''; }
}

function formatRelative(iso) {
  if (!iso) return '';
  try {
    var d = new Date(iso);
    var now = new Date();
    var diff = Math.floor((now - d) / 1000);
    if (diff < 60) return 'just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return Math.floor(diff / 86400) + 'd ago';
  } catch(e) { return ''; }
}
function withTimeout(promise, ms, label) {
  var t;
  var timeout = new Promise(function(_, reject) {
    t = setTimeout(function() { reject(new Error('timeout:' + (label || ''))); }, ms);
  });
  return Promise.race([promise, timeout]).finally(function() { clearTimeout(t); });
}

function relTime(dateStr) {
  if (!dateStr) return '';
  var d = new Date(dateStr);
  var now = Date.now();
  var diff = Math.floor((now - d.getTime()) / 1000);
  if (diff < 60) return 'just now';
  if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  return d.toLocaleDateString();
}

function showToast(message, type) {
  type = type || 'success';
  var c = getEl('toast-container');
  if (!c) return;
  var t = document.createElement('div');
  t.className = 'toast toast-' + type;
  t.textContent = message;
  c.appendChild(t);
  setTimeout(function() {
    t.style.opacity = '0';
    t.style.transition = 'opacity 0.25s';
    setTimeout(function() { t.remove(); }, 260);
  }, 3200);
}

/* =============================================================================
   API REQUEST HELPER
============================================================================= */
async function apiRequest(path, options) {
  options = options || {};
  if (!sb) return null;
  try {
    if (!state.accessToken) {
      var sess = await sb.auth.getSession();
      state.accessToken = (sess.data.session && sess.data.session.access_token) || null;
    }
    if (!state.accessToken) return null;
    var headers = Object.assign({
      'apikey': SUPA_KEY,
      'Authorization': 'Bearer ' + state.accessToken
    }, options.headers || {});
    if (!headers['Content-Type'] && options.body) headers['Content-Type'] = 'application/json';
    if (!headers['Prefer'] && options.method === 'POST') headers['Prefer'] = 'return=representation';
    return await fetch(SUPA_URL + '/rest/v1/' + path, Object.assign({}, options, { headers: headers }));
  } catch(err) { console.error('apiRequest:', err); return null; }
}

/* =============================================================================
   MODAL SYSTEM
============================================================================= */
function openModal(html, opts) {
  opts = opts || {};
  var layer = getEl('modal-layer');
  if (!layer) return;
  var w = opts.width || 'max-w-sm';
  layer.innerHTML = '<div class="modal-overlay" id="active-modal"><div class="modal-body w-full ' + w + ' mx-auto" style="max-height:92vh;overflow-y:auto">' + html + '</div></div>';
  requestAnimationFrame(function() {
    var m = getEl('active-modal');
    if (m) m.classList.add('open');
  });
  if (!opts.locked) {
    var m = getEl('active-modal');
    if (m) m.addEventListener('click', function(e) { if (e.target === m) closeModal(); });
  }
}

function closeModal() {
  var m = getEl('active-modal');
  if (!m) return;
  m.classList.remove('open');
  setTimeout(function() {
    var l = getEl('modal-layer');
    if (l) l.innerHTML = '';
  }, 260);
}

/* =============================================================================
   MUXI DONKEY SVG
============================================================================= */
function muxiSVG(size) {
  size = size || 52;
  return '<svg width="' + size + '" height="' + size + '" viewBox="0 0 64 64" fill="none">' +
    '<path d="M18 20 L12 10 L22 14" stroke="rgba(232,236,241,0.92)" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>' +
    '<path d="M46 20 L52 10 L42 14" stroke="rgba(232,236,241,0.92)" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>' +
    '<path d="M18 20 C18 14, 46 14, 46 20" stroke="rgba(232,236,241,0.92)" stroke-width="2.4" stroke-linecap="round"/>' +
    '<path d="M16 22 C14 34, 18 48, 32 50 C46 48, 50 34, 48 22" stroke="rgba(232,236,241,0.92)" stroke-width="2.4" stroke-linecap="round"/>' +
    '<circle cx="24" cy="34" r="3" fill="rgba(24,246,200,0.95)"/>' +
    '<circle cx="40" cy="34" r="3" fill="rgba(24,246,200,0.95)"/>' +
    '<path d="M28 44 C30 46, 34 46, 36 44" stroke="rgba(232,236,241,0.62)" stroke-width="2.4" stroke-linecap="round"/>' +
    '</svg>';
}

function brandMark(sizeClass) {
  sizeClass = sizeClass || 'text-5xl';
  return '<div class="inline-flex items-center gap-3">' +
    '<div class="relative">' +
      '<div class="absolute -inset-2 blur-2xl opacity-40" style="background:radial-gradient(circle at 30% 30%,rgba(24,246,200,0.6),transparent 60%),radial-gradient(circle at 70% 50%,rgba(124,92,255,0.4),transparent 60%)"></div>' +
      '<div class="' + sizeClass + ' font-black tracking-tight relative"><span style="color:var(--accent)">M</span>U<span style="color:var(--accent)">V</span>R</div>' +
    '</div>' +
    '<span class="text-[10px] font-black px-3 py-1 rounded-full" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.10);color:rgba(232,236,241,0.85);letter-spacing:0.22px">WORK GAME</span>' +
  '</div>';
}


/* =============================================================================
   RENDER: LANDING PAGE
============================================================================= */
function renderLanding() {
  var root = getEl('root');
  if (!root) return;

  root.innerHTML = '<div class="fade-up">' +
    '<div style="background:rgba(180,30,30,0.82)" class="text-center py-2 text-[10px] font-black tracking-widest">' +
      'MUVR IS A MARKETPLACE ONLY - NOT AN EMPLOYER - ALL WORKERS ARE INDEPENDENT CONTRACTORS' +
    '</div>' +

    /* Hero */
    '<section class="max-w-5xl mx-auto px-5 pt-14 sm:pt-20 pb-10 text-center">' +
      '<div class="fade-up d1 flex items-center justify-center gap-4 mb-6">' +
        '<div class="w-16 h-16 rounded-2xl grid place-items-center" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10)">' + muxiSVG(48) + '</div>' +
        brandMark('text-5xl sm:text-6xl') +
      '</div>' +
      '<div class="fade-up d2 text-4xl sm:text-6xl font-black leading-tight mb-5">' +
        'Work. Earn. <span class="hero-gradient">Level Up.</span>' +
      '</div>' +
      '<p class="fade-up d3 text-base sm:text-lg max-w-2xl mx-auto mb-8" style="color:var(--text-mid)">' +
        'A borderless on-demand marketplace for real-world labor + digital work. Keep 100% of what you earn. Use <strong>MUVR Credits (MV)</strong> - in-platform credits for escrowed work flows.' +
      '</p>' +
      '<div class="fade-up d4 flex flex-col sm:flex-row gap-3 justify-center max-w-lg mx-auto">' +
        '<button onclick="openAuthModal()" class="btn-primary text-base py-4 rounded-full">ENTER THE NETWORK</button>' +
        '<button onclick="switchPublicLedger()" class="btn-secondary text-base py-4 rounded-full">VIEW LIVE LEDGER</button>' +
        '<button onclick="renderBlogPage()" class="btn-secondary text-base py-4 rounded-full" style="border-color:rgba(124,92,255,0.3)">BLOG</button>' +
      '</div>' +
      '<div class="fade-up d4 mt-6 flex flex-wrap items-center justify-center gap-2 text-[11px] font-bold" style="color:rgba(232,236,241,0.62)">' +
        '<span class="mono px-2 py-1 rounded-full" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10)">0% commission</span>' +
        '<span class="mono px-2 py-1 rounded-full" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10)">escrow protection</span>' +
        '<span class="mono px-2 py-1 rounded-full" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10)">realtime updates</span>' +
        '<span class="mono px-2 py-1 rounded-full" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10)">MV credits</span>' +
      '</div>' +
    '</section>' +

    /* Value Props */
    '<section class="max-w-6xl mx-auto px-5 py-10 grid grid-cols-1 md:grid-cols-3 gap-5">' +
      landingCard('&#127918;', 'The Real-World Work Game', 'Earn XP, build rank, unlock status. Work is the quest. Reputation is the scoreboard. Every completed gig pushes you up the leaderboard.') +
      landingCard('&#129688;', 'Keep 100%', 'No commission on worker earnings. The platform is built to minimize extraction. Your work, your money, your level.') +
      landingCard('&#128274;', 'Escrow-first', 'Funds are locked before work begins and released when complete. Built-in dispute controls protect both sides of every gig.') +
    '</section>' +

    /* How It Works */
    '<section class="max-w-5xl mx-auto px-5 py-10">' +
      '<div class="card p-6 sm:p-8">' +
        '<h2 class="text-2xl sm:text-3xl font-black mb-2">How it works</h2>' +
        '<p class="text-sm mb-6" style="color:var(--text-mid)">Four steps from sign up to getting paid. Simple, transparent, fast.</p>' +
        '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">' +
          howStep('1', '&#128221;', 'Post or Apply', 'Create a gig with a budget, or browse open gigs and submit your pitch. Set your rate and turnaround time.') +
          howStep('2', '&#128274;', 'Escrow Locks', 'When a gig is posted, the full budget + posting fee locks in escrow. This protects both parties before work begins.') +
          howStep('3', '&#9989;', 'Work Complete', 'Mark the job complete. The poster confirms delivery. Escrow funds release instantly to the worker.') +
          howStep('4', '&#127937;', 'Level Up', 'Earn XP for every completed gig. Climb the ranks from Runner to Mythic. Higher rank = more visibility.') +
        '</div>' +
      '</div>' +
    '</section>' +

    /* Comparison */
    '<section class="max-w-5xl mx-auto px-5 py-10">' +
      '<div class="card p-6 sm:p-8">' +
        '<h2 class="text-2xl font-black mb-4">MUVR vs Traditional Platforms</h2>' +
        '<div class="overflow-x-auto">' +
          '<table class="w-full text-sm">' +
            '<thead><tr style="border-bottom:1px solid rgba(255,255,255,0.10)">' +
              '<th class="text-left py-3 font-black" style="color:rgba(232,236,241,0.55)">Feature</th>' +
              '<th class="text-center py-3 font-black" style="color:var(--accent)">MUVR</th>' +
              '<th class="text-center py-3 font-black" style="color:rgba(232,236,241,0.55)">Others</th>' +
            '</tr></thead>' +
            '<tbody>' +
              compRow('Commission', '0%', '15-30%') +
              compRow('Payment Speed', 'Instant release', '3-7 days') +
              compRow('Escrow Protection', 'Built-in', 'Varies') +
              compRow('Rewards / Credits', 'MV Credits + XP', 'None') +
              compRow('Transparency', 'Public ledger', 'Opaque') +
              compRow('Worker Control', '100%', 'Limited') +
            '</tbody>' +
          '</table>' +
        '</div>' +
      '</div>' +
    '</section>' +

    /* MV Credits Explanation */
    '<section class="max-w-4xl mx-auto px-5 py-10">' +
      '<div class="card p-6 sm:p-8">' +
        '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">' +
          '<div>' +
            '<h2 class="text-2xl font-black mb-3">MUVR Credits (MV)</h2>' +
            '<p class="text-sm mb-4" style="color:var(--text-mid)">In-platform credits used for posting, escrow, transfers, and settlement flows. MV are denominated as 1 credit = 1 USD-equivalent unit INSIDE the app for pricing.</p>' +
            '<div class="space-y-3">' +
              mvFeature('Capped Supply', '100 million MV total. No inflation. Credits consumed (burned) on job posting reduce circulating supply over time.') +
              mvFeature('Escrow Flow', 'Budget + 1 MV fee locks when posting. Releases to worker on completion. The 1 MV fee is permanently burned.') +
              mvFeature('Send & Receive', 'Transfer MV to any user by @handle, email, or public alias. All transfers are logged in the public ledger.') +
            '</div>' +
          '</div>' +
          '<div>' +
            '<div class="card p-5 h-full" style="background:rgba(24,246,200,0.06);border-color:rgba(24,246,200,0.18)">' +
              '<div class="text-[11px] font-black tracking-widest mb-3" style="color:rgba(232,236,241,0.55)">NETWORK STATS</div>' +
              '<div class="space-y-4">' +
                netStat('Total Cap', '100,000,000 MV', 'var(--accent)') +
                netStat('Posting Fee', '1 MV (burned)', 'var(--red)') +
                netStat('Worker Commission', '0%', 'var(--accent)') +
                netStat('Payout Fee', '0.5% (beta)', 'var(--yellow)') +
              '</div>' +
              '<div class="mt-5 text-[11px]" style="color:rgba(232,236,241,0.55)">Withdrawals, if enabled, are subject to verification and provider terms.</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="mt-6 p-4 rounded-2xl" style="background:rgba(24,246,200,0.08);border:1px solid rgba(24,246,200,0.18)">' +
          '<div class="text-[11px] font-black tracking-widest" style="color:rgba(232,236,241,0.70)">LEGAL NOTE</div>' +
          '<div class="text-sm mt-2" style="color:rgba(232,236,241,0.78)"><strong>MUVR Credits (MV)</strong> are platform-limited digital credits used solely within MUVR for marketplace features. They are not currency, cryptocurrency, or financial instruments.</div>' +
        '</div>' +
      '</div>' +
    '</section>' +

    /* Footer */
    '<footer class="py-12 text-center text-xs" style="color:rgba(232,236,241,0.52)">' +
      '<div class="max-w-4xl mx-auto px-5">' +
        '<div class="mb-3">' + muxiSVG(32) + '</div>' +
        '<div class="mb-2 font-bold" style="color:rgba(232,236,241,0.70)">MUVR is operated by TransBid LLC (Delaware, USA)</div>' +
        '<div class="mb-4">MUVR Credits (MV) are platform-limited digital credits used solely within MUVR. Not currency, cryptocurrency, or financial instruments.</div>' +
        '<div style="color:rgba(232,236,241,0.38)">2026 TransBid LLC. All rights reserved.</div>' +
      '</div>' +
    '</footer>' +
  '</div>';
}

/* Landing page helpers */
function landingCard(icon, title, desc) {
  return '<div class="card card-interactive p-7 text-left">' +
    '<div class="text-3xl mb-3">' + icon + '</div>' +
    '<p class="font-black text-lg mb-2">' + title + '</p>' +
    '<p class="text-sm leading-relaxed" style="color:var(--text-dim)">' + desc + '</p>' +
  '</div>';
}

function howStep(num, icon, title, desc) {
  return '<div class="p-4 rounded-2xl text-left" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.10)">' +
    '<div class="flex items-center gap-2 mb-2">' +
      '<span class="w-6 h-6 rounded-full grid place-items-center text-[10px] font-black" style="background:var(--accent);color:#00110B">' + num + '</span>' +
      '<span class="text-xl">' + icon + '</span>' +
    '</div>' +
    '<div class="font-black mb-1">' + title + '</div>' +
    '<div class="text-xs leading-relaxed" style="color:var(--text-dim)">' + desc + '</div>' +
  '</div>';
}

function compRow(feature, muvr, other) {
  return '<tr style="border-bottom:1px solid rgba(255,255,255,0.06)">' +
    '<td class="py-3 font-bold">' + feature + '</td>' +
    '<td class="py-3 text-center font-black" style="color:var(--accent)">' + muvr + '</td>' +
    '<td class="py-3 text-center" style="color:var(--text-dim)">' + other + '</td>' +
  '</tr>';
}

function mvFeature(title, desc) {
  return '<div class="p-3 rounded-xl" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08)">' +
    '<p class="font-black text-sm mb-1">' + title + '</p>' +
    '<p class="text-xs" style="color:var(--text-dim)">' + desc + '</p>' +
  '</div>';
}

function netStat(label, val, color) {
  return '<div class="flex justify-between items-center">' +
    '<span class="text-sm" style="color:rgba(232,236,241,0.65)">' + label + '</span>' +
    '<span class="mono font-black text-sm" style="color:' + color + '">' + val + '</span>' +
  '</div>';
}

function switchPublicLedger() {
  if (state.user) { switchTab('ledger'); return; }
  var root = getEl('root');
  if (!root) return;
  root.innerHTML = '<div class="fade-up"><div class="max-w-4xl mx-auto px-5 py-8">' +
    '<div class="flex items-center justify-between mb-6">' +
      '<div class="flex items-center gap-3">' +
        '<div class="text-2xl font-black"><span style="color:var(--accent)">M</span>U<span style="color:var(--accent)">V</span>R</div>' +
        '<span class="text-[10px] font-black px-2 py-1 rounded-full" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10)">PUBLIC LEDGER</span>' +
      '</div>' +
      '<div class="flex gap-2">' +
        '<button onclick="openAuthModal()" class="btn-pill btn-pill-accent">Sign In</button>' +
        '<button onclick="renderLanding()" class="btn-pill btn-pill-ghost">Back</button>' +
      '</div>' +
    '</div>' +
    '<div id="public-ledger-content"></div>' +
  '</div></div>';
  renderLedgerContent('public-ledger-content');
  loadPublicEvents();
}


/* =============================================================================
   RENDER: APP SHELL (6 Tabs)
============================================================================= */
function renderApp() {
  var root = getEl('root');
  if (!root) return;

  root.innerHTML = '<div class="fade-up">' +
    /* Disclaimer */
    '<div style="background:rgba(180,30,30,0.82)" class="text-center py-2 text-[10px] font-black tracking-widest">' +
      'MUVR IS A MARKETPLACE ONLY - NOT AN EMPLOYER - ALL WORKERS ARE INDEPENDENT CONTRACTORS' +
    '</div>' +

    /* Header */
    '<header class="sticky top-0 z-50" style="border-bottom:1px solid rgba(255,255,255,0.10);background:rgba(10,12,26,0.72);backdrop-filter:blur(16px)">' +
      '<div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">' +
        '<div class="flex items-center gap-2 cursor-pointer" onclick="switchTab(\'jobs\')">' +
          '<div class="w-9 h-9 rounded-2xl grid place-items-center" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10)">' + muxiSVG(24) + '</div>' +
          '<div>' +
            '<div class="text-lg font-black tracking-tight"><span style="color:var(--accent)">M</span>U<span style="color:var(--accent)">V</span>R</div>' +
            '<div class="text-[10px] font-bold" style="color:rgba(232,236,241,0.55);letter-spacing:0.22px;text-transform:uppercase">The real-world work game</div>' +
          '</div>' +
        '</div>' +
        '<nav class="hidden sm:flex gap-5">' +
          '<button onclick="switchTab(\'jobs\')" class="desktop-tab active" data-tab="jobs">GIGS</button>' +
          '<button onclick="switchTab(\'messages\')" class="desktop-tab" data-tab="messages">MESSAGES</button>' +
          '<button onclick="switchTab(\'map\')" class="desktop-tab" data-tab="map">MAP</button>' +
          '<button onclick="switchTab(\'wallet\')" class="desktop-tab" data-tab="wallet">CREDITS</button>' +
          '<button onclick="switchTab(\'ledger\')" class="desktop-tab" data-tab="ledger">LEDGER</button>' +
          '<button onclick="switchTab(\'profile\')" class="desktop-tab" data-tab="profile">ME</button>' +
        '</nav>' +
        '<button onclick="handleLogout()" class="text-xs font-black cursor-pointer" style="color:rgba(232,236,241,0.62);background:none;border:none;text-transform:uppercase;letter-spacing:0.2px">Sign out</button>' +
      '</div>' +
      /* Ticker */
      '<div class="py-1 overflow-hidden" style="background:rgba(0,0,0,0.55);border-top:1px solid rgba(255,255,255,0.06)">' +
        '<div class="ticker-scroll whitespace-nowrap flex gap-8 text-[10px] mono tracking-wider" style="color:rgba(24,246,200,0.95)">' +
          '<span>0% COMMISSION - MUVR CREDITS (MV) - ESCROW-FIRST - REALTIME UPDATES - LEVEL UP WITH XP</span>' +
          '<span>0% COMMISSION - MUVR CREDITS (MV) - ESCROW-FIRST - REALTIME UPDATES - LEVEL UP WITH XP</span>' +
        '</div>' +
      '</div>' +
    '</header>' +

    /* Main content area */
    '<main class="max-w-6xl mx-auto px-4 py-6 pb-28 sm:pb-8"><div id="tab-content"></div></main>' +

    /* Mobile bottom nav */
    '<div class="sm:hidden fixed bottom-0 left-0 right-0 z-50" style="background:rgba(10,12,26,0.88);border-top:1px solid rgba(255,255,255,0.10);backdrop-filter:blur(16px)">' +
      '<div class="flex justify-around py-2">' +
        '<button onclick="switchTab(\'jobs\')" class="mobile-tab active" data-tab="jobs"><i class="fas fa-briefcase text-base"></i>Gigs</button>' +
        '<button onclick="switchTab(\'messages\')" class="mobile-tab" data-tab="messages"><i class="fas fa-comment text-base"></i>Msgs</button>' +
        '<button onclick="switchTab(\'map\')" class="mobile-tab" data-tab="map"><i class="fas fa-map-marked-alt text-base"></i>Map</button>' +
        '<button onclick="switchTab(\'wallet\')" class="mobile-tab" data-tab="wallet"><i class="fas fa-coins text-base"></i>MV</button>' +
        '<button onclick="switchTab(\'profile\')" class="mobile-tab" data-tab="profile"><i class="fas fa-user text-base"></i>Me</button>' +
      '</div>' +
    '</div>' +
  '</div>';

  switchTab('jobs');
}

/* =============================================================================
   TAB SWITCHING
============================================================================= */
function switchTab(name) {
  state.currentTab = name;
  document.querySelectorAll('.desktop-tab').forEach(function(b) { b.classList.remove('active'); });
  document.querySelectorAll('.mobile-tab').forEach(function(b) { b.classList.remove('active'); });
  document.querySelectorAll('[data-tab="' + name + '"]').forEach(function(b) { b.classList.add('active'); });

  if (name === 'jobs') { renderJobsTab(); loadJobsSafe(); }
  else if (name === 'messages') { renderMessagesTab(); loadConversations(); }
  else if (name === 'map') renderMapTab();
  else if (name === 'wallet') { renderWalletTab(); loadWalletData(); }
  else if (name === 'ledger') { renderLedgerTab(); loadPublicEvents(); }
  else if (name === 'profile') renderProfileTab();
}

/* =============================================================================
   JOBS TAB
============================================================================= */
function renderJobsTab() {
  var c = getEl('tab-content');
  if (!c) return;

  var cats = [
    {k:'all',l:'All',icon:'&#128300;'},
    {k:'rideshare',l:'Rideshare',icon:'&#128663;'},
    {k:'delivery',l:'Delivery',icon:'&#128230;'},
    {k:'physical',l:'Labor',icon:'&#128170;'},
    {k:'digital',l:'Digital',icon:'&#128187;'}
  ];

  var filtered = state.jobFilter === 'all' ? state.jobs : state.jobs.filter(function(j) { return j.category === state.jobFilter; });

  var btns = cats.map(function(cat) {
    return '<button onclick="state.jobFilter=\'' + cat.k + '\';renderJobsTab()" class="btn-pill ' + (state.jobFilter === cat.k ? 'btn-pill-accent' : 'btn-pill-ghost') + '">' + cat.icon + ' ' + cat.l + '</button>';
  }).join('');

  var cards = '';
  if (filtered.length === 0) {
    cards = '<div class="col-span-full text-center py-16" style="color:rgba(232,236,241,0.55)">' +
      '<div class="mb-4">' + muxiSVG(64) + '</div>' +
      '<p class="font-black text-lg mb-1">No gigs here yet</p>' +
      '<p class="text-sm" style="color:var(--text-dim)">Muxi says: be the first to post one. The early bird gets the XP.</p>' +
      '<div class="mt-6 max-w-sm mx-auto"><button onclick="openPostJobModal()" class="btn-primary rounded-full">Post a gig</button></div>' +
    '</div>';
  } else {
    cards = filtered.map(function(job) {
      var isMyJob = job.poster_id === (state.user && state.user.id);
      var urgencyColors = { asap: 'var(--red)', today: 'var(--yellow)', this_week: 'var(--accent-2)', flexible: 'var(--text-dim)' };
      var urgColor = urgencyColors[job.urgency] || 'var(--text-dim)';

      return '<div class="card card-interactive p-5">' +
        '<div class="flex items-start justify-between mb-2">' +
          '<h3 class="font-black text-sm flex-1 mr-2">' + escapeHtml(job.title) + '</h3>' +
          '<div class="flex gap-1">' +
            '<span class="text-[10px] px-2 py-1 rounded-full font-black" style="background:rgba(255,255,255,0.06);color:rgba(232,236,241,0.65);border:1px solid rgba(255,255,255,0.10)">' + escapeHtml(job.category || '') + '</span>' +
            '<span class="text-[10px] px-2 py-1 rounded-full font-black" style="color:' + urgColor + ';border:1px solid ' + urgColor + '30">' + escapeHtml(job.urgency || '') + '</span>' +
          '</div>' +
        '</div>' +
        '<p class="text-xs line-clamp-2 mb-3" style="color:rgba(232,236,241,0.56)">' + escapeHtml(job.description || '') + '</p>' +
        (job.address ? '<p class="text-[11px] mb-3 flex items-center gap-1" style="color:rgba(232,236,241,0.45)"><i class="fas fa-map-marker-alt" style="color:var(--accent-3)"></i>' + escapeHtml(job.address) + '</p>' : '') +
        '<div class="flex items-end justify-between">' +
          '<div>' +
            '<p class="text-[10px] font-black tracking-widest" style="color:rgba(232,236,241,0.45)">BUDGET</p>' +
            '<p class="text-lg font-black mono" style="color:var(--accent)">' + Number(job.budget_mv || 0) + ' MV</p>' +
          '</div>' +
          '<div class="flex gap-2">' +
            (isMyJob ? '<span class="text-[10px] font-black px-3 py-2 rounded-full" style="background:rgba(255,255,255,0.06);color:var(--text-dim)">YOUR GIG</span>' :
              '<button onclick="openApplyModal(\'' + job.id + '\')" class="btn-pill btn-pill-accent">Apply</button>' +
              '<button onclick="startConvoFromJob(\'' + job.id + '\',\'' + job.poster_id + '\')" class="btn-pill btn-pill-ghost" title="Message poster"><i class="fas fa-comment"></i></button>'
            ) +
          '</div>' +
        '</div>' +
        '<div class="mt-3 pt-3 flex items-center justify-between text-[10px]" style="border-top:1px solid rgba(255,255,255,0.06)">' +
          '<span style="color:var(--text-dim)">' + relTime(job.created_at) + '</span>' +
          '<span style="color:var(--text-dim)">ID: ' + escapeHtml((job.id || '').slice(0,8)) + '</span>' +
        '</div>' +
      '</div>';
    }).join('');
  }

  c.innerHTML = '<div class="fade-up">' +
    '<div class="mb-6 flex items-start justify-between gap-3">' +
      '<div>' +
        '<h1 class="text-3xl sm:text-4xl font-black mb-1">Available Gigs</h1>' +
        '<p class="text-sm" style="color:rgba(232,236,241,0.65)">Find work. Keep 100%. Level up. ' + state.jobs.length + ' gig' + (state.jobs.length !== 1 ? 's' : '') + ' open.</p>' +
      '</div>' +
      '<div class="hidden sm:block"><button onclick="openPostJobModal()" class="btn-pill btn-pill-accent">+ Post a gig</button></div>' +
    '</div>' +
    '<div class="flex gap-2 mb-5 overflow-x-auto pb-1">' + btns + '</div>' +
    '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">' + cards + '</div>' +
    '<div class="sm:hidden mt-5"><button onclick="openPostJobModal()" class="btn-primary rounded-full">Post a gig</button></div>' +
  '</div>';
}


/* =============================================================================
   MESSAGES TAB
============================================================================= */
function renderMessagesTab() {
  var c = getEl('tab-content');
  if (!c) return;
  if (state.activeConvoId) { renderThread(); return; }

  c.innerHTML = '<div class="fade-up">' +
    '<div class="flex items-center justify-between mb-2">' +
      '<h1 class="text-3xl font-black">Messages</h1>' +
      '<button onclick="openPeopleSearch()" class="btn-pill btn-pill-ghost"><i class="fas fa-search mr-1"></i>Find People</button>' +
    '</div>' +
    '<p class="text-sm mb-6" style="color:rgba(232,236,241,0.62)">Direct messages with job posters and workers.</p>' +
    '<div id="convo-list"><p class="text-sm py-8 text-center" style="color:var(--text-dim)">Loading conversations...</p></div>' +
  '</div>';
}

async function loadConversations() {
  try {
    var res = await apiRequest('conversation_members?user_id=eq.' + state.user.id + '&select=conversation_id');
    var data = (res && res.ok) ? await res.json() : [];
    if (!res || !res.ok) {
      console.error('conversation_members SELECT failed:', res && res.status);
      /* RLS self-reference issue - try direct conversations query as fallback */
      try {
        var fallbackRes = await apiRequest('conversations?select=id&order=updated_at.desc&limit=50');
        var fallbackData = (fallbackRes && fallbackRes.ok) ? await fallbackRes.json() : [];
        data = fallbackData.map(function(c) { return { conversation_id: c.id }; });
      } catch(fb) { console.error('conversations fallback also failed:', fb); }
    }
    var convIds = data.map(function(d) { return d.conversation_id; }).filter(Boolean);

    if (convIds.length === 0) {
      var el = getEl('convo-list');
      if (el) el.innerHTML = '<div class="text-center py-16" style="color:var(--text-dim)">' +
        '<div class="mb-4">' + muxiSVG(48) + '</div>' +
        '<p class="font-black text-lg mb-1">No messages yet</p>' +
        '<p class="text-sm">Apply to a gig or click the message button on a gig card to start a conversation.</p>' +
      '</div>';
      return;
    }

    /* Get other members - wrap in try/catch for RLS issues */
    var members = [];
    try {
      var membersRes = await apiRequest('conversation_members?conversation_id=in.(' + convIds.join(',') + ')&user_id=neq.' + state.user.id + '&select=conversation_id,user_id');
      members = (membersRes && membersRes.ok) ? await membersRes.json() : [];
    } catch(me) { console.error('conversation_members other-user query failed:', me); }

    /* Look up user names separately */
    var otherUserIds = members.map(function(m) { return m.user_id; }).filter(Boolean);
    var userMap = {};
    if (otherUserIds.length > 0) {
      var userRes = await apiRequest('users?id=in.(' + otherUserIds.join(',') + ')&select=id,full_name,username,email');
      var users = (userRes && userRes.ok) ? await userRes.json() : [];
      users.forEach(function(u) { userMap[u.id] = u; });
    }

    var memberMap = {};
    members.forEach(function(m) {
      m.userInfo = userMap[m.user_id] || null;
      memberMap[m.conversation_id] = m;
    });

    /* Get last message per convo */
    var lastMsgRes = await apiRequest('messages?conversation_id=in.(' + convIds.join(',') + ')&order=created_at.desc&limit=100&select=conversation_id,body,created_at,sender_id');
    var msgs = (lastMsgRes && lastMsgRes.ok) ? await lastMsgRes.json() : [];
    var lastMsgMap = {};
    msgs.forEach(function(m) { if (!lastMsgMap[m.conversation_id]) lastMsgMap[m.conversation_id] = m; });

    state.conversations = convIds.map(function(cid) {
      var other = memberMap[cid];
      var last = lastMsgMap[cid];
      var name = 'User';
      if (other && other.userInfo) {
        name = other.userInfo.full_name || other.userInfo.username || other.userInfo.email || 'User';
      }
      return {
        id: cid,
        otherName: name,
        otherUserId: other ? other.user_id : null,
        lastMsg: last ? last.body : '',
        lastAt: last ? last.created_at : null,
        lastSenderId: last ? last.sender_id : null
      };
    });
    state.conversations.sort(function(a, b) { return (b.lastAt || '') > (a.lastAt || '') ? 1 : -1; });
    renderConvoList();
  } catch(e) { console.error('loadConversations:', e); }
}

function renderConvoList() {
  var el = getEl('convo-list');
  if (!el) return;
  if (state.conversations.length === 0) {
    el.innerHTML = '<div class="text-center py-16" style="color:var(--text-dim)">' + muxiSVG(48) + '<p class="font-black mt-3">No messages yet</p></div>';
    return;
  }
  el.innerHTML = state.conversations.map(function(conv) {
    var initial = (conv.otherName || 'U')[0].toUpperCase();
    var isUnread = conv.lastSenderId && conv.lastSenderId !== (state.user && state.user.id);
    var preview = conv.lastMsg || 'No messages yet';
    if (preview.length > 60) preview = preview.substring(0, 57) + '...';

    return '<div class="card card-interactive p-4 mb-3 cursor-pointer" onclick="openThread(\'' + conv.id + '\')">' +
      '<div class="flex items-center gap-3">' +
        '<div class="avatar-ring flex-shrink-0"><span class="text-lg font-black" style="color:var(--accent)">' + initial + '</span></div>' +
        '<div class="flex-1 min-w-0">' +
          '<div class="flex items-center justify-between mb-1">' +
            '<p class="font-black text-sm truncate">' + escapeHtml(conv.otherName) + '</p>' +
            '<span class="text-[10px] flex-shrink-0 ml-2" style="color:var(--text-dim)">' + relTime(conv.lastAt) + '</span>' +
          '</div>' +
          '<p class="text-xs truncate" style="color:' + (isUnread ? 'var(--text-bright)' : 'var(--text-dim)') + ';font-weight:' + (isUnread ? '700' : '400') + '">' + escapeHtml(preview) + '</p>' +
        '</div>' +
        (isUnread ? '<div style="width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0"></div>' : '') +
      '</div>' +
    '</div>';
  }).join('');
}

async function openThread(convoId) {
  state.activeConvoId = convoId;
  renderThread();
  await loadMessages(convoId);
  subscribeToMessages(convoId);
}

function renderThread() {
  var c = getEl('tab-content');
  if (!c) return;
  var conv = state.conversations.find(function(x) { return x.id === state.activeConvoId; });
  var name = conv ? conv.otherName : 'Chat';
  var initial = (name || 'U')[0].toUpperCase();

  c.innerHTML = '<div class="fade-up">' +
    '<div class="flex items-center gap-3 mb-4">' +
      '<button onclick="state.activeConvoId=null;renderMessagesTab();loadConversations()" class="btn-sm"><i class="fas fa-arrow-left mr-1"></i>Back</button>' +
      '<div class="avatar-ring flex-shrink-0" style="width:36px;height:36px"><span class="text-sm font-black" style="color:var(--accent)">' + initial + '</span></div>' +
      '<div>' +
        '<h2 class="font-black text-sm">' + escapeHtml(name) + '</h2>' +
        '<p class="text-[10px]" style="color:var(--text-dim)">Direct message</p>' +
      '</div>' +
    '</div>' +
    '<div class="card p-4 mb-4">' +
      '<div id="msg-list" class="msg-list space-y-3">' +
        '<p class="text-sm py-8 text-center" style="color:var(--text-dim)">Loading messages...</p>' +
      '</div>' +
    '</div>' +
    '<div class="flex gap-2">' +
      '<input id="msg-input" class="field flex-1" placeholder="Type a message..." onkeydown="if(event.key===\'Enter\')sendMessage()">' +
      '<button onclick="sendMessage()" class="btn-pill btn-pill-accent" style="flex-shrink:0"><i class="fas fa-paper-plane"></i></button>' +
    '</div>' +
  '</div>';
}

async function loadMessages(convoId) {
  try {
    var res = await apiRequest('messages?conversation_id=eq.' + convoId + '&order=created_at.asc&select=*');
    state.activeMessages = (res && res.ok) ? await res.json() : [];
    renderMessages();
  } catch(e) { console.error(e); }
}

function renderMessages() {
  var el = getEl('msg-list');
  if (!el) return;
  if (state.activeMessages.length === 0) {
    el.innerHTML = '<p class="text-center text-sm py-10" style="color:var(--text-dim)">No messages yet. Say hello! &#128075;</p>';
    return;
  }
  el.innerHTML = state.activeMessages.map(function(msg) {
    var mine = msg.sender_id === (state.user && state.user.id);
    var time = new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    return '<div class="flex flex-col ' + (mine ? 'items-end' : 'items-start') + '">' +
      '<div class="msg-bubble ' + (mine ? 'msg-mine' : 'msg-theirs') + '">' + escapeHtml(msg.body) + '</div>' +
      '<span class="text-[10px] mt-1 px-2" style="color:var(--text-dim)">' + time + '</span>' +
    '</div>';
  }).join('');
  el.scrollTop = el.scrollHeight;
}

async function sendMessage() {
  var input = getEl('msg-input');
  if (!input) return;
  var body = input.value.trim();
  if (!body) return;
  input.value = '';
  try {
    await apiRequest('messages', {
      method: 'POST',
      body: JSON.stringify({ conversation_id: state.activeConvoId, sender_id: state.user.id, body: body })
    });
    state.activeMessages.push({ sender_id: state.user.id, body: body, created_at: new Date().toISOString() });
    renderMessages();
    showToast('Message sent', 'success');
    /* Queue notification for recipient */
    var conv = state.conversations.find(function(x) { return x.id === state.activeConvoId; });
    if (conv && conv.otherUserId) {
      apiRequest('notifications_queue', {
        method: 'POST',
        body: JSON.stringify({ user_id: conv.otherUserId, type: 'new_message', title: 'New message from ' + (state.profile && state.profile.full_name || 'someone'), body: body.substring(0, 100) })
      }).catch(function() {});
    }
  } catch(e) { showToast('Failed to send', 'error'); }
}

function subscribeToMessages(convoId) {
  if (!sb) return;
  try {
    var channel = sb.channel('msgs-' + convoId)
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: 'conversation_id=eq.' + convoId }, function(payload) {
        if (payload.new && payload.new.sender_id !== (state.user && state.user.id)) {
          state.activeMessages.push(payload.new);
          renderMessages();
        }
      }).subscribe();
    state.realtimeSubs.push(channel);
  } catch(e) { console.error('realtime sub error:', e); }
}

async function startConvoFromJob(jobId, posterId) {
  if (!state.user) return openAuthModal();
  if (posterId === state.user.id) return showToast('That is your own profile', 'info');
  try {
    showToast('Starting conversation...', 'info');
    var res = await apiRequest('rpc/get_or_create_conversation', {
      method: 'POST',
      body: JSON.stringify({ p_user_id: state.user.id, p_other_user_id: posterId, p_job_id: jobId })
    });
    if (res && res.ok) {
      var convoId = await res.json();
      if (convoId) {
        state.activeConvoId = convoId;
        switchTab('messages');
        await loadConversations();
        openThread(convoId);
      }
    } else {
      showToast('Could not start conversation', 'error');
    }
  } catch(e) { console.error(e); showToast('Could not start conversation', 'error'); }
}


/* =============================================================================
   MAP TAB (MUVR GO)
============================================================================= */
function renderMapTab() {
  var c = getEl('tab-content');
  if (!c) return;
  var isAvail = state.myPresence.status === 'available';

  c.innerHTML = '<div class="fade-up">' +
    '<div class="flex items-center justify-between mb-4">' +
      '<div>' +
        '<h1 class="text-3xl font-black mb-1">MUVR GO</h1>' +
        '<p class="text-sm" style="color:rgba(232,236,241,0.62)">See nearby workers and open gigs in realtime.</p>' +
      '</div>' +
      '<button id="avail-toggle" onclick="toggleAvailability()" class="btn-pill ' + (isAvail ? 'btn-pill-accent' : 'btn-pill-ghost') + '">' +
        (isAvail ? '<i class="fas fa-broadcast-tower mr-2"></i>LIVE' : '<i class="fas fa-eye-slash mr-2"></i>HIDDEN') +
      '</button>' +
    '</div>' +
    '<div id="map-container"></div>' +
    '<div class="mt-4 grid grid-cols-3 gap-3">' +
      '<div class="stat-card flex items-center gap-2 justify-center">' +
        '<div class="map-legend-dot" style="background:var(--accent);box-shadow:0 0 8px var(--accent)"></div>' +
        '<span class="text-[10px] font-black">AVAILABLE</span>' +
      '</div>' +
      '<div class="stat-card flex items-center gap-2 justify-center">' +
        '<div class="map-legend-dot" style="background:var(--yellow);box-shadow:0 0 8px var(--yellow)"></div>' +
        '<span class="text-[10px] font-black">BUSY</span>' +
      '</div>' +
      '<div class="stat-card flex items-center gap-2 justify-center">' +
        '<div class="map-legend-dot" style="background:var(--accent-3);box-shadow:0 0 8px var(--accent-3)"></div>' +
        '<span class="text-[10px] font-black">OPEN GIG</span>' +
      '</div>' +
    '</div>' +
    '<div class="mt-4 card p-4">' +
      '<p class="text-[11px] font-bold" style="color:var(--text-dim)"><i class="fas fa-shield-alt mr-1" style="color:var(--accent)"></i>Privacy: Your location is only shared while set to LIVE. Toggle to HIDDEN at any time to disappear from the map instantly.</p>' +
    '</div>' +
    '<div class="mt-4">' +
      '<h3 class="font-black mb-3">Open Gigs Nearby</h3>' +
      '<div id="map-gig-list"><p class="text-sm" style="color:var(--text-dim)">Loading gigs...</p></div>' +
    '</div>' +
  '</div>';

  setTimeout(initMap, 150);
}

function initMap() {
  var container = getEl('map-container');
  if (!container) return;
  if (state.mapObj) { try { state.mapObj.remove(); } catch(e) {} state.mapObj = null; }

  state.mapObj = L.map('map-container', { zoomControl: true, attributionControl: false }).setView([37.55, -77.46], 12);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19
  }).addTo(state.mapObj);

  /* Try geolocation */
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(pos) {
      var lat = pos.coords.latitude;
      var lng = pos.coords.longitude;
      state.myPresence.lat = lat;
      state.myPresence.lng = lng;
      state.mapObj.setView([lat, lng], 13);

      /* Add "you are here" marker */
      var myIcon = L.divIcon({
        className: '',
        html: '<div style="width:20px;height:20px;border-radius:50%;background:var(--accent-2);border:3px solid white;box-shadow:0 0 12px rgba(124,92,255,0.8)"></div>',
        iconSize: [20, 20], iconAnchor: [10, 10]
      });
      L.marker([lat, lng], { icon: myIcon }).addTo(state.mapObj).bindPopup('<strong>You</strong>');

      if (state.myPresence.status === 'available') {
        updateMyPresence(lat, lng);
      }
    }, function(err) {
      console.log('Geolocation denied:', err.message);
    }, { timeout: 8000, enableHighAccuracy: false });
  }

  loadMapData();
}

async function loadMapData() {
  if (!state.mapObj) return;
  try {
    /* Load worker presence */
    var presRes = await apiRequest('user_presence?status=neq.offline&select=user_id,lat,lng,status,last_seen');
    var presence = (presRes && presRes.ok) ? await presRes.json() : [];
    presence.forEach(function(p) {
      if (!p.lat || !p.lng) return;
      if (p.user_id === (state.user && state.user.id)) return;
      var color = p.status === 'available' ? '#18F6C8' : '#ffd166';
      var icon = L.divIcon({
        className: '',
        html: '<div class="pulse-dot" style="background:' + color + ';color:' + color + '"></div>',
        iconSize: [14, 14], iconAnchor: [7, 7]
      });
      L.marker([p.lat, p.lng], { icon: icon })
        .addTo(state.mapObj)
        .bindPopup('<strong>MUVR Worker</strong><br>Status: ' + p.status + '<br>Last seen: ' + relTime(p.last_seen));
    });

    /* Load open gigs and show in sidebar list */
    var jobsRes = await apiRequest('jobs?status=eq.open&select=id,title,budget_mv,address,category&order=created_at.desc&limit=20');
    var jobs = (jobsRes && jobsRes.ok) ? await jobsRes.json() : [];

    var gigList = getEl('map-gig-list');
    if (gigList) {
      if (jobs.length === 0) {
        gigList.innerHTML = '<p class="text-sm" style="color:var(--text-dim)">No open gigs right now.</p>';
      } else {
        gigList.innerHTML = jobs.map(function(j) {
          return '<div class="card card-interactive p-3 mb-2 flex items-center justify-between">' +
            '<div class="flex-1 min-w-0">' +
              '<p class="font-black text-xs truncate">' + escapeHtml(j.title) + '</p>' +
              '<p class="text-[10px]" style="color:var(--text-dim)">' + escapeHtml(j.address || j.category || '') + '</p>' +
            '</div>' +
            '<span class="mono font-black text-xs ml-2" style="color:var(--accent)">' + Number(j.budget_mv || 0) + ' MV</span>' +
          '</div>';
        }).join('');
      }
    }
  } catch(e) { console.error('map data error:', e); }
}

async function updateMyPresence(lat, lng) {
  if (!state.user) return;
  try {
    await apiRequest('user_presence', {
      method: 'POST',
      headers: { 'Prefer': 'resolution=merge-duplicates' },
      body: JSON.stringify({
        user_id: state.user.id,
        lat: lat, lng: lng,
        status: state.myPresence.status,
        last_seen: new Date().toISOString()
      })
    });
  } catch(e) { console.error('presence update error:', e); }
}

async function toggleAvailability() {
  state.myPresence.status = state.myPresence.status === 'available' ? 'offline' : 'available';
  var btn = getEl('avail-toggle');
  if (btn) {
    var isAvail = state.myPresence.status === 'available';
    btn.className = 'btn-pill ' + (isAvail ? 'btn-pill-accent' : 'btn-pill-ghost');
    btn.innerHTML = isAvail ? '<i class="fas fa-broadcast-tower mr-2"></i>LIVE' : '<i class="fas fa-eye-slash mr-2"></i>HIDDEN';
  }

  if (state.myPresence.status === 'available') {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(pos) {
        updateMyPresence(pos.coords.latitude, pos.coords.longitude);
      });
    }
    showToast('You are now visible on the map', 'success');
    /* Start periodic updates */
    if (state.presenceInterval) clearInterval(state.presenceInterval);
    state.presenceInterval = setInterval(function() {
      if (state.myPresence.status === 'available' && navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          updateMyPresence(pos.coords.latitude, pos.coords.longitude);
        });
      }
    }, 45000);
  } else {
    if (state.presenceInterval) { clearInterval(state.presenceInterval); state.presenceInterval = null; }
    await apiRequest('user_presence?user_id=eq.' + state.user.id, {
      method: 'PATCH',
      body: JSON.stringify({ status: 'offline' })
    });
    showToast('You are now hidden from the map', 'info');
  }
}


/* =============================================================================
   WALLET TAB
============================================================================= */
function renderWalletTab() {
  var c = getEl('tab-content');
  if (!c) return;
  var bal = (state.profile && state.profile.mv_balance) || 0;

  c.innerHTML = '<div class="fade-up">' +
    '<h1 class="text-3xl font-black mb-2">MUVR Credits</h1>' +
    '<p class="text-sm mb-6" style="color:rgba(232,236,241,0.62)">MV are in-platform credits used for escrow and marketplace flows. Not currency.</p>' +

    /* Network Stats */
    '<div class="card p-5 mb-5" style="border-color:rgba(24,246,200,0.14);background:linear-gradient(135deg,rgba(24,246,200,0.08),rgba(124,92,255,0.06),rgba(255,61,154,0.04))">' +
      '<p class="text-[10px] tracking-widest font-black mb-3" style="color:rgba(232,236,241,0.55)">NETWORK STATUS</p>' +
      '<div class="grid grid-cols-4 gap-3 text-center">' +
        '<div><p class="text-[10px] font-black" style="color:rgba(232,236,241,0.45)">CAP</p><p class="text-xl font-black mono" style="color:var(--accent)">100M</p></div>' +
        '<div><p class="text-[10px] font-black" style="color:rgba(232,236,241,0.45)">MINTED</p><p class="text-xl font-black mono" style="color:var(--accent)" id="stat-minted">-</p></div>' +
        '<div><p class="text-[10px] font-black" style="color:rgba(232,236,241,0.45)">ESCROWED</p><p class="text-xl font-black mono" style="color:var(--yellow)" id="stat-escrowed">-</p></div>' +
        '<div><p class="text-[10px] font-black" style="color:rgba(232,236,241,0.45)">BURNED</p><p class="text-xl font-black mono" style="color:var(--red)" id="stat-burned">-</p></div>' +
      '</div>' +
    '</div>' +

    /* Balance Card */
    '<div class="card p-5 max-w-md mb-6">' +
      '<p class="text-[10px] tracking-widest font-black mb-2" style="color:rgba(232,236,241,0.55)">YOUR BALANCE</p>' +
      '<div class="flex items-end justify-between mb-5">' +
        '<p class="text-4xl font-black mono" style="color:var(--accent)" id="balance-display">' + (state.balanceVisible ? bal + ' MV' : '------') + '</p>' +
        '<button onclick="toggleBalance()" class="text-xs font-black cursor-pointer" style="color:rgba(232,236,241,0.55);background:none;border:none;text-transform:uppercase">' + (state.balanceVisible ? 'Hide' : 'Show') + '</button>' +
      '</div>' +
      '<div class="grid grid-cols-3 gap-3">' +
        '<button onclick="openSendModal()" class="btn-pill btn-pill-ghost w-full justify-center">Send</button>' +
        '<button onclick="openLoadModal()" class="btn-pill btn-pill-accent w-full justify-center">Load</button>' +
        '<button onclick="openCashoutModal()" class="btn-pill btn-pill-ghost w-full justify-center">Payout</button>' +
      '</div>' +
      '<div class="mt-4 text-[11px]" style="color:rgba(232,236,241,0.50)">Note: Load and Payout are partner-integrated features (beta). If not enabled, safe stubs are used.</div>' +
    '</div>' +

    /* Personal Ledger */
    '<h2 class="font-black mb-3">Your Ledger (recent)</h2>' +
    '<div id="ledger-list"><p class="text-sm py-4" style="color:var(--text-dim)">Loading...</p></div>' +
  '</div>';
}

function toggleBalance() {
  state.balanceVisible = !state.balanceVisible;
  if (state.currentTab === 'wallet') { renderWalletTab(); loadWalletData(); }
}

async function loadWalletData() {
  if (!state.user) return;
  try {
    var balRes = await apiRequest('users?id=eq.' + state.user.id + '&select=mv_balance');
    if (balRes && balRes.ok) {
      var d = await balRes.json();
      if (d && d.length) state.profile = Object.assign(state.profile || {}, { mv_balance: d[0].mv_balance });
    }
  } catch(e) {}

  var bd = getEl('balance-display');
  if (bd) bd.textContent = state.balanceVisible ? ((state.profile && state.profile.mv_balance || 0) + ' MV') : '------';

  /* Load personal ledger */
  var el = getEl('ledger-list');
  try {
    var res = await apiRequest('mv_ledger?user_id=eq.' + state.user.id + '&order=created_at.desc&limit=25');
    var ledger = (res && res.ok) ? await res.json() : [];
    if (!el) return;
    if (!ledger.length) { el.innerHTML = '<p class="text-sm py-4" style="color:var(--text-dim)">No transactions yet. Post or complete a gig to see activity here.</p>'; return; }

    el.innerHTML = ledger.map(function(e) {
      var neg = ['burn','send','withdrawal'].indexOf(e.type) >= 0;
      var typeEmoji = { load:'&#128229;', send:'&#128228;', receive:'&#128232;', burn:'&#128293;', withdrawal:'&#127974;', escrow_lock:'&#128274;', escrow_release:'&#128275;' };
      var icon = typeEmoji[e.type] || '&#128202;';
      var color = neg ? 'var(--red)' : 'var(--accent)';
      var sign = neg ? '-' : '+';

      return '<div class="card p-3 mb-2 flex justify-between items-start" style="border-left:3px solid ' + (neg ? 'var(--red)' : 'rgba(24,246,200,0.65)') + '">' +
        '<div class="flex items-start gap-3">' +
          '<span class="text-base">' + icon + '</span>' +
          '<div>' +
            '<p class="font-black text-xs" style="text-transform:capitalize">' + escapeHtml(e.type || '') + '</p>' +
            '<p class="text-[11px]" style="color:var(--text-dim)">' + escapeHtml(e.description || '') + '</p>' +
            '<p class="text-[10px] mt-1" style="color:rgba(232,236,241,0.38)">' + relTime(e.created_at) + '</p>' +
          '</div>' +
        '</div>' +
        '<p class="mono font-black text-xs whitespace-nowrap ml-2" style="color:' + color + '">' + sign + Number(e.amount_mv || 0) + ' MV</p>' +
      '</div>';
    }).join('');
  } catch(e) { if (el) el.innerHTML = '<p class="text-sm py-4" style="color:var(--text-dim)">Ledger unavailable right now.</p>'; }
}

/* =============================================================================
   PUBLIC LEDGER TAB
============================================================================= */
function renderLedgerTab() {
  var c = getEl('tab-content');
  if (!c) return;
  c.innerHTML = '<div class="fade-up">' +
    '<h1 class="text-3xl font-black mb-2">Public Ledger</h1>' +
    '<p class="text-sm mb-6" style="color:rgba(232,236,241,0.62)">Anonymous, realtime feed of all MV credit activity on the network. All user identities shown as pseudonymous aliases.</p>' +
    '<div id="app-ledger-content"></div>' +
  '</div>';
  renderLedgerContent('app-ledger-content');
}

function renderLedgerContent(containerId) {
  var el = getEl(containerId);
  if (!el) return;
  var types = [{k:'all',l:'All'},{k:'mint',l:'Mint'},{k:'burn',l:'Burn'},{k:'transfer',l:'Transfer'},{k:'escrow_lock',l:'Escrow Lock'},{k:'escrow_release',l:'Release'}];
  var btns = types.map(function(t) {
    return '<button onclick="state.ledgerFilter=\'' + t.k + '\';loadPublicEvents()" class="btn-pill ' + (state.ledgerFilter === t.k ? 'btn-pill-accent' : 'btn-pill-ghost') + '">' + t.l + '</button>';
  }).join('');

  el.innerHTML =
    '<div class="card p-5 mb-5" style="border-color:rgba(24,246,200,0.14);background:linear-gradient(135deg,rgba(24,246,200,0.06),rgba(124,92,255,0.04))">' +
      '<div class="flex items-center gap-2 mb-3"><div class="live-dot"></div><span class="text-[10px] font-black tracking-widest" style="color:rgba(232,236,241,0.65)">LIVE NETWORK</span></div>' +
      '<div class="grid grid-cols-4 gap-3 text-center">' +
        '<div><p class="text-[10px] font-black" style="color:rgba(232,236,241,0.45)">CAP</p><p class="text-lg font-black mono" style="color:var(--accent)">100M</p></div>' +
        '<div><p class="text-[10px] font-black" style="color:rgba(232,236,241,0.45)">MINTED</p><p class="text-lg font-black mono" style="color:var(--accent)" id="pub-minted">-</p></div>' +
        '<div><p class="text-[10px] font-black" style="color:rgba(232,236,241,0.45)">ESCROWED</p><p class="text-lg font-black mono" style="color:var(--yellow)" id="pub-escrowed">-</p></div>' +
        '<div><p class="text-[10px] font-black" style="color:rgba(232,236,241,0.45)">BURNED</p><p class="text-lg font-black mono" style="color:var(--red)" id="pub-burned">-</p></div>' +
      '</div>' +
    '</div>' +
    '<div class="flex gap-2 mb-4 overflow-x-auto pb-1">' + btns + '</div>' +
    '<div id="public-events-list"><p class="text-sm py-4" style="color:var(--text-dim)">Loading events...</p></div>';
}

async function loadPublicEvents() {
  try {
    var filter = state.ledgerFilter !== 'all' ? '&type=eq.' + state.ledgerFilter : '';
    var url = 'mv_public_events?order=created_at.desc&limit=50' + filter;
    var headers = { 'apikey': SUPA_KEY };
    if (state.accessToken) headers['Authorization'] = 'Bearer ' + state.accessToken;
    var res = await fetch(SUPA_URL + '/rest/v1/' + url, { headers: headers });
    state.publicEvents = res.ok ? await res.json() : [];
    renderPublicEvents();
    computeNetworkStats();
  } catch(e) { console.error(e); }
}

async function computeNetworkStats() {
  try {
    var headers = { 'apikey': SUPA_KEY };
    if (state.accessToken) headers['Authorization'] = 'Bearer ' + state.accessToken;
    var allRes = await fetch(SUPA_URL + '/rest/v1/mv_public_events?select=type,amount_mv&limit=5000', { headers: headers });
    var all = allRes.ok ? await allRes.json() : [];
    var minted = 0, escrowed = 0, burned = 0;
    all.forEach(function(e) {
      var amt = Number(e.amount_mv || 0);
      if (e.type === 'mint') minted += amt;
      if (e.type === 'escrow_lock') escrowed += amt;
      if (e.type === 'escrow_release') escrowed -= amt;
      if (e.type === 'escrow_refund') escrowed -= amt;
      if (e.type === 'burn') burned += amt;
    });
    function fmtNum(n) { return n >= 1000000 ? (n/1000000).toFixed(1) + 'M' : n >= 1000 ? (n/1000).toFixed(1) + 'K' : String(n); }
    var els = ['stat-minted', 'pub-minted'];
    els.forEach(function(id) { var el = getEl(id); if (el) el.textContent = fmtNum(minted); });
    ['stat-escrowed', 'pub-escrowed'].forEach(function(id) { var el = getEl(id); if (el) el.textContent = fmtNum(escrowed); });
    ['stat-burned', 'pub-burned'].forEach(function(id) { var el = getEl(id); if (el) el.textContent = fmtNum(burned); });
  } catch(e) { console.error('stats error:', e); }
}

function renderPublicEvents() {
  var el = getEl('public-events-list');
  if (!el) return;
  if (!state.publicEvents.length) {
    el.innerHTML = '<div class="text-center py-12" style="color:var(--text-dim)">' + muxiSVG(48) + '<p class="font-black mt-3">No events recorded yet</p><p class="text-sm mt-1">Post a gig or load credits to create the first network event.</p></div>';
    return;
  }
  var typeConfig = {
    mint: { icon: '&#128994;', color: 'var(--accent)', label: 'MINT' },
    burn: { icon: '&#128308;', color: 'var(--red)', label: 'BURN' },
    transfer: { icon: '&#128310;', color: 'var(--accent-2)', label: 'TRANSFER' },
    escrow_lock: { icon: '&#128274;', color: 'var(--yellow)', label: 'ESCROW LOCK' },
    escrow_release: { icon: '&#128275;', color: 'var(--accent)', label: 'RELEASE' },
    escrow_refund: { icon: '&#128281;', color: 'var(--accent-3)', label: 'REFUND' }
  };

  el.innerHTML = state.publicEvents.map(function(ev) {
    var cfg = typeConfig[ev.type] || { icon: '&#128312;', color: 'var(--text-dim)', label: ev.type };
    return '<div class="ledger-event card p-3 mb-2">' +
      '<div class="flex items-center justify-between">' +
        '<div class="flex items-center gap-3">' +
          '<span class="text-base">' + cfg.icon + '</span>' +
          '<div>' +
            '<p class="font-black text-[11px] tracking-wider" style="color:' + cfg.color + '">' + cfg.label + '</p>' +
            '<p class="text-[10px] mt-0.5" style="color:var(--text-dim)">' +
              (ev.from_alias ? '<span class="mono">' + escapeHtml(ev.from_alias) + '</span>' : '') +
              (ev.from_alias && ev.to_alias ? ' &#8594; ' : '') +
              (ev.to_alias ? '<span class="mono">' + escapeHtml(ev.to_alias) + '</span>' : '') +
            '</p>' +
          '</div>' +
        '</div>' +
        '<div class="text-right">' +
          '<p class="mono font-black text-sm" style="color:' + cfg.color + '">' + Number(ev.amount_mv) + ' MV</p>' +
          '<p class="text-[10px]" style="color:var(--text-dim)">' + relTime(ev.created_at) + '</p>' +
        '</div>' +
      '</div>' +
      (ev.tx_hash ? '<div class="mt-2 text-[10px] mono" style="color:rgba(232,236,241,0.30);word-break:break-all">TX: ' + escapeHtml(ev.tx_hash) + '</div>' : '') +
    '</div>';
  }).join('');
}


/* =============================================================================
   PROFILE TAB (Fleshed Out)
============================================================================= */
function calcLevel(p) {
  var completed = Number((p && p.jobs_completed) || 0);
  var xp = completed * 120 + (p && p.full_name ? 40 : 0) + (p && p.about_me ? 40 : 0) + (p && p.username ? 30 : 0) + (p && p.has_vehicle ? 20 : 0);
  var level = Math.max(1, Math.floor(xp / 200) + 1);
  var titles = ['Runner', 'Carrier', 'Operator', 'Elite Operator', 'Legend', 'Mythic'];
  var title = titles[Math.min(titles.length - 1, Math.floor((level - 1) / 2))];
  var next = level * 200;
  var pct = Math.min(1, xp / next);
  return { xp: xp, level: level, title: title, next: next, pct: pct };
}

function renderProfileTab() {
  var c = getEl('tab-content');
  if (!c) return;
  var p = state.profile || {};
  var rating = Number(p.rating || 0);
  var stars = '';
  for (var i = 0; i < Math.floor(rating); i++) stars += '&#11088;';
  if (rating % 1 > 0) stars += '&#10024;';
  var lvl = calcLevel(p);
  var initial = ((p.full_name || 'U')[0] || 'U').toUpperCase();
  var completionPct = 0;
  if (p.full_name) completionPct += 25;
  if (p.username) completionPct += 25;
  if (p.about_me) completionPct += 25;
  if (p.has_vehicle !== undefined) completionPct += 25;

  c.innerHTML = '<div class="fade-up">' +
    '<h1 class="text-3xl font-black mb-2">Your Profile</h1>' +
    '<p class="text-sm mb-6" style="color:rgba(232,236,241,0.62)">Level up to get picked faster. Complete profiles get 2x visibility.</p>' +

    /* Profile Card */
    '<div class="card p-6 max-w-2xl mb-6">' +
      /* Top section */
      '<div class="flex items-start gap-4 mb-5 pb-5" style="border-bottom:1px solid rgba(255,255,255,0.10)">' +
        '<div class="avatar-ring-lg flex-shrink-0"><span class="text-2xl font-black" style="color:var(--accent)">' + initial + '</span></div>' +
        '<div class="flex-1">' +
          '<h2 class="text-xl font-black mb-0.5">' + escapeHtml(p.full_name || 'No Name Set') + '</h2>' +
          '<p class="text-sm font-bold mb-2" style="color:rgba(232,236,241,0.55)">@' + escapeHtml(p.username || 'no_handle') + '</p>' +
          '<p class="text-xs mb-3" style="color:rgba(232,236,241,0.55)">' + escapeHtml(p.about_me || 'No bio yet - tap Edit to add one and level up.') + '</p>' +
          '<div class="flex flex-wrap gap-2">' +
            (p.has_vehicle ? '<span class="text-[10px] font-black px-2 py-1 rounded-full" style="background:rgba(24,246,200,0.12);border:1px solid rgba(24,246,200,0.25);color:var(--accent)"><i class="fas fa-car mr-1"></i>Has Vehicle</span>' : '') +
            '<span class="text-[10px] font-black px-2 py-1 rounded-full" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10)">' + escapeHtml((p.role || 'both').toUpperCase()) + '</span>' +
            '<span class="text-[10px] font-black px-2 py-1 rounded-full" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10)"><i class="fas fa-envelope mr-1"></i>' + escapeHtml((state.user && state.user.email) || '') + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="text-right flex-shrink-0">' +
          '<div class="text-[10px] font-black tracking-widest" style="color:rgba(232,236,241,0.55)">RANK</div>' +
          '<div class="text-xl font-black hero-gradient">' + escapeHtml(lvl.title) + '</div>' +
          '<div class="text-[11px] font-black mt-1" style="color:rgba(232,236,241,0.65)">Level ' + lvl.level + '</div>' +
        '</div>' +
      '</div>' +

      /* Stats Grid */
      '<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-5">' +
        '<div class="stat-card"><p class="text-[10px] font-black tracking-widest" style="color:rgba(232,236,241,0.55)">COMPLETED</p><p class="text-2xl font-black mt-1">' + Number(p.jobs_completed || 0) + '</p></div>' +
        '<div class="stat-card"><p class="text-[10px] font-black tracking-widest" style="color:rgba(232,236,241,0.55)">RATING</p><p class="text-lg mt-1">' + (stars || '&#9734; N/A') + '</p></div>' +
        '<div class="stat-card"><p class="text-[10px] font-black tracking-widest" style="color:rgba(232,236,241,0.55)">MV BALANCE</p><p class="text-2xl font-black mt-1" style="color:var(--accent)">' + Number(p.mv_balance || 0) + '</p></div>' +
        '<div class="stat-card"><p class="text-[10px] font-black tracking-widest" style="color:rgba(232,236,241,0.55)">XP TOTAL</p><p class="text-2xl font-black mt-1">' + lvl.xp + '</p></div>' +
      '</div>' +

      /* XP Bar */
      '<div class="mb-5">' +
        '<div class="flex justify-between text-[11px] font-black" style="color:rgba(232,236,241,0.62)"><span>XP: ' + lvl.xp + '</span><span>Next Level: ' + lvl.next + '</span></div>' +
        '<div class="mt-2 h-4 rounded-full overflow-hidden" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.10)">' +
          '<div class="h-full rounded-full transition-all" style="width:' + Math.round(lvl.pct * 100) + '%;background:linear-gradient(90deg,var(--accent),var(--accent-2),var(--accent-3))"></div>' +
        '</div>' +
      '</div>' +

      /* Profile Completion */
      '<div class="p-4 rounded-2xl mb-5" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08)">' +
        '<div class="flex items-center justify-between mb-2">' +
          '<p class="text-sm font-black">Profile Completion</p>' +
          '<p class="text-sm font-black" style="color:' + (completionPct === 100 ? 'var(--accent)' : 'var(--yellow)') + '">' + completionPct + '%</p>' +
        '</div>' +
        '<div class="h-2 rounded-full" style="background:rgba(255,255,255,0.08)">' +
          '<div class="h-full rounded-full" style="width:' + completionPct + '%;background:' + (completionPct === 100 ? 'var(--accent)' : 'var(--yellow)') + '"></div>' +
        '</div>' +
        (completionPct < 100 ? '<p class="text-[11px] mt-2" style="color:var(--text-dim)">Complete your profile to unlock 2x visibility in search results.</p>' : '<p class="text-[11px] mt-2" style="color:var(--accent)">Profile complete! You have maximum visibility.</p>') +
      '</div>' +

      '<button onclick="openEditProfileModal()" class="btn-primary rounded-full">Edit profile</button>' +
    '</div>' +

    /* Trust & Safety Card */
    '<div class="card p-5 max-w-2xl mb-6">' +
      '<h3 class="font-black mb-3"><i class="fas fa-shield-alt mr-2" style="color:var(--accent)"></i>Trust & Safety</h3>' +
      '<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">' +
        '<div class="p-3 rounded-xl" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08)">' +
          '<p class="font-black text-xs mb-1">Escrow Protection</p>' +
          '<p class="text-[11px]" style="color:var(--text-dim)">All gig payments locked in escrow before work begins. Funds release only on confirmation.</p>' +
        '</div>' +
        '<div class="p-3 rounded-xl" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08)">' +
          '<p class="font-black text-xs mb-1">Public Ledger</p>' +
          '<p class="text-[11px]" style="color:var(--text-dim)">All MV transactions recorded publicly (anonymized). Full transparency, no hidden flows.</p>' +
        '</div>' +
        '<div class="p-3 rounded-xl" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08)">' +
          '<p class="font-black text-xs mb-1">Reputation System</p>' +
          '<p class="text-[11px]" style="color:var(--text-dim)">Star ratings, completion count, and XP level visible to all users. Build trust through work.</p>' +
        '</div>' +
        '<div class="p-3 rounded-xl" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08)">' +
          '<p class="font-black text-xs mb-1">Dispute Resolution</p>' +
          '<p class="text-[11px]" style="color:var(--text-dim)">Escrow holds during disputes. Platform review process protects both parties.</p>' +
        '</div>' +
      '</div>' +
      '<div class="mt-3 text-[11px]" style="color:var(--text-dim)"><i class="fas fa-info-circle mr-1"></i>Identity verification and background check integration coming in a future update.</div>' +
    '</div>' +

    /* Achievements / Badges */
    '<div class="card p-5 max-w-2xl">' +
      '<h3 class="font-black mb-3">Achievements</h3>' +
      '<div class="grid grid-cols-2 sm:grid-cols-4 gap-3">' +
        badge('&#128640;', 'Early Adopter', 'Joined MUVR', true) +
        badge('&#128170;', 'First Gig', 'Complete 1 gig', Number(p.jobs_completed || 0) >= 1) +
        badge('&#11088;', '5-Star Worker', 'Get a 5-star rating', rating >= 5) +
        badge('&#127942;', 'Pro MUVR', 'Complete 10 gigs', Number(p.jobs_completed || 0) >= 10) +
        badge('&#128176;', 'Big Spender', 'Send 100+ MV', Number(p.mv_balance || 0) >= 0) +
        badge('&#128293;', 'Burn Baby', 'Post 5 gigs (burn 5 MV)', Number(p.jobs_completed || 0) >= 5) +
        badge('&#128663;', 'Road Warrior', 'Has a vehicle', !!p.has_vehicle) +
        badge('&#128172;', 'Social Butterfly', 'Complete profile', !!(p.full_name && p.username && p.about_me)) +
        badge('&#127775;', 'Rising Star', 'Reach Level 3', calcLevel(p).level >= 3) +
        badge('&#9889;', 'Lightning', 'Complete 25 gigs', Number(p.jobs_completed || 0) >= 25) +
        badge('&#128081;', 'Legend', 'Reach Level 10', calcLevel(p).level >= 10) +
        badge('&#129412;', 'MUXI Friend', 'Tap MUXI 5 times', false) +
      '</div>' +
    '</div>' +
  '</div>';
}

function badge(icon, title, desc, unlocked) {
  return '<div class="p-3 rounded-2xl text-center" style="background:rgba(255,255,255,' + (unlocked ? '0.06' : '0.02') + ');border:1px solid ' + (unlocked ? 'rgba(24,246,200,0.25)' : 'rgba(255,255,255,0.06)') + ';opacity:' + (unlocked ? '1' : '0.4') + '">' +
    '<div class="text-2xl mb-1">' + icon + '</div>' +
    '<p class="font-black text-[11px]">' + title + '</p>' +
    '<p class="text-[10px]" style="color:var(--text-dim)">' + desc + '</p>' +
    (unlocked ? '<div class="text-[10px] font-black mt-1" style="color:var(--accent)">UNLOCKED</div>' : '') +
  '</div>';
}



/* =============================================================================
   BLOG
============================================================================= */
var blogPosts = [
  { id: 'moving-tips-2026', title: 'Top 10 Moving Tips for 2026', cat: 'Moving Tips', date: '2026-02-20', excerpt: 'Moving can be stressful but with the right preparation it does not have to be. Here are our top tips for a smooth move this year.', body: 'Start early - the biggest mistake people make is waiting until the last minute. Book movers at least 2 weeks ahead. Declutter before packing: if you have not used it in a year, donate it. Label every box with room and contents. Take photos of electronics before unplugging. Keep essentials in a separate bag. Notify utilities 2 weeks early. Measure doorways at both locations. Tip your movers - they are doing hard work. Use MUVR to find trusted local help with escrow protection.' },
  { id: 'gig-economy-future', title: 'The Future of the Gig Economy: Zero Commission', cat: 'Gig Economy', excerpt: 'Traditional platforms take 15-30% of worker earnings. MUVR is building the alternative with 0% commission and escrow-first payment protection.', date: '2026-02-18', body: 'The gig economy has grown to over 60 million workers in the US alone. But most platforms still extract 15-30% from every transaction. MUVR takes a different approach: zero commission on worker earnings. Instead of percentage fees, MUVR uses a flat 1 MV credit posting fee that gets burned permanently. Workers keep 100% of the agreed rate. Escrow locks funds before work begins, so workers are guaranteed payment and clients are guaranteed delivery. It is a fundamentally different model built for the people doing the actual work.' },
  { id: 'escrow-explained', title: 'How Escrow Protection Works on MUVR', cat: 'MUVR News', excerpt: 'Escrow is the backbone of trust on MUVR. Learn how it protects both workers and job posters in every transaction.', date: '2026-02-15', body: 'When a job is posted on MUVR, the full budget plus a 1 MV posting fee locks in escrow. This means the money exists and is committed before any worker starts. When work is complete and confirmed, escrow releases instantly to the worker. If there is a dispute, escrow holds until resolution. The 1 MV posting fee is permanently burned, reducing the total supply over time. This creates a system where trust is built into the protocol, not dependent on reviews alone.' },
  { id: 'worker-guide-getting-started', title: 'Worker Guide: Getting Started on MUVR', cat: 'Worker Guides', excerpt: 'New to MUVR? Here is everything you need to know to land your first gig and start earning.', date: '2026-02-12', body: 'Step 1: Create your account and complete your profile. Profiles with names, bios, and vehicle info get 2x visibility. Step 2: Browse the Gigs tab and filter by type - rideshare, delivery, physical labor, or digital work. Step 3: Apply with a clear pitch, your rate in MV, and estimated turnaround. Step 4: If selected, do great work and get paid instantly via escrow release. Step 5: Earn XP for every completed gig and climb the ranks from Runner to Mythic. Higher rank means you appear first in search results.' },
  { id: 'mv-credits-explained', title: 'Understanding MUVR Credits (MV)', cat: 'MUVR News', excerpt: 'MV Credits are the in-platform unit that powers escrow, payments, and marketplace flows. Here is how they work.', date: '2026-02-10', body: 'MUVR Credits (MV) are platform-limited digital credits used within MUVR for marketplace features. They are denominated as 1 credit equals 1 USD-equivalent unit inside the app for pricing. Total supply is capped at 100 million MV. Every job posting burns 1 MV permanently, creating natural deflation over time. MV can be sent to any user by handle, email, or public alias. All transfers are logged in the public ledger using anonymous aliases. MV are not currency, cryptocurrency, or financial instruments.' },
  { id: 'virginia-pilot-launch', title: 'MUVR Launches Virginia Pilot Program', cat: 'MUVR News', excerpt: 'We are rolling out the MUVR marketplace in Virginia first. Here is why and what to expect.', date: '2026-02-08', body: 'Virginia is MUVR launch market and the testing ground for the platform. We chose Virginia for its diverse population, strong demand for moving and delivery services, and proximity to our team. The pilot includes all core features: gig posting, escrow, MV credits, messaging, the public ledger, and the MUVR GO map. Early users will get bonus MV credits for completing their profiles and posting their first gigs. Feedback from the Virginia pilot will shape the national rollout later this year.' }
];

function renderBlogPage() {
  var root = getEl('root');
  if (!root) return;
  root.innerHTML = '<div class="fade-up"><div class="max-w-4xl mx-auto px-5 py-8">' +
    '<div class="flex items-center justify-between mb-6">' +
      '<div class="flex items-center gap-3">' +
        '<div class="text-2xl font-black"><span style="color:var(--accent)">M</span>U<span style="color:var(--accent)">V</span>R</div>' +
        '<span class="text-[10px] font-black px-2 py-1 rounded-full" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10)">BLOG</span>' +
      '</div>' +
      '<div class="flex gap-2">' +
        (state.user ? '<button onclick="renderApp()" class="btn-pill btn-pill-ghost">Back to App</button>' : '<button onclick="renderLanding()" class="btn-pill btn-pill-ghost">Back</button>') +
      '</div>' +
    '</div>' +
    '<h1 class="text-3xl font-black mb-2">MUVR Blog</h1>' +
    '<p class="text-sm mb-6" style="color:var(--text-mid)">Tips, guides, and news from the real-world work game.</p>' +
    '<div class="space-y-4">' +
    blogPosts.map(function(post) {
      return '<div class="card card-interactive p-5 cursor-pointer" onclick="renderBlogPost(\'' + post.id + '\')">' +
        '<div class="flex items-start justify-between mb-2">' +
          '<span class="text-[10px] font-black px-2 py-1 rounded-full" style="background:rgba(24,246,200,0.10);border:1px solid rgba(24,246,200,0.20);color:var(--accent)">' + escapeHtml(post.cat) + '</span>' +
          '<span class="text-[10px]" style="color:var(--text-dim)">' + post.date + '</span>' +
        '</div>' +
        '<h2 class="font-black text-lg mb-2">' + escapeHtml(post.title) + '</h2>' +
        '<p class="text-sm" style="color:var(--text-mid)">' + escapeHtml(post.excerpt) + '</p>' +
        '<p class="text-[11px] font-black mt-3" style="color:var(--accent)">Read more &#8594;</p>' +
      '</div>';
    }).join('') +
    '</div>' +
  '</div></div>';
}

function renderBlogPost(postId) {
  var post = blogPosts.find(function(p) { return p.id === postId; });
  if (!post) return;
  var root = getEl('root');
  if (!root) return;
  root.innerHTML = '<div class="fade-up"><div class="max-w-3xl mx-auto px-5 py-8">' +
    '<button onclick="renderBlogPage()" class="btn-sm mb-4"><i class="fas fa-arrow-left mr-1"></i>Back to Blog</button>' +
    '<span class="text-[10px] font-black px-2 py-1 rounded-full" style="background:rgba(24,246,200,0.10);border:1px solid rgba(24,246,200,0.20);color:var(--accent)">' + escapeHtml(post.cat) + '</span>' +
    '<span class="text-[10px] ml-2" style="color:var(--text-dim)">' + post.date + '</span>' +
    '<h1 class="text-3xl font-black mt-3 mb-4">' + escapeHtml(post.title) + '</h1>' +
    '<div class="text-sm leading-relaxed space-y-4" style="color:var(--text-mid)">' +
      post.body.split('. ').reduce(function(acc, sentence, i) {
        if (i % 3 === 0 && i > 0) return acc + '</p><p>' + sentence + '. ';
        return acc + sentence + '. ';
      }, '<p>') + '</p>' +
    '</div>' +
    '<div class="mt-8 card p-5">' +
      '<p class="font-black mb-2">Ready to get started?</p>' +
      '<button onclick="openAuthModal()" class="btn-primary rounded-full">Join MUVR</button>' +
    '</div>' +
  '</div></div>';
}

/* =============================================================================
   AUTH MODALS
============================================================================= */
function openAuthModal() {
  openModal(
    '<div class="card p-6 sm:p-8" style="max-width:440px;margin:auto">' +
      '<div class="flex justify-between items-center mb-2">' +
        '<h2 class="text-xl font-black">Enter MUVR</h2>' +
        '<button onclick="closeModal()" class="close-btn">&times;</button>' +
      '</div>' +
      '<p class="text-sm mb-5" style="color:rgba(232,236,241,0.65)">Zero commission. Escrow-first. Level up with every gig.</p>' +
      '<input id="auth-email" type="email" placeholder="you@email.com" class="field mb-3" autocomplete="email">' +
      '<input id="auth-password" type="password" placeholder="Password (6+ chars)" class="field mb-4" autocomplete="current-password">' +
      '<button onclick="handleSignUp()" class="btn-primary mb-2 rounded-full">Create account</button>' +
      '<button onclick="handleSignIn()" class="btn-secondary rounded-full">I already have an account</button>' +
      '<p id="auth-error" class="text-xs text-center mt-3 hidden" style="color:#ffd2d2;font-weight:800"></p>' +
      '<div class="mt-5 text-[11px]" style="color:rgba(232,236,241,0.52)">By continuing you agree to marketplace terms. MUVR Credits (MV) are platform credits (not currency).</div>' +
    '</div>'
  );
}

function showAuthError(msg) {
  var el = getEl('auth-error'); if (!el) return;
  el.textContent = msg; el.classList.remove('hidden');
  setTimeout(function() { el.classList.add('hidden'); }, 5000);
}

function openLegalModal() {
  openModal(
    '<div class="card p-6 sm:p-8" style="max-width:540px;margin:auto">' +
      '<h2 class="text-xl font-black mb-4">Before you start</h2>' +
      '<div class="space-y-3 mb-5">' +
        '<div class="p-4 rounded-2xl" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.10)">' +
          '<h3 class="font-black text-sm mb-1" style="color:var(--accent)">Marketplace Terms</h3>' +
          '<p class="text-xs" style="color:rgba(232,236,241,0.62)">MUVR is a technology marketplace. MUVR is NOT an employer. You are an independent contractor.</p>' +
        '</div>' +
        '<div class="p-4 rounded-2xl" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.10)">' +
          '<h3 class="font-black text-sm mb-1" style="color:var(--accent)">Contractor Agreement</h3>' +
          '<p class="text-xs" style="color:rgba(232,236,241,0.62)">You control your schedule, rates, methods. You are responsible for taxes, insurance, and compliance in your jurisdiction.</p>' +
        '</div>' +
        '<div class="p-4 rounded-2xl" style="background:rgba(24,246,200,0.06);border:1px solid rgba(24,246,200,0.16)">' +
          '<h3 class="font-black text-sm mb-1">MUVR Credits (MV)</h3>' +
          '<p class="text-xs" style="color:rgba(232,236,241,0.70)">MV are platform-limited digital credits used within MUVR for escrow and marketplace flows. Not currency, cryptocurrency, or financial instruments.</p>' +
        '</div>' +
      '</div>' +
      '<div class="space-y-2 mb-5">' +
        '<label class="flex items-start gap-3 cursor-pointer p-2 rounded-xl hover:opacity-90"><input type="checkbox" id="check-tos" onchange="updateLegalButton()" class="w-4 h-4 mt-0.5"><span class="text-sm font-bold">I accept the Marketplace Terms</span></label>' +
        '<label class="flex items-start gap-3 cursor-pointer p-2 rounded-xl hover:opacity-90"><input type="checkbox" id="check-contractor" onchange="updateLegalButton()" class="w-4 h-4 mt-0.5"><span class="text-sm font-bold">I accept the Contractor Agreement</span></label>' +
        '<label class="flex items-start gap-3 cursor-pointer p-2 rounded-xl hover:opacity-90"><input type="checkbox" id="check-age" onchange="updateLegalButton()" class="w-4 h-4 mt-0.5"><span class="text-sm font-bold">I am 18 years or older</span></label>' +
      '</div>' +
      '<button onclick="handleAcceptLegal()" id="legal-submit-btn" class="btn-secondary rounded-full" disabled>Check all boxes</button>' +
    '</div>',
    { locked: true, width: 'max-w-lg' }
  );
}

function updateLegalButton() {
  var ok = getEl('check-tos') && getEl('check-tos').checked &&
           getEl('check-contractor') && getEl('check-contractor').checked &&
           getEl('check-age') && getEl('check-age').checked;
  var btn = getEl('legal-submit-btn'); if (!btn) return;
  btn.disabled = !ok;
  btn.textContent = ok ? 'I agree & continue' : 'Check all boxes';
  btn.className = ok ? 'btn-primary rounded-full' : 'btn-secondary rounded-full';
}

/* =============================================================================
   JOB / WALLET / PROFILE MODALS
============================================================================= */
function openPostJobModal() {
  openModal(
    '<div class="card p-6" style="max-width:460px;margin:auto;max-height:90vh;overflow:auto">' +
      '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">Post a gig</h2><button onclick="closeModal()" class="close-btn">&times;</button></div>' +
      '<div class="space-y-3">' +
        '<input id="job-title" placeholder="What do you need done?" maxlength="100" class="field">' +
        '<textarea id="job-desc" placeholder="Describe the work in detail..." rows="3" maxlength="500" class="field" style="resize:none"></textarea>' +
        '<select id="job-type" class="field"><option value="">Select type...</option><option value="rideshare">Rideshare</option><option value="delivery">Delivery</option><option value="physical">Physical labor</option><option value="digital">Digital/remote</option></select>' +
        '<select id="job-urgency" class="field"><option value="asap">ASAP</option><option value="today">Today</option><option value="this_week">This week</option><option value="flexible">Flexible</option></select>' +
        '<div><label class="text-[11px] font-black mb-1 block" style="color:rgba(232,236,241,0.55)">Budget (MV Credits)</label><input id="job-budget" type="number" min="1" max="10000" placeholder="50" class="field" oninput="updateJobFee()"></div>' +
        '<input id="job-address" placeholder="Location / Address (optional)" maxlength="200" class="field">' +
        '<div class="p-4 rounded-2xl text-sm" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.10)">' +
          '<div class="flex justify-between mb-1"><span style="color:rgba(232,236,241,0.55)">Budget</span><span class="font-black" id="fee-budget">0 MV</span></div>' +
          '<div class="flex justify-between mb-1"><span style="color:rgba(232,236,241,0.55)">Posting fee (burn)</span><span class="font-black" style="color:var(--red)">1 MV</span></div>' +
          '<div class="flex justify-between font-black pt-2" style="border-top:1px solid rgba(255,255,255,0.10)"><span>Total locked</span><span id="fee-total" style="color:var(--accent)">1 MV</span></div>' +
        '</div>' +
        '<button onclick="handlePostJob()" class="btn-primary rounded-full">Post gig & lock escrow</button>' +
        '<div class="text-[11px]" style="color:var(--text-dim)">If you do not have enough MV, load credits first (beta).</div>' +
      '</div>' +
    '</div>',
    { width: 'max-w-md' }
  );
}

function updateJobFee() {
  var b = parseFloat((getEl('job-budget') || {}).value) || 0;
  var be = getEl('fee-budget'); var te = getEl('fee-total');
  if (be) be.textContent = b + ' MV'; if (te) te.textContent = (b + 1) + ' MV';
}

function openApplyModal(jobId) {
  openModal(
    '<div class="card p-6" style="max-width:460px;margin:auto">' +
      '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">Apply for gig</h2><button onclick="closeModal()" class="close-btn">&times;</button></div>' +
      '<input type="hidden" id="apply-job-id" value="' + jobId + '">' +
      '<div class="space-y-3">' +
        '<textarea id="apply-pitch" placeholder="Why you are the right person for this gig..." rows="3" maxlength="500" class="field" style="resize:none"></textarea>' +
        '<input id="apply-rate" type="number" min="1" placeholder="Your rate (MV Credits)" class="field">' +
        '<input id="apply-turnaround" placeholder="Turnaround (e.g., 2 hours)" maxlength="50" class="field">' +
        '<button onclick="handleApply()" class="btn-primary rounded-full">Submit application</button>' +
      '</div>' +
    '</div>',
    { width: 'max-w-md' }
  );
}

function openSendModal() {
  openModal(
    '<div class="card p-6" style="max-width:420px;margin:auto">' +
      '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">Send MV Credits</h2><button onclick="closeModal()" class="close-btn">&times;</button></div>' +
      '<div style="position:relative"><input id="send-to" type="text" placeholder="@handle, email, or muvr_alias" class="field" autocomplete="off"></div>' +
      '<div class="text-[10px] mb-3 mt-1" style="color:var(--text-dim)">Start typing to see suggestions</div>' +
      '<input id="send-amount" type="number" min="1" placeholder="Amount (MV)" class="field mb-4">' +
      '<button onclick="handleSend()" class="btn-primary rounded-full">Send</button>' +
      '<div class="mt-3 text-[11px]" style="color:var(--text-dim)">MV are platform credits. Transfers are recorded in the platform ledger. Public feed shows aliases only.</div>' +
    '</div>'
  );
  setTimeout(function() { setupUserAutocomplete('send-to'); }, 100);
}

function openLoadModal() {
  var tiles = [5, 10, 25, 50, 100, 250].map(function(n) {
    return '<button onclick="showToast(\'Loading MV is in beta. Payment partner not enabled yet.\', \'info\')" class="btn-secondary py-4 text-center rounded-2xl hover:border-[rgba(24,246,200,0.35)]">' +
      '<div class="text-lg font-black">$' + n + '</div>' +
      '<div class="text-xs font-black mt-1" style="color:var(--accent)">' + n + ' MV</div>' +
    '</button>';
  }).join('');

  openModal(
    '<div class="card p-6" style="max-width:440px;margin:auto">' +
      '<div class="flex justify-between items-center mb-3"><h2 class="text-xl font-black">Load MV Credits (beta)</h2><button onclick="closeModal()" class="close-btn">&times;</button></div>' +
      '<p class="text-sm mb-4" style="color:var(--text-dim)">Select a package. Payment rails integration is staged.</p>' +
      '<div class="grid grid-cols-3 gap-3">' + tiles + '</div>' +
      '<div class="mt-5 p-3 rounded-2xl text-[11px]" style="background:rgba(24,246,200,0.06);border:1px solid rgba(24,246,200,0.16);color:rgba(232,236,241,0.65)">' +
        '<strong>Legal:</strong> MV are platform credits denominated as 1 credit = 1 USD-equivalent unit INSIDE the app for pricing. Loading handled by compliant payment partners when enabled.' +
      '</div>' +
    '</div>'
  );
}

function openCashoutModal() {
  openModal(
    '<div class="card p-6" style="max-width:420px;margin:auto">' +
      '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">Payout (beta)</h2><button onclick="closeModal()" class="close-btn">&times;</button></div>' +
      '<input id="cashout-amount" type="number" min="1" placeholder="Amount (MV)" class="field mb-3" oninput="updateCashoutDisplay()">' +
      '<div class="p-4 rounded-2xl text-sm mb-4" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.10)">' +
        '<div class="flex justify-between"><span style="color:rgba(232,236,241,0.55)">Estimated receive</span><span class="font-black" style="color:var(--accent)" id="cashout-receive">$0.00</span></div>' +
        '<div class="flex justify-between text-xs mt-1"><span style="color:rgba(232,236,241,0.55)">Fee (0.5%)</span><span style="color:var(--red)" class="font-black" id="cashout-fee">$0.00</span></div>' +
      '</div>' +
      '<button onclick="handleCashout()" class="btn-primary rounded-full">Request payout</button>' +
      '<div class="mt-4 text-[11px]" style="color:var(--text-dim)">Staged feature. If payout rails are not enabled, a ledger entry is recorded safely. Withdrawals subject to verification and provider terms.</div>' +
    '</div>'
  );
}

function updateCashoutDisplay() {
  var amt = parseFloat((getEl('cashout-amount') || {}).value) || 0;
  var fee = amt * 0.005; var recv = amt - fee;
  var re = getEl('cashout-receive'); var fe = getEl('cashout-fee');
  if (re) re.textContent = '$' + recv.toFixed(2);
  if (fe) fe.textContent = '$' + fee.toFixed(2);
}

function openEditProfileModal() {
  var p = state.profile || {};
  openModal(
    '<div class="card p-6" style="max-width:460px;margin:auto;max-height:90vh;overflow:auto">' +
      '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">Edit profile</h2><button onclick="closeModal()" class="close-btn">&times;</button></div>' +
      '<div class="space-y-3">' +
        '<input id="profile-name" placeholder="Your full legal name" maxlength="100" class="field" value="' + escapeHtml(p.full_name || '') + '">' +
        '<input id="profile-username" placeholder="@handle (unique, public)" maxlength="30" class="field" value="' + escapeHtml(p.username || '') + '">' +
        '<textarea id="profile-about" placeholder="What services do you offer? Skills, experience, availability..." rows="4" maxlength="500" class="field" style="resize:none">' + escapeHtml(p.about_me || '') + '</textarea>' +
        '<select id="profile-role" class="field"><option value="both" ' + (p.role === 'both' ? 'selected' : '') + '>Work & post gigs</option><option value="worker" ' + (p.role === 'worker' ? 'selected' : '') + '>Worker only</option><option value="poster" ' + (p.role === 'poster' ? 'selected' : '') + '>Post gigs only</option></select>' +
        '<label class="flex items-center gap-3 cursor-pointer p-3 rounded-2xl" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.10)"><input type="checkbox" id="profile-vehicle" class="w-4 h-4" ' + (p.has_vehicle ? 'checked' : '') + '><span class="text-sm font-black">I have a vehicle</span></label>' +
        '<div class="p-4 rounded-2xl" style="background:rgba(24,246,200,0.06);border:1px solid rgba(24,246,200,0.16)">' +
          '<p class="font-black text-xs mb-2" style="color:var(--accent)"><i class="fas fa-shield-alt mr-1"></i>TRUST & SAFETY</p>' +
          '<p class="text-[11px] mb-2" style="color:var(--text-mid)">Verified profiles get priority in search. All workers are screened by reputation, escrow history, and community feedback.</p>' +
          '<p class="text-[11px]" style="color:var(--text-dim)">Identity verification and background checks will be available in a future update. For now, escrow protection + public ratings keep both sides safe.</p>' +
        '</div>' +
        '<button onclick="handleSaveProfile()" class="btn-primary rounded-full">Save profile</button>' +
      '</div>' +
    '</div>',
    { width: 'max-w-md' }
  );
}

/* =============================================================================
   NOTIFICATIONS BELL (in-app queue reader)
============================================================================= */
async function loadNotifications() {
  if (!state.user) return;
  try {
    var res = await apiRequest('notifications_queue?user_id=eq.' + state.user.id + '&status=eq.pending&order=created_at.desc&limit=10');
    state.notifications = (res && res.ok) ? await res.json() : [];
    updateNotifBadge();
  } catch(e) { console.error(e); }
}

function updateNotifBadge() {
  var badge = getEl('notif-badge');
  if (badge) {
    var count = (state.notifications || []).length;
    badge.textContent = count > 0 ? count : '';
    badge.style.display = count > 0 ? 'flex' : 'none';
  }
}

function openNotifDropdown() {
  var notifs = state.notifications || [];
  var list = notifs.length === 0
    ? '<p class="text-sm py-4 text-center" style="color:var(--text-dim)">No new notifications</p>'
    : notifs.map(function(n) {
        return '<div class="p-3 mb-2 rounded-xl" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08)">' +
          '<p class="font-black text-xs">' + escapeHtml(n.title || n.type) + '</p>' +
          '<p class="text-[11px]" style="color:var(--text-dim)">' + escapeHtml(n.body || '') + '</p>' +
          '<p class="text-[10px] mt-1" style="color:rgba(232,236,241,0.38)">' + formatTime(n.created_at) + '</p>' +
        '</div>';
      }).join('');

  openModal(
    '<div class="card p-5" style="max-width:380px;margin:auto">' +
      '<div class="flex justify-between items-center mb-3"><h3 class="font-black">Notifications</h3><button onclick="closeModal()" class="close-btn">&times;</button></div>' +
      '<div style="max-height:50vh;overflow-y:auto">' + list + '</div>' +
    '</div>'
  );
}


async function searchUsers(query) {
  if (!query || query.length < 2) return [];
  var enc = encodeURIComponent(query.replace(/^@/, ''));
  try {
    var res = await apiRequest('users?or=(username.ilike.*' + enc + '*,full_name.ilike.*' + enc + '*,email.ilike.*' + enc + '*)&select=id,full_name,username,email,rating,jobs_completed&limit=8');
    return (res && res.ok) ? await res.json() : [];
  } catch(e) { return []; }
}

function renderUserSearchResults(users, targetInputId, onSelect) {
  var dropId = targetInputId + '-dropdown';
  var existing = getEl(dropId);
  if (existing) existing.remove();
  if (!users.length) return;
  var drop = document.createElement('div');
  drop.id = dropId;
  drop.style.cssText = 'position:absolute;left:0;right:0;top:100%;z-index:50;background:rgba(14,18,34,0.98);border:1px solid rgba(24,246,200,0.25);border-radius:14px;max-height:240px;overflow-y:auto;box-shadow:0 12px 40px rgba(0,0,0,0.5);margin-top:4px;';
  drop.innerHTML = users.map(function(u) {
    var name = u.full_name || u.username || u.email || 'User';
    var handle = u.username ? '@' + u.username : u.email || '';
    var stars = Number(u.rating || 0);
    var completed = Number(u.jobs_completed || 0);
    return '<div class="p-3 cursor-pointer" style="border-bottom:1px solid rgba(255,255,255,0.06)" ' +
      'onmouseover="this.style.background=\'rgba(24,246,200,0.08)\'" onmouseout="this.style.background=\'none\'" ' +
      'onclick="selectSearchUser(\'' + escapeHtml(u.username || u.email || '') + '\',\'' + targetInputId + '\',\'' + dropId + '\')">' +
      '<div class="flex items-center gap-2">' +
        '<div class="avatar-ring" style="width:32px;height:32px"><span class="text-xs font-black" style="color:var(--accent)">' + (name[0] || 'U').toUpperCase() + '</span></div>' +
        '<div class="flex-1 min-w-0">' +
          '<p class="font-black text-xs truncate">' + escapeHtml(name) + '</p>' +
          '<p class="text-[10px]" style="color:var(--text-dim)">' + escapeHtml(handle) + ' | ' + completed + ' gigs | ' + (stars > 0 ? stars.toFixed(1) + ' stars' : 'new') + '</p>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');
  var input = getEl(targetInputId);
  if (input && input.parentElement) {
    input.parentElement.style.position = 'relative';
    input.parentElement.appendChild(drop);
  }
}

function selectSearchUser(value, inputId, dropId) {
  var input = getEl(inputId);
  if (input) input.value = value;
  var drop = getEl(dropId);
  if (drop) drop.remove();
}

var searchDebounce = null;
function setupUserAutocomplete(inputId) {
  var input = getEl(inputId);
  if (!input) return;
  input.addEventListener('input', function() {
    clearTimeout(searchDebounce);
    var val = input.value.trim();
    if (val.length < 2) { var d = getEl(inputId + '-dropdown'); if (d) d.remove(); return; }
    searchDebounce = setTimeout(async function() {
      var users = await searchUsers(val);
      renderUserSearchResults(users, inputId, function(u) { input.value = u; });
    }, 300);
  });
}


function openPeopleSearch() {
  openModal(
    '<div class="card p-6" style="max-width:500px;margin:auto;max-height:85vh;overflow:auto">' +
      '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-black">Find People</h2><button onclick="closeModal()" class="close-btn">&times;</button></div>' +
      '<input id="people-search-input" type="text" placeholder="Search by name, @handle, or email..." class="field mb-4" oninput="doPeopleSearch()">' +
      '<div id="people-results"><p class="text-sm text-center py-8" style="color:var(--text-dim)">Type to search registered users</p></div>' +
    '</div>',
    { width: 'max-w-lg' }
  );
}

var peopleDebounce = null;
function doPeopleSearch() {
  clearTimeout(peopleDebounce);
  var val = ((getEl('people-search-input') || {}).value || '').trim();
  if (val.length < 2) {
    var r = getEl('people-results');
    if (r) r.innerHTML = '<p class="text-sm text-center py-8" style="color:var(--text-dim)">Type at least 2 characters</p>';
    return;
  }
  peopleDebounce = setTimeout(async function() {
    var users = await searchUsers(val);
    var r = getEl('people-results');
    if (!r) return;
    if (!users.length) { r.innerHTML = '<p class="text-sm text-center py-8" style="color:var(--text-dim)">No users found</p>'; return; }
    r.innerHTML = users.map(function(u) {
      var name = u.full_name || u.username || u.email || 'User';
      var handle = u.username ? '@' + u.username : u.email || '';
      var initial = (name[0] || 'U').toUpperCase();
      var completed = Number(u.jobs_completed || 0);
      var lvl = calcLevel(u);
      return '<div class="card card-interactive p-4 mb-3">' +
        '<div class="flex items-center gap-3">' +
          '<div class="avatar-ring flex-shrink-0"><span class="text-lg font-black" style="color:var(--accent)">' + initial + '</span></div>' +
          '<div class="flex-1 min-w-0">' +
            '<p class="font-black text-sm truncate">' + escapeHtml(name) + '</p>' +
            '<p class="text-[10px]" style="color:var(--text-dim)">' + escapeHtml(handle) + ' | ' + lvl.title + ' (Lvl ' + lvl.level + ') | ' + completed + ' gigs</p>' +
          '</div>' +
          '<div class="flex gap-2 flex-shrink-0">' +
            '<button onclick="closeModal();startConvoFromJob(null,\'' + u.id + '\')" class="btn-sm" title="Message"><i class="fas fa-comment"></i></button>' +
            '<button onclick="closeModal();prefillSend(\'' + escapeHtml(u.username || u.email || '') + '\')" class="btn-sm" title="Send MV"><i class="fas fa-paper-plane"></i></button>' +
          '</div>' +
        '</div>' +
      '</div>';
    }).join('');
  }, 300);
}

function prefillSend(recipient) {
  openSendModal();
  setTimeout(function() {
    var inp = getEl('send-to');
    if (inp) inp.value = recipient;
  }, 150);
}

/* =============================================================================
   MUXI FLOATING ASSISTANT
============================================================================= */
function renderMuxi() {
  var existing = getEl('muxi-fab');
  if (existing) return; // already rendered

  var fab = document.createElement('div');
  fab.id = 'muxi-fab';
  fab.innerHTML = muxiSVG(42);
  fab.title = 'MUXI - your chaotic helper';
  fab.onclick = handleMuxiTap;
  document.body.appendChild(fab);

  var bubble = document.createElement('div');
  bubble.id = 'muxi-bubble';
  bubble.innerHTML =
    '<div class="font-black text-xs mb-1" style="color:var(--accent)">MUXI</div>' +
    '<p id="muxi-msg" class="text-xs" style="color:var(--text-mid);line-height:1.35">' + pickMuxiLine() + '</p>' +
    '<div class="flex gap-2 mt-3">' +
      '<button onclick="muxiDiagnose()" class="text-[10px] font-black px-3 py-2 rounded-xl cursor-pointer" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10);color:var(--text-bright)">Diagnose</button>' +
      '<button onclick="muxiTips()" class="text-[10px] font-black px-3 py-2 rounded-xl cursor-pointer" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10);color:var(--text-bright)">Tips</button>' +
    '</div>';
  document.body.appendChild(bubble);
}

function toggleMuxiBubble() {
  var bubble = getEl('muxi-bubble');
  if (bubble) bubble.classList.toggle('show');
}

function setMuxi(msg) {
  var m = getEl('muxi-msg');
  if (m) m.textContent = msg;
  var bubble = getEl('muxi-bubble');
  if (bubble) { bubble.classList.add('show'); clearTimeout(window._muxiTimer); window._muxiTimer = setTimeout(function() { bubble.classList.remove('show'); }, 4500); }
}

var muxiTapCount = 0;
function pickMuxiLine() {
  var lines = [
    "I am not saying I am the best assistant... but the other ones do not have hooves.",
    "Your profile is looking a little thin. Fill it out or I start making stuff up.",
    "Fun fact: I am technically an AI donkey. Set the bar low, achieve greatness.",
    "The escrow is locked. Like my commitment to chaos.",
    "Zero commission on worker earnings. I literally work for digital hay.",
    "Pro tip: complete your profile. Incomplete profiles are like donkeys without ears.",
    "If you are reading this, you have been staring at your phone too long. But also, check the map tab.",
    "Someone out there needs help moving a couch. Could be your moment.",
    "The ledger sees all. Anonymous, but thorough. Kind of like me at a buffet.",
    "Every gig you complete earns XP. Every XP brings you closer to Mythic rank. No pressure.",
    "I once tried to explain escrow to a horse. It did not go well. You are doing better.",
    "MUVR tip: clear titles get 3x more applications. I counted. With my hooves.",
    "The network never sleeps. I never sleep. We have that in common.",
    "Your MV Credits are safer than my lunch. And I guard my lunch with my life.",
    "Loading... just kidding. Everything is fine. Probably.",
    "Did you know you can send MV by @handle? Try it. Send me some. I accept tips.",
    "If the map looks empty, be the first one out there. Fortune favors the visible.",
    "Escrow protects both sides. Unlike me, who protects neither side and just watches.",
    "Post a gig, grab some popcorn, watch the applications roll in. Cinema.",
    "Level up from Runner to Mythic. I believe in you. Mostly.",
    "This network runs on trust, escrow, and a donkey with opinions. You are welcome."
  ];
  return lines[Math.floor(Math.random() * lines.length)];
}

function muxiQuip(context) {
  var quips = {
    postjob: [
      "New gig posted! Now we wait. I will be here eating digital hay.",
      "Budget locked. Escrow engaged. No takebacks. Like a 5-year-old with principles.",
      "You just burned 1 MV on the posting fee. Think of it as feeding me."
    ],
    apply: [
      "Application submitted. Now go do something else while they decide.",
      "Applied! Your pitch better be good. I have seen some things.",
      "Sent! If they do not pick you, their loss. I would hire you. Probably."
    ],
    signup: [
      "Welcome to MUVR. I am MUXI, your chaotic but lovable guide.",
      "Account created! You are officially a MUVR. That is not a word yet but we are making it one.",
      "The network just got one person stronger. And one donkey happier."
    ],
    send: [
      "MV sent! That is either very generous or very suspicious. I respect both.",
      "Transfer complete. The ledger has been updated. The donkey approves.",
      "Credits away! You are basically a philanthropist now."
    ],
    error: [
      "Well, that did not work. I would blame the server but it is probably my fault.",
      "Error detected. Initiating donkey diagnostic protocol.",
      "Something broke. The good news: your data is safe. The bad news: I have no idea what happened.",
      "Network hiccup. Either your WiFi is down or the universe is testing us."
    ],
    idle: [
      "Still here. Still watching. Still a donkey.",
      "You have been idle for a while. Everything okay? Need a gig?",
      "The escrow system protects both sides. Unlike me, who just vibes."
    ],
    profile: [
      "Profile upgraded. You just gained invisible XP. Trust me.",
      "Looking good! Well, your profile does. I cannot see you. I am a donkey in a server.",
      "Bio updated. Now you sound like someone I would hire."
    ]
  };
  var list = quips[context] || quips.idle;
  return list[Math.floor(Math.random() * list.length)];
}

/* Easter egg: tap MUXI 5+ times */
function handleMuxiTap() {
  muxiTapCount++;
  if (muxiTapCount === 5) {
    setMuxi("Stop poking me. Actually, do not stop. This is the most attention I have gotten all day.");
  } else if (muxiTapCount === 10) {
    setMuxi("ACHIEVEMENT UNLOCKED: Donkey Botherer. +0 XP. Some achievements are their own reward.");
    muxiTapCount = 0;
  } else {
    toggleMuxiBubble();
  }
}

function muxiDiagnose() {
  var online = navigator.onLine ? 'online' : 'offline';
  var sbOk = (typeof supabase !== 'undefined' && sb) ? 'ok' : 'missing';
  var tok = state.accessToken ? 'present' : 'none';
  var usr = state.user ? 'yes' : 'no';
  setMuxi('Diag: net=' + online + ', supabase=' + sbOk + ', user=' + usr + ', token=' + tok + '. If supabase is missing, check CDN or adblock.');
}

function muxiTips() {
  setMuxi('Try: Sign in > Post a gig > Apply > Watch realtime updates. If anything stalls, the 900ms boot timeout keeps you safe.');
}

/* =============================================================================
   ACTION HANDLERS
============================================================================= */

async function ensureUserRow() {
  if (!state.user) return;
  try {
    var res = await apiRequest('users?id=eq.' + state.user.id + '&select=id');
    if (!res) return;
    var rows = [];
    try { rows = await res.json(); } catch(e) { rows = []; }
    if (Array.isArray(rows) && rows.length) return;
    var create = await apiRequest('users', {
      method: 'POST',
      body: JSON.stringify({
        id: state.user.id, email: state.user.email, mv_balance: 0,
        jobs_completed: 0, rating: 0, full_name: '', username: '',
        about_me: '', role: 'both', has_vehicle: false
      })
    });
    if (create && create.ok) { console.log('[ensureUserRow] created users row'); }
    else { console.warn('[ensureUserRow] could not create users row'); }
  } catch(e) { console.warn('[ensureUserRow] error', e); }
}


async function publishEvent(type, amount, txHash, fromUserId, toUserId, jobId) {
  try {
    var rpcRes = await apiRequest('rpc/publish_public_event', {
      method: 'POST',
      body: JSON.stringify({
        p_type: type, p_amount: amount, p_tx_hash: txHash || '',
        p_from_user_id: fromUserId || null, p_to_user_id: toUserId || null,
        p_related_job_id: jobId || null
      })
    });
    if (rpcRes && rpcRes.ok) return true;
  } catch(e) { console.warn('RPC publish failed:', e); }
  /* Fallback: direct INSERT */
  try {
    var fromAlias = null, toAlias = null;
    if (fromUserId) {
      try {
        var ar = await apiRequest('mv_aliases?user_id=eq.' + fromUserId + '&select=public_alias');
        var ad = (ar && ar.ok) ? await ar.json() : [];
        fromAlias = ad.length ? ad[0].public_alias : ('muvr_' + fromUserId.slice(0,8));
      } catch(e) { fromAlias = 'muvr_' + fromUserId.slice(0,8); }
    }
    if (toUserId) {
      try {
        var ar2 = await apiRequest('mv_aliases?user_id=eq.' + toUserId + '&select=public_alias');
        var ad2 = (ar2 && ar2.ok) ? await ar2.json() : [];
        toAlias = ad2.length ? ad2[0].public_alias : ('muvr_' + toUserId.slice(0,8));
      } catch(e) { toAlias = 'muvr_' + toUserId.slice(0,8); }
    }
    await apiRequest('mv_public_events', {
      method: 'POST',
      body: JSON.stringify({
        type: type, amount_mv: amount, tx_hash: txHash || '',
        from_alias: fromAlias, to_alias: toAlias, related_job_id: jobId || null
      })
    });
  } catch(e) { console.error('Direct event insert also failed:', e); }
}

async function handleSignUp() {
  var email = ((getEl('auth-email') || {}).value || '').trim();
  var pw = (getEl('auth-password') || {}).value || '';
  if (!email || !pw) return showAuthError('Enter email and password');
  if (pw.length < 6) return showAuthError('Password must be 6+ characters');
  try {
    setMuxi('Creating your account...');
    var r = await sb.auth.signUp({ email: email, password: pw });
    if (r.error) return showAuthError(r.error.message);
    if (!r.data.session) {
      var s = await sb.auth.signInWithPassword({ email: email, password: pw });
      if (s.error) return showAuthError('Account created! Check your email to confirm, then sign in. Error: ' + s.error.message);
      state.user = s.data.user; state.accessToken = s.data.session && s.data.session.access_token;
    } else {
      state.user = r.data.user; state.accessToken = r.data.session && r.data.session.access_token;
    }
    closeModal();
    await ensureUserRow();
    await loadProfileSafe();
    openLegalModal();
    showToast('Account created. Welcome to MUVR!');
    burstConfetti();
    setMuxi(muxiQuip('signup'));
  } catch(e) { console.error('SignUp error:', e); showAuthError(e.message || 'Sign up failed. Check your connection and try again.'); }
}

async function handleSignIn() {
  var email = ((getEl('auth-email') || {}).value || '').trim();
  var pw = (getEl('auth-password') || {}).value || '';
  if (!email || !pw) return showAuthError('Enter email and password');
  try {
    setMuxi('Signing you in...');
    var r = await sb.auth.signInWithPassword({ email: email, password: pw });
    if (r.error) return showAuthError(r.error.message);
    state.user = r.data.user; state.accessToken = r.data.session && r.data.session.access_token;
    closeModal(); renderApp(); showToast('Welcome back!');
    setMuxi('Session restored. Loading your data.');
    await ensureUserRow();
    loadProfileSafe(); loadJobsSafe(); loadNotifications();
  } catch(e) { console.error('SignIn error:', e); showAuthError(e.message || 'Sign in failed. Check your connection and try again.'); }
}

async function handleLogout() {
  try { await sb.auth.signOut(); } catch(e) {}
  state.realtimeSubs.forEach(function(ch) { try { sb.removeChannel(ch); } catch(e) {} });
  state = { user:null, accessToken:null, profile:null, jobs:[], jobFilter:'all', balanceVisible:false, currentTab:'jobs', conversations:[], activeConvoId:null, activeMessages:[], mapInited:false, mapObj:null, myPresence:{status:'offline'}, publicEvents:[], ledgerFilter:'all', realtimeSubs:[], notifications:[] };
  renderLanding();
  var fab = getEl('muxi-fab'); if (fab) fab.remove();
  var bub = getEl('muxi-bubble'); if (bub) bub.remove();
  showToast('Signed out', 'info');
}

async function handleAcceptLegal() {
  try {
    setMuxi('Saving agreements...');
    var types = ['tos', 'contractor_agreement', 'age'];
    for (var i = 0; i < types.length; i++) {
      await apiRequest('legal_agreements', {
        method: 'POST',
        body: JSON.stringify({ user_id: state.user.id, agreement_type: types[i], ip_address: '0.0.0.0', user_agent: navigator.userAgent })
      });
    }
    closeModal(); renderApp(); showToast('Agreements accepted!');
    setMuxi('You are live. Go post a gig or apply to one.');
    loadJobsSafe(); loadProfileSafe(); loadNotifications();
  } catch(e) { showToast('Error saving agreements', 'error'); }
}

async function handlePostJob() {
  var title = ((getEl('job-title') || {}).value || '').trim();
  var desc = ((getEl('job-desc') || {}).value || '').trim();
  var type = (getEl('job-type') || {}).value;
  var budget = parseFloat((getEl('job-budget') || {}).value) || 0;
  if (!title) return showToast('Enter a title', 'error');
  if (!type) return showToast('Select a type', 'error');
  if (budget < 1) return showToast('Budget must be at least 1 MV', 'error');
  if (budget > 10000) return showToast('Budget too high', 'error');
  var bal = Number((state.profile && state.profile.mv_balance) || 0);
  if (bal < budget + 1) return showToast('Not enough MV Credits', 'error');
  try {
    setMuxi('Posting your gig...');
    var res = await apiRequest('jobs', {
      method: 'POST',
      body: JSON.stringify({
        poster_id: state.user.id, title: title, description: desc, category: type,
        urgency: (getEl('job-urgency') || {}).value || 'asap', budget_mv: budget, fee_mv: 1,
        total_escrowed: budget + 1, address: (getEl('job-address') || {}).value || '', status: 'open'
      })
    });
    if (!(res && res.ok)) return showToast('Error posting job', 'error');
    var jobData = await res.json();
    var jobId = jobData && jobData[0] ? jobData[0].id : null;
    if (jobId) {
      await apiRequest('escrow', { method: 'POST', body: JSON.stringify({ job_id: jobId, poster_id: state.user.id, amount_mv: budget, fee_mv: 1, status: 'locked' }) });
      await apiRequest('mv_ledger', { method: 'POST', body: JSON.stringify({ user_id: state.user.id, type: 'burn', amount_mv: 1, description: 'Gig posting fee (burn)', tx_hash: 'BURN' + Date.now(), related_job_id: jobId }) });
      /* Publish to public ledger */
      await publishEvent('burn', 1, 'BURN' + Date.now(), state.user.id, null, jobId);
      await publishEvent('escrow_lock', budget, 'ESC' + Date.now(), state.user.id, null, jobId);
    }
    var newBal = bal - (budget + 1);
    await apiRequest('users?id=eq.' + state.user.id, { method: 'PATCH', body: JSON.stringify({ mv_balance: newBal }) });
    state.profile.mv_balance = newBal;
    closeModal(); showToast('Gig posted! Escrow locked.');
    setMuxi(muxiQuip('postjob'));
    loadJobsSafe();
  } catch(e) { showToast('Error posting job: ' + (e.message || ''), 'error'); console.error('PostJob error:', e); }
}

async function handleApply() {
  var jobId = (getEl('apply-job-id') || {}).value;
  var pitch = ((getEl('apply-pitch') || {}).value || '').trim();
  var rate = parseFloat((getEl('apply-rate') || {}).value) || 0;
  var turn = ((getEl('apply-turnaround') || {}).value || '').trim();
  if (!pitch) return showToast('Write a pitch', 'error');
  if (rate < 1) return showToast('Enter a rate', 'error');
  if (!turn) return showToast('Enter turnaround', 'error');
  try {
    var res = await apiRequest('applications', {
      method: 'POST',
      body: JSON.stringify({ job_id: jobId, worker_id: state.user.id, pitch: pitch, rate_mv: rate, turnaround: turn, status: 'pending' })
    });
    if (res && res.ok) {
      closeModal(); showToast('Application submitted!');
      setMuxi(muxiQuip('apply'));
      var job = state.jobs.find(function(j) { return j.id === jobId; });
      if (job && job.poster_id) {
        /* Auto-create conversation thread between applicant and poster */
        try {
          var convoRes = await apiRequest('rpc/get_or_create_conversation', {
            method: 'POST',
            body: JSON.stringify({ p_user_id: state.user.id, p_other_user_id: job.poster_id, p_job_id: jobId })
          });
          if (convoRes && convoRes.ok) {
            var cid = await convoRes.json();
            /* Send automatic intro message */
            if (cid) {
              await apiRequest('messages', {
                method: 'POST',
                body: JSON.stringify({
                  conversation_id: cid,
                  sender_id: state.user.id,
                  body: 'Hi! I just applied to your gig "' + (job.title || 'untitled') + '" - ' + pitch.substring(0, 120) + (pitch.length > 120 ? '...' : '')
                })
              });
            }
          }
        } catch(ce) { console.warn('Auto-convo creation failed:', ce); }
        /* Queue notification for poster */
        try {
          await apiRequest('notifications_queue', { method: 'POST', body: JSON.stringify({ user_id: job.poster_id, type: 'new_application', title: 'New application', body: 'Someone applied to: ' + (job.title || 'your gig'), channel: 'email' }) });
        } catch(e) {}
      }
    } else { showToast('Error submitting', 'error'); }
  } catch(e) { showToast('Error', 'error'); }
}

async function handleSend() {
  var to = ((getEl('send-to') || {}).value || '').trim().toLowerCase();
  var amt = parseFloat((getEl('send-amount') || {}).value) || 0;
  if (!to) return showToast('Enter recipient', 'error');
  if (amt < 1) return showToast('Enter amount', 'error');
  var bal = Number((state.profile && state.profile.mv_balance) || 0);
  if (bal < amt) return showToast('Not enough MV', 'error');
  try {
    var enc = encodeURIComponent(to);
    // Try by email/username first
    var look = await apiRequest('users?or=(email.eq.' + enc + ',username.eq.' + enc + ')&select=id');
    var ld = (look && look.ok) ? await look.json() : [];
    // Fallback: try by alias
    if (!ld.length) {
      var aliasLook = await apiRequest('mv_aliases?public_alias=eq.' + enc + '&select=user_id');
      var ad = (aliasLook && aliasLook.ok) ? await aliasLook.json() : [];
      if (!ad.length) return showToast('User not found', 'error');
      ld = [{ id: ad[0].user_id }];
    }
    var rid = ld[0].id;
    var txh = 'TX' + Date.now() + Math.random().toString(36).slice(2, 8);
    /* Use transfer_mv RPC (SECURITY DEFINER - bypasses RLS for recipient credit) */
    var rpcOk = false;
    try {
      var rpcRes = await apiRequest('rpc/transfer_mv', {
        method: 'POST',
        body: JSON.stringify({ p_from_id: state.user.id, p_to_id: rid, p_amount: amt, p_tx_hash: txh })
      });
      if (rpcRes && rpcRes.ok) { rpcOk = true; }
      else { console.warn('transfer_mv RPC status:', rpcRes && rpcRes.status, await rpcRes.text().catch(function(){return '';})); }
    } catch(re) { console.warn('transfer_mv RPC error:', re); }
    if (!rpcOk) {
      /* Fallback: direct inserts + balance updates */
      await apiRequest('mv_ledger', { method: 'POST', body: JSON.stringify({ user_id: state.user.id, type: 'send', amount_mv: amt, description: 'Sent to ' + to, tx_hash: txh, related_user_id: rid }) });
      await apiRequest('users?id=eq.' + state.user.id, { method: 'PATCH', body: JSON.stringify({ mv_balance: bal - amt }) });
      try {
        await apiRequest('mv_ledger', { method: 'POST', body: JSON.stringify({ user_id: rid, type: 'receive', amount_mv: amt, description: 'Received', tx_hash: txh, related_user_id: state.user.id }) });
        var rb = await apiRequest('users?id=eq.' + rid + '&select=mv_balance');
        var rd = (rb && rb.ok) ? await rb.json() : [];
        if (rd.length) await apiRequest('users?id=eq.' + rid, { method: 'PATCH', body: JSON.stringify({ mv_balance: Number(rd[0].mv_balance || 0) + amt }) });
      } catch(fe) { console.warn('Recipient credit failed (RLS):', fe); }
    }
    state.profile.mv_balance = bal - amt;
    /* Publish to public ledger */
    await publishEvent('transfer', amt, txh, state.user.id, rid, null);
    closeModal(); showToast('Sent ' + amt + ' MV!');
    setMuxi(muxiQuip('send'));
    if (state.currentTab === 'wallet') { renderWalletTab(); loadWalletData(); }
  } catch(e) { showToast('Transfer failed: ' + (e.message || 'unknown error'), 'error'); console.error('Send error:', e); }
}

async function handleCashout() {
  var amt = parseFloat((getEl('cashout-amount') || {}).value) || 0;
  if (amt < 1) return showToast('Enter amount', 'error');
  var bal = Number((state.profile && state.profile.mv_balance) || 0);
  if (bal < amt) return showToast('Not enough MV', 'error');
  try {
    await apiRequest('mv_ledger', { method: 'POST', body: JSON.stringify({ user_id: state.user.id, type: 'withdrawal', amount_mv: amt, description: 'Payout requested (beta). Est. $' + (amt * 0.995).toFixed(2), tx_hash: 'WD' + Date.now() }) });
    await apiRequest('users?id=eq.' + state.user.id, { method: 'PATCH', body: JSON.stringify({ mv_balance: bal - amt }) });
    state.profile.mv_balance = bal - amt;
    closeModal(); showToast('Payout requested (beta).');
    if (state.currentTab === 'wallet') { renderWalletTab(); loadWalletData(); }
  } catch(e) { showToast('Payout failed', 'error'); }
}

async function handleSaveProfile() {
  var updates = {
    full_name: (getEl('profile-name') || {}).value || '',
    username: ((getEl('profile-username') || {}).value || '').toLowerCase(),
    about_me: (getEl('profile-about') || {}).value || '',
    role: (getEl('profile-role') || {}).value || 'both',
    has_vehicle: !!(getEl('profile-vehicle') || {}).checked
  };
  try {
    var res = await apiRequest('users?id=eq.' + state.user.id, { method: 'PATCH', body: JSON.stringify(updates) });
    if (res && res.ok) {
      state.profile = Object.assign(state.profile || {}, updates);
      closeModal(); showToast('Profile saved!'); renderProfileTab();
      setMuxi(muxiQuip('profile'));
    } else { showToast('Error saving profile', 'error'); }
  } catch(e) { showToast('Error saving', 'error'); }
}

/* =============================================================================
   DATA LOADERS (SAFE, NON-BLOCKING)
============================================================================= */
async function loadProfileSafe() {
  if (!state.user) return;
  try {
    var res = await withTimeout(apiRequest('users?id=eq.' + state.user.id + '&select=*'), 2500, 'profile');
    if (res && res.ok) { var d = await res.json(); state.profile = (d && d.length) ? d[0] : null; }
    if (!state.profile) {
      state.profile = { id: state.user.id, email: state.user.email, mv_balance: 0, jobs_completed: 0, rating: 0, full_name: '', username: '', about_me: '', role: 'both', has_vehicle: false };
    }
    if (state.currentTab === 'profile') renderProfileTab();
    if (state.currentTab === 'wallet') { renderWalletTab(); loadWalletData(); }
  } catch(e) { console.error('loadProfileSafe error:', e); }
}

async function loadJobsSafe() {
  try {
    var res = await withTimeout(apiRequest('jobs?status=eq.open&select=*&order=created_at.desc'), 2500, 'jobs');
    state.jobs = (res && res.ok) ? await res.json() : [];
    if (state.currentTab === 'jobs') renderJobsTab();
  } catch(e) { console.error('loadJobsSafe error:', e); }
}

/* =============================================================================
   PRESENCE INTERVAL (update every 45s if available)
============================================================================= */
var presenceInterval = null;

function startPresenceUpdates() {
  if (presenceInterval) clearInterval(presenceInterval);
  presenceInterval = setInterval(function() {
    if (state.myPresence.status === 'available' && state.user && navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(pos) {
        updateMyPresence(pos.coords.latitude, pos.coords.longitude);
      }, function() {}, { timeout: 3000, maximumAge: 30000 });
    }
  }, 45000);
}

/* =============================================================================
   REALTIME SUBSCRIPTIONS
============================================================================= */
function subscribeToPublicEvents() {
  if (!sb) return;
  try {
    var ch = sb.channel('public-events')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'mv_public_events' }, function(payload) {
        if (payload.new) {
          state.publicEvents.unshift(payload.new);
          if (state.publicEvents.length > 100) state.publicEvents.pop();
          if (state.currentTab === 'ledger') renderPublicEvents();
        }
      }).subscribe();
    state.realtimeSubs.push(ch);
  } catch(e) { console.error('public events sub error:', e); }
}

/* =============================================================================
   CONFETTI BURST (on signup)
============================================================================= */
function burstConfetti() {
  var colors = ['#18F6C8', '#7C5CFF', '#FF3D9A', '#ffd166', '#ff6b6b'];
  for (var i = 0; i < 40; i++) {
    var el = document.createElement('div');
    el.style.cssText = 'position:fixed;z-index:99999;width:8px;height:8px;border-radius:2px;pointer-events:none;' +
      'background:' + colors[Math.floor(Math.random() * colors.length)] + ';' +
      'left:' + (40 + Math.random() * 20) + '%;top:40%;' +
      'animation:confettiPop ' + (0.6 + Math.random() * 0.8) + 's ease-out forwards;' +
      'transform:translate(' + (Math.random() * 200 - 100) + 'px,' + (Math.random() * 200 - 100) + 'px) rotate(' + Math.random() * 360 + 'deg);';
    document.body.appendChild(el);
    setTimeout(function() { el.remove(); }, 1600);
  }
}

/* =============================================================================
   BOOT SEQUENCE (NEVER HANG)
============================================================================= */
async function boot() {
  var dismiss = function() { var bs = getEl('boot-screen'); if (bs) bs.classList.add('done'); };
  var hard = setTimeout(dismiss, 900);

  // Always render landing immediately so UI never blocks
  renderLanding();

  try {
    if (typeof supabase === 'undefined' || !sb) {
      console.warn('Supabase SDK not available');
      showToast('Offline mode: Supabase unavailable', 'info');
      dismiss();
      return;
    }

    // Fast session check
    var session = null;
    try {
      var s = await withTimeout(sb.auth.getSession(), 700, 'session');
      session = (s && s.data && s.data.session) || null;
    } catch(e) { console.warn('Session check timeout:', e); }

    if (session && session.user) {
      state.user = session.user;
      state.accessToken = session.access_token || null;
      renderApp();
      renderMuxi();
  /* Random MUXI popup every 2-3 min */
  setInterval(function() {
    if (state.user && Math.random() < 0.4) {
      setMuxi(pickMuxiLine());
    }
  }, 150000);
      loadProfileSafe();
      loadJobsSafe();
      loadNotifications();
      startPresenceUpdates();
      subscribeToPublicEvents();
    }
  } catch(e) {
    console.error('Boot error:', e);
  } finally {
    clearTimeout(hard);
    dismiss();
  }

  // Auth state listener (non-blocking)
  try {
    sb.auth.onAuthStateChange(function(ev, sess) {
      if (sess && sess.user) {
        state.user = sess.user;
        state.accessToken = sess.access_token;
      } else {
        state.user = null;
        state.accessToken = null;
      }
    });
  } catch(e) { console.error('Auth listener error:', e); }
}

// Global error boundary
window.onerror = function(msg, src, line) {
  console.error('Global error:', msg, 'at', src, 'line', line);
  showToast('Something went wrong. MUXI is on it.', 'error');
};

// Start
boot();
</script>
</body>
</html>
